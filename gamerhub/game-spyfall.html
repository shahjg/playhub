<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spyfall Game - TheGamingHub</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* Animated Background Blobs */
        .blob {
            position: fixed;
            border-radius: 50%;
            filter: blur(60px);
            opacity: 0.5;
            z-index: 0;
            animation: float 20s infinite ease-in-out;
        }

        .blob-1 {
            width: 300px;
            height: 300px;
            background: rgba(240, 147, 251, 0.4);
            top: -100px;
            left: -100px;
        }

        .blob-2 {
            width: 400px;
            height: 400px;
            background: rgba(245, 87, 108, 0.4);
            bottom: -150px;
            right: -150px;
            animation-delay: 5s;
        }

        .blob-3 {
            width: 250px;
            height: 250px;
            background: rgba(255, 195, 113, 0.4);
            top: 50%;
            left: 50%;
            animation-delay: 10s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(50px, -50px) scale(1.1); }
            66% { transform: translate(-50px, 50px) scale(0.9); }
        }

        /* Header */
        header {
            background: rgba(255, 255, 255, 0.95);
            border-bottom: 4px solid #000;
            box-shadow: 0 4px 0 rgba(0, 0, 0, 0.2);
            padding: 1rem 2rem;
            position: relative;
            z-index: 10;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2rem;
            color: #000;
            text-decoration: none;
            letter-spacing: 2px;
        }

        .room-code-header {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem;
            color: #f5576c;
            letter-spacing: 2px;
        }

        .host-controls {
            display: flex;
            gap: 1rem;
        }

        .host-btn {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1rem;
            letter-spacing: 1px;
            background: #ffd700;
            color: #000;
            border: 3px solid #000;
            border-radius: 8px;
            padding: 0.5rem 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .host-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 0 rgba(0, 0, 0, 0.3);
        }

        /* Main Container - STACKED VERTICALLY */
        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding: 2rem;
            position: relative;
            z-index: 1;
            gap: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .game-card {
            background: rgba(255, 255, 255, 0.98);
            border: 4px solid #000;
            border-radius: 20px;
            box-shadow: 8px 8px 0 rgba(0, 0, 0, 0.3);
            padding: 2.5rem;
            width: 100%;
            min-height: 500px;
        }

        /* Location Reference - BELOW GAME CARD, NO SCROLL, 2 COLUMNS */
        .location-sidebar {
            background: rgba(255, 255, 255, 0.98);
            border: 4px solid #000;
            border-radius: 20px;
            box-shadow: 8px 8px 0 rgba(0, 0, 0, 0.3);
            padding: 2rem;
            width: 100%;
        }

        .location-sidebar h3 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.8rem;
            letter-spacing: 2px;
            color: #f5576c;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .location-list {
            display: grid !important;
            grid-template-columns: repeat(2, 1fr) !important;
            gap: 1rem;
            width: 100%;
        }

        .location-item {
            background: #f8f9fa;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            min-width: 0;
        }

        .location-item:hover {
            background: #e9ecef;
            border-color: #f5576c;
        }

        .location-item.crossed-off {
            background: #e0e0e0;
            opacity: 0.5;
            text-decoration: line-through;
        }

        .location-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #000;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .location-item.crossed-off .location-checkbox {
            background: #f5576c;
            color: white;
        }

        .location-name {
            font-weight: 600;
            font-size: 0.95rem;
        }

        /* Phase Indicator */
        .phase-indicator {
            text-align: center;
            margin-bottom: 2rem;
        }

        .phase-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2rem;
            color: #f5576c;
            letter-spacing: 2px;
            margin-bottom: 0.5rem;
        }

        .phase-subtitle {
            color: #666;
            font-size: 1.1rem;
        }

        /* Timer */
        .timer {
            background: #000;
            color: #fff;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.5rem;
            padding: 1rem 2rem;
            border-radius: 15px;
            text-align: center;
            margin: 0 auto 2rem;
            max-width: 200px;
            letter-spacing: 3px;
        }

        .timer.warning {
            background: #ff4757;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Role Reveal */
        .role-reveal {
            text-align: center;
            padding: 2rem;
        }

        .role-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: 4px solid #000;
            border-radius: 20px;
            padding: 3rem 2rem;
            margin: 2rem auto;
            max-width: 600px;
            box-shadow: 8px 8px 0 rgba(0, 0, 0, 0.3);
        }

        .role-card.spy {
            background: linear-gradient(135deg, #2d3436 0%, #000000 100%);
        }

        .role-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 3rem;
            letter-spacing: 3px;
            margin-bottom: 1rem;
        }

        .location-display {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 3.5rem;
            letter-spacing: 5px;
            text-shadow: 3px 3px 0 rgba(0, 0, 0, 0.3);
            margin: 2rem 0;
        }

        .specific-role {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 1rem;
            margin: 1.5rem 0;
        }

        .specific-role-label {
            font-size: 1rem;
            margin-bottom: 0.5rem;
            opacity: 0.9;
        }

        .specific-role-name {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2rem;
            letter-spacing: 2px;
        }

        .location-reminder {
            background: rgba(255, 255, 255, 0.95);
            border: 3px solid #f5576c;
            border-radius: 15px;
            padding: 1.5rem;
            margin: 1.5rem auto;
            max-width: 500px;
            text-align: center;
        }

        .location-display-small {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2rem;
            color: #f5576c;
            letter-spacing: 3px;
        }

        .spy-reminder {
            font-size: 1.3rem;
            color: #2d3436;
            font-weight: 700;
            padding: 1rem;
        }

        .role-instruction {
            font-size: 1.2rem;
            line-height: 1.6;
            margin-top: 1.5rem;
        }

        /* Question Phase */
        .question-phase {
            margin-top: 2rem;
        }

        .player-turn {
            background: #fff3cd;
            border: 3px solid #ffc107;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .turn-text {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .turn-player {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2rem;
            color: #f5576c;
            letter-spacing: 2px;
            margin: 0.5rem 0;
        }

        .turn-instruction {
            font-size: 0.95rem;
            color: #666;
            margin-top: 0.75rem;
            line-height: 1.5;
        }

        /* Players Grid */
        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
        }

        .player-card {
            background: #f8f9fa;
            border: 3px solid #000;
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
        }

        .player-name-card {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .player-status {
            font-size: 0.85rem;
            color: #666;
        }

        /* Voting Phase */
        .voting-section {
            margin-top: 2rem;
        }

        .voting-instructions {
            background: #fff3cd;
            border: 3px solid #ffc107;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 2rem;
            text-align: center;
            color: #856404;
            font-weight: 600;
        }

        .players-voting-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
        }

        .vote-player-card {
            background: #f8f9fa;
            border: 3px solid #000;
            border-radius: 10px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .vote-player-card:hover {
            transform: translateY(-5px);
            box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
            background: #fff;
        }

        .vote-player-card.selected {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            transform: translateY(-5px);
            box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
        }

        .vote-player-name {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem;
            letter-spacing: 1px;
        }

        .submit-vote-btn {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem;
            letter-spacing: 2px;
            background: #f5576c;
            color: white;
            border: 4px solid #000;
            border-radius: 10px;
            padding: 1rem 3rem;
            cursor: pointer;
            box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
            transition: all 0.2s;
            margin-top: 2rem;
            width: 100%;
        }

        .submit-vote-btn:hover:not(:disabled) {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 rgba(0, 0, 0, 0.3);
        }

        .submit-vote-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Results Phase */
        .results-section {
            text-align: center;
            padding: 2rem;
        }

        .result-banner {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: 4px solid #000;
            border-radius: 20px;
            padding: 3rem 2rem;
            margin: 2rem auto;
            max-width: 600px;
            box-shadow: 8px 8px 0 rgba(0, 0, 0, 0.3);
        }

        .result-banner.spy-wins {
            background: linear-gradient(135deg, #2d3436 0%, #000000 100%);
        }

        .result-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 3rem;
            letter-spacing: 3px;
            margin-bottom: 1rem;
        }

        .result-message {
            font-size: 1.3rem;
            line-height: 1.6;
            margin: 1rem 0;
        }

        .revealed-location {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 3.5rem;
            letter-spacing: 5px;
            text-shadow: 3px 3px 0 rgba(0, 0, 0, 0.3);
            margin: 2rem 0;
        }

        .spy-reveal {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 1.5rem;
            margin: 2rem 0;
        }

        .spy-name {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2rem;
            letter-spacing: 2px;
        }

        .play-again-btn {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem;
            letter-spacing: 2px;
            background: #ffd700;
            color: #000;
            border: 4px solid #000;
            border-radius: 10px;
            padding: 1rem 3rem;
            cursor: pointer;
            box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
            transition: all 0.2s;
            margin-top: 2rem;
        }

        .play-again-btn:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 rgba(0, 0, 0, 0.3);
        }

        /* Vote Results */
        .vote-results {
            margin: 2rem 0;
        }

        .vote-result-item {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 1rem;
            margin: 0.5rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .vote-result-name {
            font-weight: 700;
        }

        .vote-result-count {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem;
        }

        /* Loading */
        .loading {
            text-align: center;
            color: #666;
            font-size: 1.2rem;
            padding: 3rem;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #f5576c;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Footer */
        footer {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            text-align: center;
            padding: 1.5rem;
            position: relative;
            z-index: 10;
        }

        /* Progress Indicator */
        .progress-indicator {
            text-align: center;
            margin-bottom: 1.5rem;
            color: #666;
            font-size: 1rem;
        }

        .progress-bar {
            background: #f0f0f0;
            border: 2px solid #000;
            border-radius: 10px;
            height: 30px;
            margin: 1rem auto;
            max-width: 400px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            height: 100%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 0.9rem;
        }

        /* Hidden class */
        .hidden {
            display: none !important;
        }

        /* Custom Confirmation Modal */
        .custom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .custom-modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
        }

        .custom-modal-content {
            position: relative;
            background: white;
            border: 4px solid #000;
            border-radius: 15px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 8px 8px 0 rgba(0, 0, 0, 0.3);
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .custom-modal-header {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.8rem;
            margin-bottom: 1rem;
            letter-spacing: 2px;
            color: #f5576c;
        }

        .custom-modal-body {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 2rem;
            color: #333;
        }

        .custom-modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .custom-modal-btn {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.2rem;
            letter-spacing: 1px;
            padding: 0.75rem 2rem;
            border: 3px solid #000;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .custom-modal-btn.cancel {
            background: #f0f0f0;
            color: #333;
        }

        .custom-modal-btn.confirm {
            background: #f5576c;
            color: white;
        }

        .custom-modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 0 rgba(0, 0, 0, 0.3);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .game-card {
                padding: 1.5rem;
            }

            .role-title {
                font-size: 2rem;
            }

            .location-display {
                font-size: 2rem;
            }

            .players-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }

            .players-voting-grid {
                grid-template-columns: 1fr;
            }

            .custom-modal-actions {
                flex-direction: column;
            }

            .custom-modal-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>
    <div class="blob blob-3"></div>

    <!-- Header -->
    <header>
        <div class="header-content">
            <a href="index.html" class="logo">THEGAMINGHUB</a>
            <div class="room-code-header" id="roomCodeHeader">ROOM: ------</div>
            <div class="host-controls" id="hostControls" style="display: none;">
                <button class="host-btn" onclick="returnToLobbyAsHost()">‚Ü© Return All to Lobby</button>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Game Card -->
        <div class="game-card">
            <!-- Loading State -->
            <div id="loadingPhase" class="loading">
                <div class="spinner"></div>
                <p>Connecting to game...</p>
            </div>

            <!-- Role Reveal Phase -->
            <div id="roleRevealPhase" class="hidden">
                <div class="phase-indicator">
                    <div class="phase-title">ROLE REVEAL</div>
                    <div class="phase-subtitle">Remember your information!</div>
                </div>

                <div class="role-reveal">
                    <div id="roleCard" class="role-card">
                        <div class="role-title" id="roleTitle">YOUR ROLE</div>
                        <div id="locationSection" class="hidden">
                            <p>The location is:</p>
                            <div class="location-display" id="locationDisplay">LOCATION</div>
                            <div class="specific-role">
                                <div class="specific-role-label">Your specific role:</div>
                                <div class="specific-role-name" id="specificRole">Tourist</div>
                            </div>
                        </div>
                        <div id="spySection" class="hidden">
                            <p style="font-size: 1.5rem;">üïµÔ∏è</p>
                            <p>You don't know the location!</p>
                            <p style="margin-top: 1rem; font-size: 1.1rem;">Use the location list below to cross off possibilities</p>
                        </div>
                        <div class="role-instruction" id="roleInstruction"></div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 2rem;">
                    <p style="color: #666; font-size: 1.1rem;">Game starting soon...</p>
                </div>
            </div>

            <!-- Question Phase -->
            <div id="questionPhase" class="hidden">
                <div class="phase-indicator">
                    <div class="phase-title">QUESTION PHASE</div>
                    <div class="phase-subtitle">Ask questions to find the spy!</div>
                </div>

                <!-- Always show location during game -->
                <div id="gameLocationReminder" class="location-reminder">
                    <div id="gameLocationDisplay" class="location-display-small">LOCATION</div>
                    <div id="gameRoleDisplay" style="font-size: 1.1rem; color: #666; margin-top: 0.5rem;">Role: <strong id="gameSpecificRole">Tourist</strong></div>
                    <div id="gameSpyDisplay" class="spy-reminder hidden">
                        üïµÔ∏è You're the Spy - Blend in!
                    </div>
                </div>

                <div class="timer" id="questionTimer">480</div>

                <div class="player-turn" id="playerTurn">
                    <div class="turn-text">First Question:</div>
                    <div class="turn-player" id="currentTurnPlayer">PLAYER</div>
                    <div class="turn-instruction">
                        <strong id="currentTurnPlayer2">This player</strong> asks the first question to anyone. 
                        Whoever answers asks the next question to someone else.
                    </div>
                </div>

                <div class="players-grid" id="playersGrid"></div>
            </div>

            <!-- Voting Phase -->
            <div id="votingPhase" class="hidden">
                <div class="phase-indicator">
                    <div class="phase-title">VOTE FOR THE SPY</div>
                    <div class="phase-subtitle">Who do you think is the spy?</div>
                </div>

                <div class="timer" id="votingTimer">45</div>

                <div class="voting-section">
                    <div class="voting-instructions">
                        üïµÔ∏è Vote for who you think is the spy!
                    </div>

                    <div class="players-voting-grid" id="votingGrid"></div>

                    <button class="submit-vote-btn" id="submitVoteBtn" onclick="submitVote()" disabled>
                        CAST YOUR VOTE
                    </button>

                    <div class="progress-indicator" id="voteProgress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="voteProgressFill" style="width: 0%">0/0</div>
                        </div>
                        <p>Players who voted</p>
                    </div>
                </div>
            </div>

            <!-- Results Phase -->
            <div id="resultsPhase" class="hidden">
                <div class="results-section">
                    <div id="resultBanner" class="result-banner">
                        <div class="result-title" id="resultTitle">GAME OVER</div>
                        <div class="result-message" id="resultMessage"></div>
                        
                        <div class="spy-reveal">
                            <p style="font-size: 1.2rem; margin-bottom: 0.5rem;">The Spy was:</p>
                            <div class="spy-name" id="spyName">PLAYER</div>
                        </div>

                        <p style="font-size: 1.2rem; margin: 1rem 0;">The location was:</p>
                        <div class="revealed-location" id="revealedLocation">LOCATION</div>

                        <div class="vote-results" id="voteResults"></div>
                    </div>

                    <button class="play-again-btn" onclick="returnToLobby()">
                        RETURN TO LOBBY
                    </button>
                </div>
            </div>
        </div>

        <!-- Location Reference - BELOW GAME CARD -->
        <div class="location-sidebar" id="locationSidebar" style="display: none;">
            <h3>üìç LOCATIONS</h3>
            <p style="text-align: center; font-size: 0.9rem; color: #666; margin-bottom: 1.5rem;">
                Click to cross off locations
            </p>
            <div class="location-list" id="locationList"></div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div>¬© 2024 TheGamingHub. All games free forever.</div>
    </footer>

    <!-- Custom Confirmation Modal -->
    <div id="customModal" class="custom-modal">
        <div class="custom-modal-overlay" onclick="closeCustomModal()"></div>
        <div class="custom-modal-content">
            <div class="custom-modal-header" id="customModalTitle">Confirm</div>
            <div class="custom-modal-body" id="customModalMessage">
                Are you sure?
            </div>
            <div class="custom-modal-actions">
                <button class="custom-modal-btn cancel" id="customModalCancel" onclick="closeCustomModal()">Cancel</button>
                <button class="custom-modal-btn confirm" onclick="confirmCustomModal()">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Socket.io Client -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

    <script>
        const BACKEND_URL = 'https://web-production-519c7.up.railway.app';
        const socket = io(BACKEND_URL);

        // Get room code from URL
        const urlParams = new URLSearchParams(window.location.search);
        const roomCode = urlParams.get('room') || urlParams.get('code');
        const playerName = localStorage.getItem('playerName');

        // Game state
        let myRole = null;
        let myLocation = null;
        let mySpecificRole = null;
        let isSpy = false;
        let isHost = false;
        let selectedVotePlayerId = null;
        let totalPlayers = 0;
        let allPlayers = [];
        let currentTurnIndex = 0;
        let locationPack = 'classic';
        let crossedOffLocations = new Set();
        let modalCallback = null;
        
        // Timer tracking
        let activeTimers = {};
        
        // Location packs data
        const locationPacks = {
            classic: ['Airport', 'Bank', 'Beach', 'Casino', 'Cathedral', 'Circus', 'Hospital', 'Hotel', 'Military Base', 'Movie Studio', 'Ocean Liner', 'Passenger Train', 'Pirate Ship', 'Polar Station', 'Police Station', 'Restaurant', 'School', 'Space Station', 'Submarine', 'Supermarket'],
            modern: ['Coffee Shop', 'Gym', 'Shopping Mall', 'Tech Startup', 'Spa', 'Escape Room', 'Coworking Space', 'Food Truck Festival', 'Podcast Studio', 'Airbnb', 'Rock Climbing Gym', 'eSports Arena', 'Pet Store', 'Comic Con', 'Brewery', 'Dog Park'],
            adult: ['Strip Club', 'Las Vegas Casino', 'Hookah Lounge', 'Gentleman\'s Club', 'Wine Tasting', 'Nightclub', 'Bachelor Party', 'Bachelorette Party', 'Poker Tournament', 'Speakeasy Bar', 'Tattoo Parlor', 'Music Festival', 'Boxing Gym', 'Dive Bar', 'Swingers Club', 'Massage Parlor'],
            marvel: ['Avengers Tower', 'Asgard', 'Wakanda', 'X-Mansion', 'Stark Industries', 'S.H.I.E.L.D. Helicarrier', 'Sanctum Sanctorum', 'Knowhere', 'Hydra Base', 'Daily Bugle', 'Sokovia', 'Kamar-Taj', 'Ravager Ship', 'Titan', 'TVA'],
            dc: ['Batcave', 'Fortress of Solitude', 'Arkham Asylum', 'Metropolis', 'Gotham City', 'Justice League Watchtower', 'Themyscira', 'Atlantis', 'Central City', 'LexCorp Tower', 'Hall of Justice', 'Apokolips', 'Oa', 'Smallville', 'Wayne Manor'],
            movies: ['Hogwarts', 'The Shire', 'Mordor', 'Rivendell', 'Death Star', 'Jurassic Park', 'Titanic', 'The Matrix', 'Pandora', 'Gotham', 'Wonderland', 'Shawshank Prison', 'Fight Club Basement', 'Inception Dream', 'Wakanda'],
            medieval: ['Castle Throne Room', 'Medieval Tavern', 'Blacksmith Forge', 'Medieval Market', 'Monastery', 'Jousting Tournament', 'Castle Dungeon', 'Wizard\'s Tower', 'Knights\' Barracks', 'Royal Banquet', 'Medieval Village', 'Dragon\'s Lair', 'Plague Village', 'Siege Battlefield', 'Enchanted Forest'],
            websites: ['Reddit Office', 'YouTube Studio', 'Discord Server', 'TikTok House', 'Twitter HQ', 'Twitch Stream', 'Amazon Warehouse', 'LinkedIn Office', 'Instagram Influencer Shoot', 'Wikipedia Edit War', 'Steam Game Launch', 'Netflix Office', 'OnlyFans', 'eBay Warehouse', 'Spotify Office'],
            popculture: ['Squid Game', 'The Office', 'Friends Apartment', 'Stranger Things', 'Among Us Ship', 'Minecraft World', 'Fortnite Battle', 'Breaking Bad RV', 'Game of Thrones', 'SpongeBob\'s Bikini Bottom', 'Marvel Snap', 'Wednesday Addams School', 'Ted Lasso Locker Room', 'Last of Us', 'Yellowstone Ranch']
        };
        
        // Custom Modal System
        function showCustomModal(title, message, onConfirm, showCancel = true) {
            document.getElementById('customModalTitle').textContent = title;
            document.getElementById('customModalMessage').textContent = message;
            document.getElementById('customModal').style.display = 'flex';
            
            const cancelBtn = document.getElementById('customModalCancel');
            if (showCancel) {
                cancelBtn.style.display = 'inline-block';
            } else {
                cancelBtn.style.display = 'none';
            }
            
            modalCallback = onConfirm;
        }

        function closeCustomModal() {
            document.getElementById('customModal').style.display = 'none';
            modalCallback = null;
        }

        function confirmCustomModal() {
            if (modalCallback) {
                modalCallback();
            }
            closeCustomModal();
        }

        // Clear all active timers
        function clearAllTimers() {
            Object.keys(activeTimers).forEach(timerId => {
                clearInterval(activeTimers[timerId]);
                console.log('Cleared timer:', timerId);
            });
            activeTimers = {};
        }

        // Display room code
        document.getElementById('roomCodeHeader').textContent = `ROOM: ${roomCode}`;

        console.log('Spyfall game initialized:', { roomCode, playerName });

        // Socket connection
        socket.on('connect', () => {
            console.log('Connected to game server');
            
            console.log('Rejoining room for game...');
            socket.emit('rejoin-room', {
                roomCode: roomCode,
                playerName: playerName
            });
        });

        // Room joined successfully
        socket.on('room-joined', (data) => {
            console.log('Successfully rejoined room for game:', data);
            allPlayers = data.room.players;
            totalPlayers = allPlayers.length;
            
            // Check if we're the host
            const myPlayer = allPlayers.find(p => p.name === playerName);
            if (myPlayer) {
                isHost = myPlayer.isHost;
                if (isHost) {
                    document.getElementById('hostControls').style.display = 'flex';
                }
            }
            
            // Get location pack from game data
            if (data.room.gameData && data.room.gameData.locationPack) {
                locationPack = data.room.gameData.locationPack;
                console.log('Location pack:', locationPack);
            }
        });

        // Role assigned
        socket.on('role-assigned', (data) => {
            console.log('Role assigned:', data);
            
            myRole = data.role;
            isSpy = data.isSpy;
            myLocation = data.location;
            mySpecificRole = data.specificRole;

            // Show location sidebar
            showLocationSidebar();
            
            showRoleReveal();

            // Auto-start question phase after 5 seconds
            setTimeout(() => {
                // Server should send question-phase-start
            }, 5000);
        });

        // Question phase started
        socket.on('question-phase-start', (data) => {
            console.log('Question phase started:', data);
            showQuestionPhase(data.timeLimit || 480); // 8 minutes
        });

        // Turn changed
        socket.on('turn-changed', (data) => {
            console.log('Turn changed:', data);
            updateCurrentTurn(data.currentPlayer, data.turnIndex);
        });

        // Voting phase started
        socket.on('voting-phase-start', (data) => {
            console.log('Voting phase started:', data);
            allPlayers = data.players;
            totalPlayers = data.players.length;
            showVotingPhase();
        });

        // Vote counted
        socket.on('vote-counted', (data) => {
            console.log('Vote counted:', data);
            updateVoteProgress(data.totalVotes, data.totalPlayers);
        });

        // Game results
        socket.on('game-results', (data) => {
            console.log('Game results:', data);
            showResults(data);
        });

        // Host forced return to lobby
        socket.on('force-return-lobby', () => {
            console.log('Host forced return to lobby');
            window.location.href = `waiting-room.html?room=${roomCode}`;
        });

        // Error handling
        socket.on('error', (data) => {
            console.error('Socket error:', data);
            showCustomModal('Error', data.message, () => {}, false);
        });

        // Show location sidebar with crossoff
        function showLocationSidebar() {
            const sidebar = document.getElementById('locationSidebar');
            const locationList = document.getElementById('locationList');
            
            sidebar.style.display = 'block';
            locationList.innerHTML = '';
            
            // Get locations for this pack
            let locations = [];
            if (locationPack === 'random') {
                // Flatten all packs
                locations = Object.values(locationPacks).flat();
                // Remove duplicates
                locations = [...new Set(locations)];
            } else if (locationPacks[locationPack]) {
                locations = locationPacks[locationPack];
            } else {
                locations = locationPacks.classic;
            }
            
            // Sort alphabetically
            locations.sort();
            
            // Create location items
            locations.forEach(location => {
                const item = document.createElement('div');
                item.className = 'location-item';
                item.onclick = () => toggleLocation(location, item);
                
                const checkbox = document.createElement('div');
                checkbox.className = 'location-checkbox';
                checkbox.textContent = '';
                
                const name = document.createElement('div');
                name.className = 'location-name';
                name.textContent = location;
                
                item.appendChild(checkbox);
                item.appendChild(name);
                locationList.appendChild(item);
            });
        }

        // Toggle location crossoff
        function toggleLocation(location, itemElement) {
            if (crossedOffLocations.has(location)) {
                crossedOffLocations.delete(location);
                itemElement.classList.remove('crossed-off');
                itemElement.querySelector('.location-checkbox').textContent = '';
            } else {
                crossedOffLocations.add(location);
                itemElement.classList.add('crossed-off');
                itemElement.querySelector('.location-checkbox').textContent = '‚úì';
            }
        }

        // Show role reveal phase
        function showRoleReveal() {
            hideAllPhases();
            document.getElementById('roleRevealPhase').classList.remove('hidden');

            const roleCard = document.getElementById('roleCard');
            const roleTitle = document.getElementById('roleTitle');
            const locationSection = document.getElementById('locationSection');
            const spySection = document.getElementById('spySection');
            const roleInstruction = document.getElementById('roleInstruction');

            if (isSpy) {
                roleCard.classList.add('spy');
                roleTitle.textContent = 'üïµÔ∏è THE SPY';
                spySection.classList.remove('hidden');
                locationSection.classList.add('hidden');
                roleInstruction.textContent = 'Ask clever questions to figure out the location without revealing you don\'t know it!';
            } else {
                roleCard.classList.remove('spy');
                roleTitle.textContent = 'üë• PLAYER';
                locationSection.classList.remove('hidden');
                spySection.classList.add('hidden');
                document.getElementById('locationDisplay').textContent = myLocation;
                document.getElementById('specificRole').textContent = mySpecificRole;
                roleInstruction.textContent = 'Ask questions to find the spy, but don\'t make the location too obvious!';
            }
        }

        // Show question phase
        function showQuestionPhase(timeLimit) {
            console.log('Starting question phase');
            
            clearAllTimers();
            
            hideAllPhases();
            document.getElementById('questionPhase').classList.remove('hidden');
            
            // Show location/spy reminder
            if (isSpy) {
                document.getElementById('gameLocationDisplay').style.display = 'none';
                document.getElementById('gameRoleDisplay').style.display = 'none';
                document.getElementById('gameSpyDisplay').classList.remove('hidden');
            } else {
                document.getElementById('gameLocationDisplay').textContent = myLocation;
                document.getElementById('gameSpecificRole').textContent = mySpecificRole;
                document.getElementById('gameLocationDisplay').style.display = 'block';
                document.getElementById('gameRoleDisplay').style.display = 'block';
                document.getElementById('gameSpyDisplay').classList.add('hidden');
            }
            
            // Build players grid
            buildPlayersGrid();
            
            // Start timer
            startTimer('questionTimer', timeLimit);
            
            // Initialize first turn
            updateCurrentTurn(allPlayers[0].name, 0);
        }

        // Build players grid
        function buildPlayersGrid() {
            const playersGrid = document.getElementById('playersGrid');
            playersGrid.innerHTML = '';

            allPlayers.forEach((player, index) => {
                const card = document.createElement('div');
                card.className = 'player-card';
                card.id = `player-card-${index}`;
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'player-name-card';
                nameDiv.textContent = player.name;
                
                const statusDiv = document.createElement('div');
                statusDiv.className = 'player-status';
                statusDiv.textContent = player.isHost ? 'üëë Host' : 'Player';
                
                card.appendChild(nameDiv);
                card.appendChild(statusDiv);
                playersGrid.appendChild(card);
            });
        }

        // Update current turn
        function updateCurrentTurn(playerName, turnIndex) {
            currentTurnIndex = turnIndex;
            
            // Update turn display
            document.getElementById('currentTurnPlayer').textContent = playerName;
            document.getElementById('currentTurnPlayer2').textContent = playerName;
        }

        // Show voting phase
        function showVotingPhase() {
            console.log('Starting voting phase');
            
            clearAllTimers();
            
            hideAllPhases();
            document.getElementById('votingPhase').classList.remove('hidden');
            
            selectedVotePlayerId = null;
            
            // Reset submit button
            const submitBtn = document.getElementById('submitVoteBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'CAST YOUR VOTE';
            
            // Build voting grid
            buildVotingGrid();
            
            // Start timer
            startTimer('votingTimer', 45);
        }

        // Build voting grid
        function buildVotingGrid() {
            const votingGrid = document.getElementById('votingGrid');
            votingGrid.innerHTML = '';

            allPlayers.forEach(player => {
                const card = document.createElement('div');
                card.className = 'vote-player-card';
                card.onclick = () => selectVotePlayer(player.id, card);
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'vote-player-name';
                nameDiv.textContent = player.name;
                
                card.appendChild(nameDiv);
                votingGrid.appendChild(card);
            });
        }

        // Select player to vote for
        function selectVotePlayer(playerId, cardElement) {
            // Remove selection from all cards
            document.querySelectorAll('.vote-player-card').forEach(card => {
                card.classList.remove('selected');
            });

            // Select this card
            cardElement.classList.add('selected');
            selectedVotePlayerId = playerId;
            document.getElementById('submitVoteBtn').disabled = false;
        }

        // Submit vote
        function submitVote() {
            if (!selectedVotePlayerId) {
                showCustomModal('Select Player', 'Please select a player to vote for!', () => {}, false);
                return;
            }

            console.log('Submitting vote for:', selectedVotePlayerId);
            
            socket.emit('submit-vote', {
                roomCode: roomCode,
                votedPlayerId: selectedVotePlayerId
            });

            // Disable voting
            document.getElementById('submitVoteBtn').disabled = true;
            document.getElementById('submitVoteBtn').textContent = 'VOTE SUBMITTED ‚úì';
            document.querySelectorAll('.vote-player-card').forEach(card => {
                card.style.pointerEvents = 'none';
            });
        }

        // Update vote progress
        function updateVoteProgress(current, total) {
            const progressFill = document.getElementById('voteProgressFill');
            const percentage = (current / total) * 100;
            progressFill.style.width = percentage + '%';
            progressFill.textContent = `${current}/${total}`;
        }

        // Show results
        function showResults(data) {
            hideAllPhases();
            document.getElementById('resultsPhase').classList.remove('hidden');

            const resultBanner = document.getElementById('resultBanner');
            const resultTitle = document.getElementById('resultTitle');
            const resultMessage = document.getElementById('resultMessage');
            const spyName = document.getElementById('spyName');
            const revealedLocation = document.getElementById('revealedLocation');
            const voteResults = document.getElementById('voteResults');

            // Set spy name and location
            spyName.textContent = data.spy.name.toUpperCase();
            revealedLocation.textContent = data.location.toUpperCase();

            // Set result based on outcome
            if (data.spyCaught) {
                resultBanner.classList.remove('spy-wins');
                resultTitle.textContent = 'üéâ PLAYERS WIN!';
                resultMessage.textContent = `${data.votedOut.name} was voted out and they were the spy!`;
            } else {
                resultBanner.classList.add('spy-wins');
                resultTitle.textContent = 'üïµÔ∏è SPY WINS!';
                resultMessage.textContent = `${data.votedOut.name} was voted out, but they were innocent! The spy escaped.`;
            }

            // Show vote counts
            voteResults.innerHTML = '<p style="margin-bottom: 1rem; font-size: 1.2rem;">Vote Results:</p>';
            
            const sortedVotes = Object.entries(data.voteCounts).sort((a, b) => b[1] - a[1]);
            
            sortedVotes.forEach(([playerId, votes]) => {
                const player = allPlayers.find(p => p.id === playerId);
                if (player) {
                    const voteItem = document.createElement('div');
                    voteItem.className = 'vote-result-item';
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'vote-result-name';
                    nameSpan.textContent = player.name;
                    
                    const countSpan = document.createElement('span');
                    countSpan.className = 'vote-result-count';
                    countSpan.textContent = `${votes} vote${votes !== 1 ? 's' : ''}`;
                    
                    voteItem.appendChild(nameSpan);
                    voteItem.appendChild(countSpan);
                    voteResults.appendChild(voteItem);
                }
            });
        }

        // Timer function
        function startTimer(elementId, seconds) {
            console.log(`startTimer called for ${elementId} with ${seconds} seconds`);
            
            const timerElement = document.getElementById(elementId);
            if (!timerElement) {
                console.error('Timer element not found:', elementId);
                return;
            }
            
            if (activeTimers[elementId]) {
                console.log(`Clearing existing timer for ${elementId}`);
                clearInterval(activeTimers[elementId]);
                delete activeTimers[elementId];
            }
            
            timerElement.textContent = formatTime(seconds);
            timerElement.classList.remove('warning');
            
            let timeLeft = seconds;

            const interval = setInterval(() => {
                timeLeft--;
                timerElement.textContent = formatTime(timeLeft);

                if (timeLeft <= 60) {
                    timerElement.classList.add('warning');
                }

                if (timeLeft <= 0) {
                    console.log(`Timer ${elementId} reached 0`);
                    clearInterval(interval);
                    delete activeTimers[elementId];
                }
            }, 1000);
            
            activeTimers[elementId] = interval;
            console.log(`Timer ${elementId} started`);
        }

        // Format time as MM:SS
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Hide all phases
        function hideAllPhases() {
            clearAllTimers();
            
            document.getElementById('loadingPhase').classList.add('hidden');
            document.getElementById('roleRevealPhase').classList.add('hidden');
            document.getElementById('questionPhase').classList.add('hidden');
            document.getElementById('votingPhase').classList.add('hidden');
            document.getElementById('resultsPhase').classList.add('hidden');
        }

        // Return to lobby (regular player) - WITH CUSTOM MODAL
        function returnToLobby() {
            showCustomModal(
                'Return to Lobby',
                'Return to the waiting room? The game will end for you.',
                () => {
                    window.location.href = `waiting-room.html?room=${roomCode}`;
                }
            );
        }

        // Return to lobby as host (forces all players back) - WITH CUSTOM MODAL
        function returnToLobbyAsHost() {
            showCustomModal(
                'End Game',
                'Return all players to the lobby? The game will end.',
                () => {
                    socket.emit('host-return-lobby', {
                        roomCode: roomCode
                    });
                    
                    // Redirect self immediately
                    window.location.href = `waiting-room.html?room=${roomCode}`;
                }
            );
        }

        // Handle browser close
        window.addEventListener('beforeunload', () => {
            socket.disconnect();
        });

        // Debug: Log all socket events
        socket.onAny((eventName, ...args) => {
            console.log('Socket event:', eventName, args);
        });
    </script>
</body>
</html>
