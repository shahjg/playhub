<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>Dash Run ‚Äì Endless Runner Game | TheGaming.co</title>
    <meta name="description" content="Jump and slide to survive as long as you can!">
    <meta name="theme-color" content="#0a0a0f">
    <link rel="stylesheet" href="/header.css">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{
            --accent:#f97316;--accent-dark:#ea580c;--accent-light:#ffedd5;
            --gold:#ffd700;--text-dark:#1a1a2e;--text-muted:#6b7280;
        }
        html,body{overscroll-behavior:none;touch-action:manipulation}
        body{font-family:'Inter',sans-serif;background:linear-gradient(135deg,#fef3c7 0%,#fed7aa 50%,#fef3c7 100%);color:var(--text-dark);min-height:100vh;min-height:100dvh;display:flex;flex-direction:column;overflow-x:hidden}
        h1,h2,h3,h4{font-family:'Bebas Neue',sans-serif;letter-spacing:1px}
        a{color:inherit;text-decoration:none}

        main{flex:1;display:flex;flex-direction:column;padding-top:60px}
        .game-hero{background:radial-gradient(circle at 10% 0%,#ea580c 0%,#f97316 50%,#fb923c 100%);padding:35px 20px;text-align:center;position:relative;overflow:hidden}
        .game-hero::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at 30% 20%,rgba(255,255,255,0.2) 0%,transparent 55%)}
        .game-hero-content{position:relative;z-index:1;max-width:600px;margin:0 auto}
        .game-icon{width:60px;height:60px;margin:0 auto 12px;animation:iconFloat 3s ease-in-out infinite}
        @keyframes iconFloat{0%,100%{transform:translateY(0) rotate(-2deg)}50%{transform:translateY(-8px) rotate(2deg)}}
        .game-hero-title{font-size:clamp(2.2rem,8vw,3.5rem);line-height:0.95;margin-bottom:6px;background:linear-gradient(135deg,#fff,var(--accent-light),#fff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:3px}
        .game-hero-desc{font-size:0.85rem;color:rgba(255,255,255,0.8)}

        .game-wrapper{flex:1;display:flex;flex-direction:column;align-items:center;padding:25px 15px 40px}
        .game-container{width:100%;max-width:420px;display:flex;flex-direction:column;gap:16px}

        .stats-bar{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
        .stat-card{background:#fff;border:2px solid rgba(249,115,22,0.2);border-radius:14px;padding:10px 8px;text-align:center;box-shadow:0 2px 12px rgba(249,115,22,0.08)}
        .stat-label{font-size:0.6rem;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:2px}
        .stat-value{font-family:'Bebas Neue',sans-serif;font-size:1.4rem;letter-spacing:1px;color:var(--accent)}
        .stat-value.best{color:var(--gold)}

        .game-board{background:#fff;border-radius:20px;border:3px solid rgba(249,115,22,0.3);padding:12px;box-shadow:0 8px 30px rgba(249,115,22,0.12);display:flex;flex-direction:column;align-items:center}
        
        .canvas-wrapper{position:relative;border-radius:12px;overflow:hidden;touch-action:none;-webkit-touch-callout:none;-webkit-user-select:none;user-select:none;width:100%;max-width:350px}
        #canvas{display:block;border-radius:10px;width:100%;height:auto}
        
        .game-overlay{position:absolute;inset:0;background:rgba(0,0,0,0.88);display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:20px;border-radius:12px;backdrop-filter:blur(4px)}
        .game-overlay.hidden{display:none}
        .overlay-title{font-family:'Bebas Neue',sans-serif;font-size:2.2rem;letter-spacing:3px;color:#fff;margin-bottom:6px}
        .overlay-title.gameover{color:#ef4444}
        .overlay-title.start{background:linear-gradient(135deg,#fff,var(--accent-light),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .overlay-score{font-family:'Bebas Neue',sans-serif;font-size:3.5rem;color:var(--gold);margin:12px 0}
        .overlay-text{color:rgba(255,255,255,0.6);font-size:0.8rem;margin-bottom:16px}
        .new-best{color:var(--gold);font-weight:700;margin-bottom:10px}
        .btn{padding:14px 28px;border-radius:50px;border:none;font-weight:700;font-size:0.95rem;cursor:pointer;transition:all 0.3s;text-transform:uppercase;letter-spacing:1px;font-family:'Inter',sans-serif}
        .btn-primary{background:linear-gradient(135deg,var(--accent),var(--accent-dark));color:#fff;box-shadow:0 6px 20px rgba(249,115,22,0.3)}

        .tap-hint{margin-top:12px;font-size:0.75rem;color:var(--text-muted);text-align:center}

        .get-ready{position:absolute;inset:0;display:none;align-items:center;justify-content:center;flex-direction:column;background:rgba(0,0,0,0.3);border-radius:12px;backdrop-filter:blur(2px)}
        .get-ready.show{display:flex}
        .get-ready-text{font-family:'Bebas Neue',sans-serif;font-size:2.5rem;color:#fff;text-shadow:0 4px 20px rgba(0,0,0,0.5);animation:pulse 0.5s ease-in-out infinite alternate}
        .get-ready-hint{font-size:0.85rem;color:rgba(255,255,255,0.8);margin-top:8px}
        @keyframes pulse{0%{transform:scale(1)}100%{transform:scale(1.05)}}

        .leaderboard-section{background:#fff;border:2px solid rgba(249,115,22,0.2);border-radius:18px;padding:18px;box-shadow:0 8px 30px rgba(249,115,22,0.12)}
        .lb-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;padding-bottom:10px;border-bottom:2px solid rgba(249,115,22,0.15);flex-wrap:wrap;gap:10px}
        .lb-title{font-family:'Bebas Neue',sans-serif;font-size:1.3rem;letter-spacing:2px}
        .lb-tabs{display:flex;gap:5px;background:rgba(249,115,22,0.08);padding:3px;border-radius:10px}
        .lb-tab{padding:6px 12px;border-radius:7px;font-size:0.7rem;font-weight:600;text-transform:uppercase;cursor:pointer;color:var(--text-muted);background:transparent;border:none}
        .lb-tab:hover{color:var(--accent)}
        .lb-tab.active{background:#fff;color:var(--accent);box-shadow:0 2px 8px rgba(249,115,22,0.15)}
        .lb-list{display:flex;flex-direction:column;gap:5px}
        .lb-row{display:flex;align-items:center;gap:10px;padding:8px 12px;background:rgba(249,115,22,0.05);border-radius:10px;border:1px solid transparent}
        .lb-row:hover{background:rgba(249,115,22,0.1)}
        .lb-row.top-1{background:linear-gradient(90deg,rgba(255,215,0,0.15),rgba(255,215,0,0.05));border:2px solid rgba(255,215,0,0.4)}
        .lb-row.top-2{background:linear-gradient(90deg,rgba(192,192,192,0.12),rgba(192,192,192,0.04));border:2px solid rgba(192,192,192,0.3)}
        .lb-row.top-3{background:linear-gradient(90deg,rgba(205,127,50,0.12),rgba(205,127,50,0.04));border:2px solid rgba(205,127,50,0.3)}
        .lb-row.premium-row{background:linear-gradient(90deg,rgba(251,191,36,0.12),rgba(251,191,36,0.03))!important;border:1px solid rgba(251,191,36,0.3)!important;box-shadow:0 0 15px rgba(251,191,36,0.1)}
        .lb-rank{font-family:'Bebas Neue',sans-serif;font-size:1.1rem;width:28px;color:var(--text-muted)}
        .lb-row.top-1 .lb-rank{color:#ffd700}
        .lb-row.top-2 .lb-rank{color:#c0c0c0}
        .lb-row.top-3 .lb-rank{color:#cd7f32}
        .lb-avatar{width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#ec4899,#8b5cf6);display:flex;align-items:center;justify-content:center;font-size:0.7rem;font-weight:700;color:#fff}
        .lb-avatar.premium{background:linear-gradient(135deg,#fbbf24,#f59e0b)!important;box-shadow:0 0 20px rgba(251,191,36,0.5),0 0 40px rgba(251,191,36,0.2)!important}
        .lb-name{flex:1;font-weight:600;font-size:0.8rem}
        .lb-name.premium{background:linear-gradient(90deg,var(--gold),#f59e0b,#fcd34d,var(--gold))!important;background-size:200% auto!important;-webkit-background-clip:text!important;-webkit-text-fill-color:transparent!important;animation:goldShimmer 3s linear infinite!important;font-weight:700!important}
        @keyframes goldShimmer{0%{background-position:0% center}100%{background-position:200% center}}
        .lb-score{font-family:'Bebas Neue',sans-serif;font-size:1.1rem;color:var(--accent)}
        .lb-empty{text-align:center;padding:20px;color:var(--text-muted);font-size:0.8rem}
    </style>
</head>
<body>
    <div id="site-header"></div>

    <main>
        <section class="game-hero">
            <div class="game-hero-content">
                <svg class="game-icon" viewBox="0 0 100 100" fill="none">
                    <circle cx="50" cy="35" r="20" fill="#fbbf24"/>
                    <rect x="40" y="55" width="20" height="30" rx="5" fill="#f97316"/>
                    <rect x="35" y="60" width="10" height="20" rx="3" fill="#f97316"/>
                    <rect x="55" y="60" width="10" height="20" rx="3" fill="#f97316"/>
                    <circle cx="45" cy="32" r="3" fill="#1e293b"/>
                    <circle cx="55" cy="32" r="3" fill="#1e293b"/>
                    <path d="M45 40 Q50 45 55 40" stroke="#1e293b" stroke-width="2" fill="none"/>
                </svg>
                <h1 class="game-hero-title">DASH RUN</h1>
                <p class="game-hero-desc">Jump and slide to survive!</p>
            </div>
        </section>

        <div class="game-wrapper">
            <div class="game-container">
                <div class="stats-bar">
                    <div class="stat-card">
                        <div class="stat-label">Score</div>
                        <div class="stat-value" id="score-display">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Best</div>
                        <div class="stat-value best" id="best-display">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Games</div>
                        <div class="stat-value" id="games-display">0</div>
                    </div>
                </div>

                <div class="game-board">
                    <div class="canvas-wrapper" id="canvas-wrapper">
                        <canvas id="canvas" width="350" height="280"></canvas>
                        <div class="game-overlay" id="overlay">
                            <div class="overlay-title start" id="overlay-title">DASH RUN</div>
                            <div class="overlay-score hidden" id="overlay-score">0</div>
                            <div class="new-best hidden" id="new-best">üèÜ NEW BEST!</div>
                            <p class="overlay-text" id="overlay-text">Tap to jump, swipe down to slide</p>
                            <button class="btn btn-primary" id="start-btn">START</button>
                        </div>
                        <div class="get-ready" id="get-ready">
                            <div class="get-ready-text">GET READY!</div>
                            <div class="get-ready-hint">Tap = Jump | Swipe Down = Slide</div>
                        </div>
                    </div>
                    <p class="tap-hint">Space/Up = Jump | Down = Slide</p>
                </div>

                <div class="leaderboard-section">
                    <div class="lb-header">
                        <h2 class="lb-title">üèÜ Leaderboard</h2>
                        <div class="lb-tabs">
                            <button class="lb-tab active" data-tab="global">Global</button>
                            <button class="lb-tab" data-tab="today">Today</button>
                            <button class="lb-tab" data-tab="friends">Friends</button>
                        </div>
                    </div>
                    <div class="lb-list" id="lb-list"><div class="lb-empty">Loading...</div></div>
                </div>
            </div>
        </div>
    </main>

<script>
const SUPABASE_URL='https://tvvivtmzofsyehatzlvl.supabase.co';
const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR2dml2dG16b2ZzeWVoYXR6bHZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4OTExODYsImV4cCI6MjA4MDQ2NzE4Nn0.Qy8kHMO0Nb4yJ0ZHjby7RuQtzwWB8rUcZvkdnbL1b3M';
const supabaseClient=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
const W=canvas.width;
const H=canvas.height;

// Game constants
const GROUND_Y = H - 50;
const GRAVITY = 0.5;
const JUMP_FORCE = -10;
const GAME_SPEED = 5;
const OBSTACLE_GAP = 200;
const COIN_VALUE = 100;

// Game state
let gameState = 'idle';
let score = 0;
let bestScore = parseInt(localStorage.getItem('dash_run_best') || '0');
let gamesPlayed = parseInt(localStorage.getItem('dash_run_games') || '0');
let currentUserId = null;
let friendIds = [];
let currentTab = 'global';

// Player constants & state
const PLAYER_WIDTH = 35;
const PLAYER_HEIGHT = 50;
const PLAYER_X = 60;
let playerY = GROUND_Y - PLAYER_HEIGHT;
let playerVelY = 0;
let isJumping = false;
let canDoubleJump = false;
let isSliding = false;
let slideTimer = 0;

// Objects
let obstacles = [];
let coins = [];
let frameCount = 0;
let bgOffset = 0;

// UI elements
const overlay = document.getElementById('overlay');
const overlayTitle = document.getElementById('overlay-title');
const overlayScore = document.getElementById('overlay-score');
const overlayText = document.getElementById('overlay-text');
const newBestEl = document.getElementById('new-best');
const startBtn = document.getElementById('start-btn');
const getReadyEl = document.getElementById('get-ready');

function updateDisplays() {
    document.getElementById('score-display').textContent = score;
    document.getElementById('best-display').textContent = bestScore;
    document.getElementById('games-display').textContent = gamesPlayed;
}
updateDisplays();

function drawBackground() {
    // Sky gradient
    const skyGrad = ctx.createLinearGradient(0, 0, 0, H - 50);
    skyGrad.addColorStop(0, '#87ceeb');
    skyGrad.addColorStop(1, '#b0e0e6');
    ctx.fillStyle = skyGrad;
    ctx.fillRect(0, 0, W, H);
    
    // Sun
    ctx.fillStyle = '#fef08a';
    ctx.beginPath();
    ctx.arc(W - 50, 50, 30, 0, Math.PI * 2);
    ctx.fill();
    
    // Clouds (parallax)
    ctx.fillStyle = 'rgba(255,255,255,0.8)';
    const cloudOffset = (bgOffset * 0.3) % (W + 100);
    for (let i = 0; i < 3; i++) {
        const cx = ((i * 150 + 50) - cloudOffset + W + 100) % (W + 100) - 50;
        const cy = 40 + i * 25;
        ctx.beginPath();
        ctx.arc(cx, cy, 20, 0, Math.PI * 2);
        ctx.arc(cx + 25, cy - 5, 25, 0, Math.PI * 2);
        ctx.arc(cx + 50, cy, 18, 0, Math.PI * 2);
        ctx.fill();
    }
    
    // Ground
    ctx.fillStyle = '#86efac';
    ctx.fillRect(0, GROUND_Y, W, 50);
    ctx.fillStyle = '#22c55e';
    ctx.fillRect(0, GROUND_Y, W, 5);
    
    // Grass
    ctx.fillStyle = '#16a34a';
    for (let i = 0; i < W; i += 8) {
        ctx.beginPath();
        ctx.moveTo(i, GROUND_Y);
        ctx.lineTo(i + 4, GROUND_Y - 6);
        ctx.lineTo(i + 8, GROUND_Y);
        ctx.fill();
    }
}

function drawPlayer() {
    ctx.save();
    
    const drawH = isSliding ? PLAYER_HEIGHT * 0.5 : PLAYER_HEIGHT;
    const drawY = isSliding ? GROUND_Y - drawH : playerY;
    
    // Shadow
    ctx.fillStyle = 'rgba(0,0,0,0.2)';
    ctx.beginPath();
    ctx.ellipse(PLAYER_X + PLAYER_WIDTH/2, GROUND_Y + 5, PLAYER_WIDTH/2, 8, 0, 0, Math.PI * 2);
    ctx.fill();
    
    // Body
    ctx.fillStyle = '#f97316';
    ctx.beginPath();
    ctx.roundRect(PLAYER_X, drawY, PLAYER_WIDTH, drawH, 8);
    ctx.fill();
    
    // Head
    const headY = drawY - (isSliding ? 5 : 15);
    ctx.fillStyle = '#fbbf24';
    ctx.beginPath();
    ctx.arc(PLAYER_X + PLAYER_WIDTH/2, headY, isSliding ? 12 : 15, 0, Math.PI * 2);
    ctx.fill();
    
    // Eyes
    ctx.fillStyle = '#1e293b';
    ctx.beginPath();
    ctx.arc(PLAYER_X + PLAYER_WIDTH/2 - 5, headY - 2, 3, 0, Math.PI * 2);
    ctx.arc(PLAYER_X + PLAYER_WIDTH/2 + 5, headY - 2, 3, 0, Math.PI * 2);
    ctx.fill();
    
    // Smile
    ctx.strokeStyle = '#1e293b';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.arc(PLAYER_X + PLAYER_WIDTH/2, headY, 6, 0.2, Math.PI - 0.2);
    ctx.stroke();
    
    ctx.restore();
}

function drawObstacle(obs) {
    if (obs.type === 'ground') {
        // Crate obstacle
        ctx.fillStyle = '#92400e';
        ctx.beginPath();
        ctx.roundRect(obs.x, GROUND_Y - obs.height, obs.width, obs.height, 5);
        ctx.fill();
        
        // Crate details
        ctx.strokeStyle = '#78350f';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.moveTo(obs.x, GROUND_Y - obs.height);
        ctx.lineTo(obs.x + obs.width, GROUND_Y);
        ctx.moveTo(obs.x + obs.width, GROUND_Y - obs.height);
        ctx.lineTo(obs.x, GROUND_Y);
        ctx.stroke();
    } else if (obs.type === 'high') {
        // High barrier (must slide under)
        ctx.fillStyle = '#ef4444';
        ctx.beginPath();
        ctx.roundRect(obs.x, GROUND_Y - obs.height - 30, obs.width, 25, 5);
        ctx.fill();
        
        // Spikes
        ctx.fillStyle = '#fbbf24';
        for (let i = 0; i < obs.width; i += 15) {
            ctx.fillRect(obs.x + i, GROUND_Y - obs.height - 25, 7, 15);
        }
    }
}

function drawCoin(coin) {
    const x = coin.x + 15;
    const y = GROUND_Y - 60;
    
    // Glow
    ctx.fillStyle = 'rgba(34, 197, 94, 0.3)';
    ctx.beginPath();
    ctx.arc(x, y, 22, 0, Math.PI * 2);
    ctx.fill();
    
    // Coin
    ctx.fillStyle = '#22c55e';
    ctx.beginPath();
    ctx.arc(x, y, 15, 0, Math.PI * 2);
    ctx.fill();
    
    // Inner
    ctx.fillStyle = '#4ade80';
    ctx.beginPath();
    ctx.arc(x, y, 10, 0, Math.PI * 2);
    ctx.fill();
    
    // Text
    ctx.fillStyle = '#fff';
    ctx.font = 'bold 9px Inter';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('+' + COIN_VALUE, x, y);
}

function drawScore() {
    if (gameState !== 'playing') return;
    ctx.fillStyle = '#1e293b';
    ctx.font = "bold 32px 'Bebas Neue', sans-serif";
    ctx.textAlign = 'left';
    ctx.fillText(score, 15, 35);
}

function jump() {
    if (isSliding) return;
    
    if (!isJumping) {
        playerVelY = JUMP_FORCE;
        isJumping = true;
        canDoubleJump = true;
    } else if (canDoubleJump) {
        playerVelY = JUMP_FORCE * 0.85;
        canDoubleJump = false;
    }
}

function slide() {
    if (!isJumping && !isSliding) {
        isSliding = true;
        slideTimer = 25;
    }
}

function spawnObstacle() {
    const type = Math.random() < 0.7 ? 'ground' : 'high';
    
    obstacles.push({
        x: W + 20,
        width: type === 'ground' ? 40 : 60,
        height: type === 'ground' ? 40 : 50,
        type
    });
}

function spawnCoin() {
    const lastObs = obstacles[obstacles.length - 1];
    if (lastObs && lastObs.x > W - 80) return;
    
    coins.push({ x: W + 50 });
}

function update() {
    if (gameState !== 'playing') return;
    
    frameCount++;
    bgOffset += GAME_SPEED;
    
    // Score increases over time
    if (frameCount % 6 === 0) {
        score++;
        document.getElementById('score-display').textContent = score;
    }
    
    // Sliding logic
    if (isSliding) {
        slideTimer--;
        if (slideTimer <= 0) {
            isSliding = false;
        }
    }
    
    // Physics (only when not sliding)
    if (!isSliding) {
        playerVelY += GRAVITY;
        playerY += playerVelY;
        
        if (playerY >= GROUND_Y - PLAYER_HEIGHT) {
            playerY = GROUND_Y - PLAYER_HEIGHT;
            playerVelY = 0;
            isJumping = false;
            canDoubleJump = false;
        }
    }
    
    // Spawn obstacles
    const rightmostObs = obstacles.length > 0 ? Math.max(...obstacles.map(o => o.x)) : -OBSTACLE_GAP;
    if (rightmostObs < W - OBSTACLE_GAP) {
        spawnObstacle();
    }
    
    // Spawn coins occasionally
    if (frameCount % 100 === 0 && Math.random() < 0.5) {
        spawnCoin();
    }
    
    // Move obstacles
    for (let i = obstacles.length - 1; i >= 0; i--) {
        obstacles[i].x -= GAME_SPEED;
        if (obstacles[i].x + obstacles[i].width < 0) {
            obstacles.splice(i, 1);
        }
    }
    
    // Move coins
    for (let i = coins.length - 1; i >= 0; i--) {
        coins[i].x -= GAME_SPEED;
        if (coins[i].x < -30) {
            coins.splice(i, 1);
        }
    }
    
    // Coin collection
    for (let i = coins.length - 1; i >= 0; i--) {
        const coin = coins[i];
        const coinX = coin.x + 15;
        const coinY = GROUND_Y - 60;
        const playerCenterX = PLAYER_X + PLAYER_WIDTH / 2;
        const playerCenterY = playerY + PLAYER_HEIGHT / 2;
        
        if (Math.abs(playerCenterX - coinX) < 40 && Math.abs(playerCenterY - coinY) < 50) {
            score += COIN_VALUE;
            document.getElementById('score-display').textContent = score;
            coins.splice(i, 1);
        }
    }
    
    // Collision detection
    const playerH = isSliding ? PLAYER_HEIGHT * 0.5 : PLAYER_HEIGHT;
    const playerTop = isSliding ? GROUND_Y - playerH : playerY;
    
    for (const obs of obstacles) {
        let obsTop, obsBottom, obsLeft, obsRight;
        
        if (obs.type === 'ground') {
            obsTop = GROUND_Y - obs.height;
            obsBottom = GROUND_Y;
            obsLeft = obs.x;
            obsRight = obs.x + obs.width;
        } else {
            // High obstacle - only the barrier part
            obsTop = GROUND_Y - obs.height - 30;
            obsBottom = GROUND_Y - obs.height - 5;
            obsLeft = obs.x;
            obsRight = obs.x + obs.width;
        }
        
        // Forgiving hitbox
        const padding = 8;
        const playerLeft = PLAYER_X + padding;
        const playerRight = PLAYER_X + PLAYER_WIDTH - padding;
        const pTop = playerTop + padding;
        const pBottom = playerTop + playerH - padding;
        
        if (playerRight > obsLeft && playerLeft < obsRight &&
            pBottom > obsTop && pTop < obsBottom) {
            gameOver();
            return;
        }
    }
}

function draw() {
    drawBackground();
    for (const coin of coins) drawCoin(coin);
    for (const obs of obstacles) drawObstacle(obs);
    drawPlayer();
    drawScore();
}

let animFrame;
function gameLoop() {
    update();
    draw();
    animFrame = requestAnimationFrame(gameLoop);
}

function startGame() {
    gameState = 'ready';
    score = 0;
    playerY = GROUND_Y - PLAYER_HEIGHT;
    playerVelY = 0;
    isJumping = false;
    canDoubleJump = false;
    isSliding = false;
    slideTimer = 0;
    obstacles = [];
    coins = [];
    frameCount = 0;
    bgOffset = 0;
    
    overlay.classList.add('hidden');
    getReadyEl.classList.add('show');
    document.getElementById('score-display').textContent = '0';
    
    setTimeout(() => {
        getReadyEl.classList.remove('show');
        gameState = 'playing';
    }, 1500);
    
    if (!animFrame) gameLoop();
}

async function gameOver() {
    gameState = 'dead';
    gamesPlayed++;
    localStorage.setItem('dash_run_games', gamesPlayed);
    
    let isNewBest = false;
    if (score > bestScore) {
        bestScore = score;
        localStorage.setItem('dash_run_best', bestScore);
        isNewBest = true;
    }
    
    updateDisplays();
    
    overlayTitle.textContent = 'GAME OVER';
    overlayTitle.className = 'overlay-title gameover';
    overlayScore.textContent = score;
    overlayScore.classList.remove('hidden');
    overlayText.textContent = 'Tap to try again';
    startBtn.textContent = 'PLAY AGAIN';
    newBestEl.classList.toggle('hidden', !isNewBest);
    overlay.classList.remove('hidden');
    
    if (currentUserId && score > 0) {
        await supabaseClient.from('solo_scores').insert({
            user_id: currentUserId,
            game_id: 'dash-run',
            score: score
        });
        fetchLeaderboard(currentTab);
    }
}

// Keyboard controls
document.addEventListener('keydown', e => {
    if (e.key === ' ' || e.key === 'ArrowUp' || e.key === 'w') {
        e.preventDefault();
        if (gameState === 'idle' || gameState === 'dead') {
            startGame();
        } else if (gameState === 'playing') {
            jump();
        }
    } else if (e.key === 'ArrowDown' || e.key === 's') {
        e.preventDefault();
        if (gameState === 'playing') {
            slide();
        }
    }
});

// Touch controls
let touchStartY = 0;
const canvasWrapper = document.getElementById('canvas-wrapper');

canvasWrapper.addEventListener('touchstart', e => {
    touchStartY = e.touches[0].clientY;
}, { passive: true });

canvasWrapper.addEventListener('touchend', e => {
    if (gameState === 'idle' || gameState === 'dead') {
        startGame();
        return;
    }
    
    if (gameState !== 'playing') return;
    
    const touchEndY = e.changedTouches[0].clientY;
    const diff = touchEndY - touchStartY;
    
    if (diff > 40) {
        slide();
    } else {
        jump();
    }
}, { passive: true });

canvasWrapper.addEventListener('click', e => {
    if (gameState === 'idle' || gameState === 'dead') return;
    if (gameState === 'playing') jump();
});

startBtn.addEventListener('click', e => {
    e.stopPropagation();
    startGame();
});

// Auth & leaderboard
async function loadAuth() {
    const { data } = await supabaseClient.auth.getSession();
    const user = data?.session?.user;
    if (user) {
        currentUserId = user.id;
        loadFriends();
    }
    fetchLeaderboard('global');
}

async function loadFriends() {
    if (!currentUserId) return;
    try {
        const { data } = await supabaseClient.from('friendships')
            .select('user_id,friend_id')
            .or('user_id.eq.' + currentUserId + ',friend_id.eq.' + currentUserId)
            .eq('status', 'accepted');
        if (data) friendIds = data.map(f => f.user_id === currentUserId ? f.friend_id : f.user_id);
    } catch (e) {}
}

document.querySelectorAll('.lb-tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.lb-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentTab = tab.dataset.tab;
        fetchLeaderboard(currentTab);
    });
});

async function fetchLeaderboard(tab) {
    const lbList = document.getElementById('lb-list');
    lbList.innerHTML = '<div class="lb-empty">Loading...</div>';
    
    let query = supabaseClient.from('solo_scores')
        .select('score,user_id,created_at')
        .eq('game_id', 'dash-run')
        .order('score', { ascending: false })
        .limit(50);
    
    if (tab === 'today') {
        const t = new Date();
        t.setHours(0, 0, 0, 0);
        query = query.gte('created_at', t.toISOString());
    } else if (tab === 'friends') {
        if (!friendIds.length) {
            lbList.innerHTML = '<div class="lb-empty">Add friends to see scores</div>';
            return;
        }
        query = query.in('user_id', [...friendIds, currentUserId]);
    }
    
    const { data, error } = await query;
    if (error || !data || !data.length) {
        lbList.innerHTML = '<div class="lb-empty">No scores yet</div>';
        return;
    }
    
    // Dedupe to best score per user
    const best = new Map();
    data.forEach(e => {
        if (!best.has(e.user_id) || e.score > best.get(e.user_id).score) {
            best.set(e.user_id, e);
        }
    });
    const deduped = Array.from(best.values()).sort((a, b) => b.score - a.score);
    
    // Fetch profiles
    const userIds = [...new Set(deduped.map(e => e.user_id))];
    const { data: profiles } = await supabaseClient.from('profiles')
        .select('id,display_name,gamer_tag,account_type')
        .in('id', userIds);
    const pm = {};
    if (profiles) profiles.forEach(p => pm[p.id] = p);
    
    // Render
    lbList.innerHTML = '';
    deduped.slice(0, 10).forEach((e, i) => {
        const p = pm[e.user_id];
        const name = p ? (p.display_name || p.gamer_tag) : 'Anonymous';
        const isPremium = p && p.account_type === 'premium';
        const topClass = i === 0 ? 'top-1' : i === 1 ? 'top-2' : i === 2 ? 'top-3' : '';
        const premiumClass = isPremium && i > 2 ? 'premium-row' : '';
        
        const row = document.createElement('div');
        row.className = `lb-row ${topClass} ${premiumClass}`.trim();
        row.innerHTML = `
            <div class="lb-rank">${i + 1}</div>
            <div class="lb-avatar${isPremium ? ' premium' : ''}">${name.charAt(0).toUpperCase()}</div>
            <div class="lb-name${isPremium ? ' premium' : ''}">${name}</div>
            <div class="lb-score">${e.score}</div>
        `;
        lbList.appendChild(row);
    });
}

loadAuth();
draw();
</script>
<script src="/header.js"></script>
</body>
</html>
