<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dash Run ‚Äì Endless Runner | TheGaming.co</title>
    <meta name="description" content="Jump, slide, and dash through obstacles in this endless runner. Collect coins, grab power-ups, beat your high score!">
    <meta name="theme-color" content="#0a0a0f">
    <link rel="stylesheet" href="/header.css">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --pink: #ff6b9d;
            --orange: #f97316;
            --purple: #a855f7;
            --cyan: #22d3ee;
            --green: #22c55e;
            --gold: #ffd700;
            --sky-top: #87CEEB;
            --sky-bottom: #E0F6FF;
        }
        
        html { -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(180deg, var(--sky-top) 0%, var(--sky-bottom) 100%);
            color: #1a1a2e;
            min-height: 100vh;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }
        h1, h2, h3 { font-family: 'Bebas Neue', sans-serif; letter-spacing: 2px; }

        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding-top: 60px;
        }

        /* Hero */
        .game-hero {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 50%, #c2410c 100%);
            padding: 30px 20px 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .game-hero::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 50% 100%, rgba(255,255,255,0.2) 0%, transparent 60%);
        }
        .hero-content { position: relative; z-index: 1; }
        .hero-icon {
            font-size: 3rem;
            margin-bottom: 8px;
            animation: run 0.4s steps(2) infinite;
        }
        @keyframes run {
            0%, 100% { transform: translateX(-3px); }
            50% { transform: translateX(3px); }
        }
        .hero-title {
            font-size: 2.5rem;
            color: white;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.2);
            margin-bottom: 4px;
        }
        .hero-sub { font-size: 0.85rem; color: rgba(255,255,255,0.8); }

        /* Game Container */
        .game-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 16px 30px;
            gap: 16px;
        }

        /* HUD */
        .hud {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
            width: 100%;
            max-width: 420px;
        }
        .hud-item {
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(249, 115, 22, 0.2);
            border-radius: 12px;
            padding: 10px 16px;
            text-align: center;
            min-width: 80px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .hud-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #888;
            margin-bottom: 2px;
        }
        .hud-value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.4rem;
            letter-spacing: 1px;
        }
        .hud-value.score { color: var(--orange); }
        .hud-value.coins { color: var(--gold); }
        .hud-value.multi { color: var(--purple); }

        /* Power-up indicator */
        .powerup-active {
            background: linear-gradient(135deg, var(--green), #16a34a);
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
            display: none;
            align-items: center;
            gap: 8px;
            animation: pulse 1s ease-in-out infinite;
        }
        .powerup-active.show { display: flex; }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Canvas */
        #gameCanvas {
            border-radius: 16px;
            box-shadow: 0 8px 40px rgba(0,0,0,0.15);
            max-width: 100%;
            touch-action: none;
            background: linear-gradient(180deg, #87CEEB 0%, #E0F6FF 60%, #90EE90 60%, #228B22 100%);
        }

        /* Controls hint */
        .controls-hint {
            font-size: 0.75rem;
            color: #666;
            text-align: center;
            background: rgba(255,255,255,0.7);
            padding: 8px 16px;
            border-radius: 20px;
        }
        .controls-hint span { font-weight: 600; color: var(--orange); }

        /* Overlays */
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 20px;
        }
        .overlay.show { display: flex; }
        
        .overlay-content {
            background: linear-gradient(135deg, #fff 0%, #fef3c7 100%);
            border-radius: 24px;
            padding: 40px 32px;
            text-align: center;
            max-width: 380px;
            width: 100%;
            animation: popIn 0.4s ease;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        @keyframes popIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .overlay-title {
            font-size: 2.5rem;
            color: var(--orange);
            margin-bottom: 8px;
        }
        .overlay-subtitle {
            font-size: 0.95rem;
            color: #666;
            margin-bottom: 24px;
        }

        .final-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }
        .stat-box {
            background: rgba(249, 115, 22, 0.1);
            border-radius: 12px;
            padding: 16px 12px;
        }
        .stat-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #888;
            margin-bottom: 4px;
        }
        .stat-value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.6rem;
            color: var(--orange);
        }
        .stat-value.gold { color: #b8860b; }
        .stat-value.purple { color: var(--purple); }

        .new-best {
            background: linear-gradient(135deg, var(--gold), #f59e0b);
            color: #000;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
            margin-bottom: 20px;
            display: none;
        }
        .new-best.show { display: inline-block; }

        .btn {
            padding: 14px 32px;
            border-radius: 50px;
            border: none;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--orange), #ea580c);
            color: white;
            width: 100%;
            margin-bottom: 12px;
            box-shadow: 0 4px 15px rgba(249, 115, 22, 0.4);
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(249, 115, 22, 0.5); }
        .btn-secondary {
            background: white;
            color: var(--orange);
            border: 2px solid var(--orange);
            width: 100%;
        }
        .btn-secondary:hover { background: #fff7ed; }

        /* Start Screen */
        .start-content .start-icon { font-size: 4rem; margin-bottom: 16px; }
        .start-content .start-title {
            font-size: 3rem;
            color: var(--orange);
            margin-bottom: 12px;
        }
        .start-content .start-desc {
            color: #666;
            margin-bottom: 24px;
            line-height: 1.6;
        }
        
        .controls-legend {
            display: flex;
            justify-content: center;
            gap: 32px;
            margin-bottom: 24px;
        }
        .control-item {
            text-align: center;
        }
        .control-key {
            background: var(--orange);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin: 0 auto 8px;
            box-shadow: 0 4px 0 #c2410c;
        }
        .control-label {
            font-size: 0.8rem;
            color: #666;
            font-weight: 600;
        }

        .powerup-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 28px;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            color: #666;
        }
        .legend-icon {
            width: 26px;
            height: 26px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }
        .legend-icon.magnet { background: linear-gradient(135deg, #a855f7, #7c3aed); }
        .legend-icon.x2 { background: linear-gradient(135deg, #22c55e, #16a34a); }
        .legend-icon.shrink { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }

        @media (max-width: 420px) {
            .hero-title { font-size: 2rem; }
            .hud { gap: 8px; }
            .hud-item { padding: 8px 12px; min-width: 70px; }
            .hud-value { font-size: 1.2rem; }
            .controls-legend { gap: 20px; }
            .control-key { width: 40px; height: 40px; font-size: 1.2rem; }
        }
    </style>
</head>
<body>
    <div id="site-header"></div>
    
    <main>
        <section class="game-hero">
            <div class="hero-content">
                <div class="hero-icon">üèÉ</div>
                <h1 class="hero-title">DASH RUN</h1>
                <p class="hero-sub">Jump, slide, and run forever!</p>
            </div>
        </section>

        <div class="game-wrapper">
            <div class="hud">
                <div class="hud-item">
                    <div class="hud-label">Score</div>
                    <div class="hud-value score" id="score">0</div>
                </div>
                <div class="hud-item">
                    <div class="hud-label">Coins</div>
                    <div class="hud-value coins" id="coins">0</div>
                </div>
                <div class="hud-item">
                    <div class="hud-label">Multiplier</div>
                    <div class="hud-value multi" id="multiplier">1.0x</div>
                </div>
            </div>

            <div class="powerup-active" id="powerupIndicator">
                <span id="powerupIcon">‚ö°</span>
                <span id="powerupText">2X Score!</span>
            </div>

            <canvas id="gameCanvas" width="400" height="300"></canvas>

            <div class="controls-hint">
                <span>TAP</span> or <span>‚Üë SPACE</span> to Jump (x2) ‚Ä¢ <span>‚Üì</span> to Slide
            </div>
        </div>
    </main>

    <!-- Start Screen -->
    <div class="overlay show" id="startScreen">
        <div class="overlay-content start-content">
            <div class="start-icon">üèÉ‚Äç‚ôÇÔ∏è</div>
            <h1 class="start-title">DASH RUN</h1>
            <p class="start-desc">
                Run as far as you can! Jump over obstacles, slide under barriers, and collect coins.
            </p>
            
            <div class="controls-legend">
                <div class="control-item">
                    <div class="control-key">‚Üë</div>
                    <div class="control-label">Jump (x2)</div>
                </div>
                <div class="control-item">
                    <div class="control-key">‚Üì</div>
                    <div class="control-label">Slide</div>
                </div>
            </div>

            <div class="powerup-legend">
                <div class="legend-item">
                    <div class="legend-icon magnet">üß≤</div>
                    <span>Magnet</span>
                </div>
                <div class="legend-item">
                    <div class="legend-icon x2">‚ö°</div>
                    <span>2X Score</span>
                </div>
                <div class="legend-item">
                    <div class="legend-icon shrink">üî∑</div>
                    <span>Shrink</span>
                </div>
            </div>

            <button class="btn btn-primary" onclick="startGame()">TAP TO START</button>
        </div>
    </div>

    <!-- Game Over -->
    <div class="overlay" id="gameOver">
        <div class="overlay-content">
            <h2 class="overlay-title">GAME OVER</h2>
            <p class="overlay-subtitle">You hit an obstacle!</p>
            
            <div class="new-best" id="newBest">üèÜ NEW HIGH SCORE!</div>
            
            <div class="final-stats">
                <div class="stat-box">
                    <div class="stat-label">Final Score</div>
                    <div class="stat-value" id="finalScore">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Coins</div>
                    <div class="stat-value gold" id="finalCoins">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Distance</div>
                    <div class="stat-value" id="finalDistance">0m</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Best Multi</div>
                    <div class="stat-value purple" id="finalMulti">1.0x</div>
                </div>
            </div>

            <button class="btn btn-primary" onclick="restartGame()">PLAY AGAIN</button>
            <button class="btn btn-secondary" onclick="goToLeaderboard()">VIEW LEADERBOARD</button>
        </div>
    </div>

<script>
const SUPABASE_URL = 'https://tvvivtmzofsyehatzlvl.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR2dml2dG16b2ZzeWVoYXR6bHZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4OTExODYsImV4cCI6MjA4MDQ2NzE4Nn0.Qy8kHMO0Nb4yJ0ZHjby7RuQtzwWB8rUcZvkdnbL1b3M';
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
window.supabaseClient = supabaseClient;

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// Game constants
const GROUND_Y = canvas.height - 50;
const PLAYER_WIDTH = 40;
const PLAYER_HEIGHT = 60;
const GRAVITY = 0.8;
const JUMP_FORCE = -14;

// Game state
let gameRunning = false;
let score = 0;
let coins = 0;
let distance = 0;
let multiplier = 1.0;
let maxMultiplier = 1.0;
let speed = 5;

// Player state
let playerX = 60;
let playerY = GROUND_Y - PLAYER_HEIGHT;
let playerVelY = 0;
let isJumping = false;
let canDoubleJump = true;
let isSliding = false;
let slideTimer = 0;

// Objects
let obstacles = [];
let collectibles = [];
let clouds = [];
let buildings = [];

// Power-ups
let coinMagnet = false;
let magnetTimer = 0;
let scoreMultiplier = false;
let scoreMultiTimer = 0;
let shrink = false;
let shrinkTimer = 0;

// Spawning - FIXED: Proper timing
let lastObstacleX = 0;
let minObstacleGap = 350; // Minimum gap between obstacles
let obstacleSpawnTimer = 0;

// Animation
let animFrame;
let lastTime = 0;
let runFrame = 0;
let runFrameTimer = 0;

// High score
let highScore = parseInt(localStorage.getItem('dash_run_high') || '0');

// Colors
const COLORS = {
    sky: '#87CEEB',
    ground: '#228B22',
    grass: '#32CD32',
    player: '#f97316',
    playerDark: '#c2410c',
    obstacle: '#8B4513',
    obstacleHigh: '#DC143C',
    coin: '#ffd700'
};

// Initialize background elements
function initBackground() {
    clouds = [];
    buildings = [];
    
    for (let i = 0; i < 5; i++) {
        clouds.push({
            x: Math.random() * canvas.width,
            y: 30 + Math.random() * 60,
            width: 60 + Math.random() * 40,
            speed: 0.2 + Math.random() * 0.3
        });
    }
    
    for (let i = 0; i < 8; i++) {
        buildings.push({
            x: i * 80,
            width: 50 + Math.random() * 30,
            height: 60 + Math.random() * 80,
            color: `hsl(${200 + Math.random() * 40}, 20%, ${60 + Math.random() * 20}%)`
        });
    }
}

function startGame() {
    document.getElementById('startScreen').classList.remove('show');
    resetGame();
    initBackground();
    gameRunning = true;
    lastTime = performance.now();
    gameLoop();
}

function resetGame() {
    score = 0;
    coins = 0;
    distance = 0;
    multiplier = 1.0;
    maxMultiplier = 1.0;
    speed = 5;
    
    playerY = GROUND_Y - PLAYER_HEIGHT;
    playerVelY = 0;
    isJumping = false;
    canDoubleJump = true;
    isSliding = false;
    slideTimer = 0;
    
    obstacles = [];
    collectibles = [];
    lastObstacleX = canvas.width;
    obstacleSpawnTimer = 0;
    
    coinMagnet = false;
    scoreMultiplier = false;
    shrink = false;
    
    updateHUD();
    hidePowerupIndicator();
}

function restartGame() {
    document.getElementById('gameOver').classList.remove('show');
    resetGame();
    initBackground();
    gameRunning = true;
    lastTime = performance.now();
    gameLoop();
}

function gameLoop(currentTime = 0) {
    if (!gameRunning) return;
    
    const dt = Math.min(currentTime - lastTime, 50);
    lastTime = currentTime;
    
    update(dt);
    draw();
    
    animFrame = requestAnimationFrame(gameLoop);
}

function update(dt) {
    const timeScale = dt / 16;
    
    // Update distance and score
    distance += speed * timeScale * 0.1;
    const baseScore = speed * timeScale * 0.5;
    const multi = scoreMultiplier ? multiplier * 2 : multiplier;
    score += Math.floor(baseScore * multi);
    
    // Increase multiplier over time
    multiplier += 0.0005 * timeScale;
    maxMultiplier = Math.max(maxMultiplier, multiplier);
    
    // Gradually increase speed (capped)
    if (speed < 12) {
        speed += 0.001 * timeScale;
    }
    
    // Increase min gap as speed increases to keep it fair
    minObstacleGap = 350 + (speed - 5) * 15;
    
    // Update power-ups
    updatePowerups(dt);
    
    // Player physics
    updatePlayer(timeScale);
    
    // Spawn obstacles with GUARANTEED gaps
    spawnObstacles(timeScale);
    
    // Spawn collectibles
    spawnCollectibles(dt);
    
    // Move obstacles
    for (let i = obstacles.length - 1; i >= 0; i--) {
        const obs = obstacles[i];
        obs.x -= speed * timeScale;
        
        if (obs.x + obs.width < 0) {
            obstacles.splice(i, 1);
            continue;
        }
        
        if (checkCollision(obs)) {
            if (shrink) {
                // Shrink lets you pass through
            } else {
                gameOver();
                return;
            }
        }
    }
    
    // Move collectibles
    for (let i = collectibles.length - 1; i >= 0; i--) {
        const col = collectibles[i];
        col.x -= speed * timeScale;
        
        // Magnet effect
        if (coinMagnet && col.type === 'coin') {
            const dx = playerX + PLAYER_WIDTH/2 - col.x;
            const dy = playerY + PLAYER_HEIGHT/2 - col.y;
            const dist = Math.sqrt(dx * dx + dy * dy);
            if (dist < 150) {
                col.x += dx * 0.15;
                col.y += dy * 0.15;
            }
        }
        
        if (col.x + 20 < 0) {
            collectibles.splice(i, 1);
            continue;
        }
        
        if (checkCollectibleCollision(col)) {
            collectItem(col);
            collectibles.splice(i, 1);
        }
    }
    
    // Move background
    for (const cloud of clouds) {
        cloud.x -= cloud.speed * timeScale;
        if (cloud.x + cloud.width < 0) {
            cloud.x = canvas.width + 20;
            cloud.y = 30 + Math.random() * 60;
        }
    }
    
    for (const building of buildings) {
        building.x -= speed * 0.3 * timeScale;
        if (building.x + building.width < 0) {
            building.x = canvas.width + 20;
            building.height = 60 + Math.random() * 80;
        }
    }
    
    // Run animation
    if (!isJumping && !isSliding) {
        runFrameTimer += dt;
        if (runFrameTimer > 100) {
            runFrame = (runFrame + 1) % 2;
            runFrameTimer = 0;
        }
    }
    
    updateHUD();
}

function updatePlayer(timeScale) {
    // Apply gravity
    playerVelY += GRAVITY * timeScale;
    playerY += playerVelY * timeScale;
    
    // Ground collision
    const groundLevel = GROUND_Y - (shrink ? PLAYER_HEIGHT * 0.6 : (isSliding ? PLAYER_HEIGHT * 0.5 : PLAYER_HEIGHT));
    
    if (playerY >= groundLevel) {
        playerY = groundLevel;
        playerVelY = 0;
        isJumping = false;
        canDoubleJump = true;
    }
    
    // Slide timer
    if (isSliding) {
        slideTimer -= 16;
        if (slideTimer <= 0) {
            isSliding = false;
        }
    }
}

function jump() {
    if (!gameRunning) return;
    
    if (!isJumping) {
        // First jump
        playerVelY = JUMP_FORCE;
        isJumping = true;
        isSliding = false;
    } else if (canDoubleJump) {
        // Double jump
        playerVelY = JUMP_FORCE * 0.85;
        canDoubleJump = false;
    }
}

function slide() {
    if (!gameRunning) return;
    
    if (!isJumping) {
        isSliding = true;
        slideTimer = 500; // 500ms slide
    }
}

function spawnObstacles(timeScale) {
    // Find rightmost obstacle
    let rightmostX = 0;
    for (const obs of obstacles) {
        if (obs.x + obs.width > rightmostX) {
            rightmostX = obs.x + obs.width;
        }
    }
    
    // Only spawn if there's enough gap
    const spawnX = canvas.width + 50;
    if (rightmostX > 0 && spawnX - rightmostX < minObstacleGap) {
        return; // Too close to last obstacle
    }
    
    // Random spawn chance
    obstacleSpawnTimer += 16 * timeScale;
    if (obstacleSpawnTimer < 800) return; // Min 800ms between spawn attempts
    
    if (Math.random() < 0.03) {
        obstacleSpawnTimer = 0;
        
        // Determine obstacle type
        // Early game: only ground obstacles
        // Later: mix of types
        const types = distance < 100 ? ['ground'] : 
                     distance < 300 ? ['ground', 'ground', 'high'] :
                     ['ground', 'high', 'tall'];
        
        const type = types[Math.floor(Math.random() * types.length)];
        
        let obs;
        if (type === 'ground') {
            // Low obstacle - jump over
            obs = {
                type: 'ground',
                x: spawnX,
                y: GROUND_Y - 40,
                width: 40 + Math.random() * 20,
                height: 40,
                color: COLORS.obstacle
            };
        } else if (type === 'high') {
            // High obstacle - slide under
            obs = {
                type: 'high',
                x: spawnX,
                y: GROUND_Y - 80,
                width: 60,
                height: 30,
                color: COLORS.obstacleHigh
            };
        } else {
            // Tall obstacle - must jump
            obs = {
                type: 'tall',
                x: spawnX,
                y: GROUND_Y - 70,
                width: 30,
                height: 70,
                color: '#654321'
            };
        }
        
        obstacles.push(obs);
    }
}

function spawnCollectibles(dt) {
    // Coins
    if (Math.random() < 0.02 * (dt / 16)) {
        const heights = [GROUND_Y - 80, GROUND_Y - 120, GROUND_Y - 160];
        collectibles.push({
            type: 'coin',
            x: canvas.width + 20,
            y: heights[Math.floor(Math.random() * heights.length)],
            radius: 12
        });
    }
    
    // Power-ups (rare)
    if (Math.random() < 0.002 * (dt / 16) && distance > 50) {
        const types = ['magnet', 'x2', 'shrink'];
        collectibles.push({
            type: types[Math.floor(Math.random() * types.length)],
            x: canvas.width + 20,
            y: GROUND_Y - 100 - Math.random() * 60,
            radius: 18
        });
    }
}

function collectItem(item) {
    if (item.type === 'coin') {
        coins++;
        score += 50 * (scoreMultiplier ? 2 : 1);
    } else if (item.type === 'magnet') {
        coinMagnet = true;
        magnetTimer = 8000;
        showPowerupIndicator('üß≤', 'Coin Magnet!');
    } else if (item.type === 'x2') {
        scoreMultiplier = true;
        scoreMultiTimer = 10000;
        showPowerupIndicator('‚ö°', '2X Score!');
    } else if (item.type === 'shrink') {
        shrink = true;
        shrinkTimer = 5000;
        showPowerupIndicator('üî∑', 'Shrink Mode!');
    }
}

function updatePowerups(dt) {
    if (coinMagnet) {
        magnetTimer -= dt;
        if (magnetTimer <= 0) { coinMagnet = false; hidePowerupIndicator(); }
    }
    if (scoreMultiplier) {
        scoreMultiTimer -= dt;
        if (scoreMultiTimer <= 0) { scoreMultiplier = false; hidePowerupIndicator(); }
    }
    if (shrink) {
        shrinkTimer -= dt;
        if (shrinkTimer <= 0) { shrink = false; hidePowerupIndicator(); }
    }
}

function showPowerupIndicator(icon, text) {
    document.getElementById('powerupIcon').textContent = icon;
    document.getElementById('powerupText').textContent = text;
    document.getElementById('powerupIndicator').classList.add('show');
}

function hidePowerupIndicator() {
    if (!coinMagnet && !scoreMultiplier && !shrink) {
        document.getElementById('powerupIndicator').classList.remove('show');
    }
}

function checkCollision(obs) {
    const pw = shrink ? PLAYER_WIDTH * 0.6 : PLAYER_WIDTH;
    const ph = shrink ? PLAYER_HEIGHT * 0.6 : (isSliding ? PLAYER_HEIGHT * 0.5 : PLAYER_HEIGHT);
    const py = shrink || isSliding ? GROUND_Y - ph : playerY;
    
    const padding = 8;
    
    return playerX + padding < obs.x + obs.width - padding &&
           playerX + pw - padding > obs.x + padding &&
           py + padding < obs.y + obs.height - padding &&
           py + ph - padding > obs.y + padding;
}

function checkCollectibleCollision(col) {
    const px = playerX + PLAYER_WIDTH / 2;
    const py = playerY + PLAYER_HEIGHT / 2;
    const dx = px - col.x;
    const dy = py - col.y;
    return Math.sqrt(dx * dx + dy * dy) < col.radius + 25;
}

function draw() {
    // Sky gradient
    const skyGrad = ctx.createLinearGradient(0, 0, 0, GROUND_Y);
    skyGrad.addColorStop(0, '#87CEEB');
    skyGrad.addColorStop(1, '#E0F6FF');
    ctx.fillStyle = skyGrad;
    ctx.fillRect(0, 0, canvas.width, GROUND_Y);
    
    // Sun
    ctx.fillStyle = '#FFD700';
    ctx.beginPath();
    ctx.arc(canvas.width - 60, 50, 30, 0, Math.PI * 2);
    ctx.fill();
    
    // Clouds
    ctx.fillStyle = 'rgba(255,255,255,0.9)';
    for (const cloud of clouds) {
        ctx.beginPath();
        ctx.arc(cloud.x, cloud.y, cloud.width * 0.3, 0, Math.PI * 2);
        ctx.arc(cloud.x + cloud.width * 0.3, cloud.y - 10, cloud.width * 0.25, 0, Math.PI * 2);
        ctx.arc(cloud.x + cloud.width * 0.6, cloud.y, cloud.width * 0.3, 0, Math.PI * 2);
        ctx.fill();
    }
    
    // Buildings (background)
    for (const building of buildings) {
        ctx.fillStyle = building.color;
        ctx.fillRect(building.x, GROUND_Y - building.height, building.width, building.height);
        
        // Windows
        ctx.fillStyle = 'rgba(255,255,255,0.3)';
        for (let wy = GROUND_Y - building.height + 10; wy < GROUND_Y - 10; wy += 20) {
            for (let wx = building.x + 8; wx < building.x + building.width - 8; wx += 15) {
                ctx.fillRect(wx, wy, 8, 12);
            }
        }
    }
    
    // Ground
    ctx.fillStyle = COLORS.ground;
    ctx.fillRect(0, GROUND_Y, canvas.width, canvas.height - GROUND_Y);
    
    // Grass line
    ctx.fillStyle = COLORS.grass;
    ctx.fillRect(0, GROUND_Y, canvas.width, 8);
    
    // Collectibles
    for (const col of collectibles) {
        if (col.type === 'coin') {
            ctx.fillStyle = COLORS.coin;
            ctx.shadowBlur = 10;
            ctx.shadowColor = COLORS.coin;
            ctx.beginPath();
            ctx.arc(col.x, col.y, col.radius, 0, Math.PI * 2);
            ctx.fill();
            ctx.shadowBlur = 0;
            
            ctx.fillStyle = '#b8860b';
            ctx.font = 'bold 10px Inter';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('$', col.x, col.y);
        } else {
            const colors = { magnet: '#a855f7', x2: '#22c55e', shrink: '#3b82f6' };
            const icons = { magnet: 'üß≤', x2: '‚ö°', shrink: 'üî∑' };
            
            ctx.fillStyle = colors[col.type];
            ctx.shadowBlur = 15;
            ctx.shadowColor = colors[col.type];
            ctx.beginPath();
            ctx.arc(col.x, col.y, col.radius, 0, Math.PI * 2);
            ctx.fill();
            ctx.shadowBlur = 0;
            
            ctx.font = '14px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(icons[col.type], col.x, col.y);
        }
    }
    
    // Obstacles
    for (const obs of obstacles) {
        ctx.fillStyle = obs.color;
        
        if (obs.type === 'ground') {
            // Crate/box
            ctx.fillRect(obs.x, obs.y, obs.width, obs.height);
            ctx.strokeStyle = '#5D3A1A';
            ctx.lineWidth = 2;
            ctx.strokeRect(obs.x, obs.y, obs.width, obs.height);
            ctx.beginPath();
            ctx.moveTo(obs.x, obs.y);
            ctx.lineTo(obs.x + obs.width, obs.y + obs.height);
            ctx.moveTo(obs.x + obs.width, obs.y);
            ctx.lineTo(obs.x, obs.y + obs.height);
            ctx.stroke();
        } else if (obs.type === 'high') {
            // Floating barrier
            ctx.fillRect(obs.x, obs.y, obs.width, obs.height);
            ctx.fillStyle = '#8B0000';
            ctx.fillRect(obs.x, obs.y, obs.width, 5);
        } else {
            // Tall pillar
            ctx.fillRect(obs.x, obs.y, obs.width, obs.height);
            ctx.fillStyle = '#4a3520';
            ctx.fillRect(obs.x + 5, obs.y + 5, obs.width - 10, obs.height - 5);
        }
    }
    
    // Player
    drawPlayer();
}

function drawPlayer() {
    const scale = shrink ? 0.6 : 1;
    const w = PLAYER_WIDTH * scale;
    const h = isSliding ? PLAYER_HEIGHT * 0.5 * scale : PLAYER_HEIGHT * scale;
    const x = playerX + (PLAYER_WIDTH - w) / 2;
    const y = isSliding || shrink ? GROUND_Y - h : playerY + (shrink ? PLAYER_HEIGHT * 0.4 : 0);
    
    // Shadow
    ctx.fillStyle = 'rgba(0,0,0,0.2)';
    ctx.beginPath();
    ctx.ellipse(playerX + PLAYER_WIDTH/2, GROUND_Y + 5, w/2, 8, 0, 0, Math.PI * 2);
    ctx.fill();
    
    // Body
    ctx.fillStyle = COLORS.player;
    ctx.beginPath();
    ctx.roundRect(x + w * 0.15, y + h * 0.3, w * 0.7, h * 0.65, 8 * scale);
    ctx.fill();
    
    // Head
    ctx.fillStyle = '#FFE4C4';
    ctx.beginPath();
    ctx.arc(x + w/2, y + h * 0.2, w * 0.3, 0, Math.PI * 2);
    ctx.fill();
    
    // Eyes
    ctx.fillStyle = '#333';
    ctx.beginPath();
    ctx.arc(x + w * 0.4, y + h * 0.18, 3 * scale, 0, Math.PI * 2);
    ctx.arc(x + w * 0.6, y + h * 0.18, 3 * scale, 0, Math.PI * 2);
    ctx.fill();
    
    // Legs (animated)
    ctx.fillStyle = COLORS.playerDark;
    if (isJumping) {
        // Tucked legs
        ctx.fillRect(x + w * 0.2, y + h * 0.85, w * 0.25, h * 0.15);
        ctx.fillRect(x + w * 0.55, y + h * 0.85, w * 0.25, h * 0.15);
    } else if (isSliding) {
        // Extended legs
        ctx.fillRect(x + w * 0.1, y + h * 0.7, w * 0.8, h * 0.2);
    } else {
        // Running animation
        const legOffset = runFrame === 0 ? 0 : w * 0.15;
        ctx.fillRect(x + w * 0.25 - legOffset, y + h * 0.85, w * 0.2, h * 0.15);
        ctx.fillRect(x + w * 0.55 + legOffset, y + h * 0.85, w * 0.2, h * 0.15);
    }
    
    // Shrink glow
    if (shrink) {
        ctx.strokeStyle = 'rgba(59, 130, 246, 0.6)';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.arc(x + w/2, y + h/2, w * 0.8, 0, Math.PI * 2);
        ctx.stroke();
    }
}

function updateHUD() {
    document.getElementById('score').textContent = score.toLocaleString();
    document.getElementById('coins').textContent = coins;
    document.getElementById('multiplier').textContent = multiplier.toFixed(1) + 'x';
}

function gameOver() {
    gameRunning = false;
    cancelAnimationFrame(animFrame);
    
    // Reset multiplier on death
    multiplier = 1.0;
    
    const isNewBest = score > highScore;
    if (isNewBest) {
        highScore = score;
        localStorage.setItem('dash_run_high', score.toString());
    }
    
    document.getElementById('finalScore').textContent = score.toLocaleString();
    document.getElementById('finalCoins').textContent = coins;
    document.getElementById('finalDistance').textContent = Math.floor(distance) + 'm';
    document.getElementById('finalMulti').textContent = maxMultiplier.toFixed(1) + 'x';
    document.getElementById('newBest').classList.toggle('show', isNewBest);
    
    document.getElementById('gameOver').classList.add('show');
    
    submitScore();
}

async function submitScore() {
    try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (!session) return;
        
        await supabaseClient.from('solo_scores').upsert({
            user_id: session.user.id,
            game_id: 'dash-run',
            score: score,
            metadata: { coins, distance: Math.floor(distance), maxMultiplier: maxMultiplier.toFixed(1) }
        }, { onConflict: 'user_id,game_id' });
    } catch (e) {
        console.log('Score submission:', e);
    }
}

function goToLeaderboard() {
    window.location.href = '/leaderboards?game=dash-run';
}

// Controls
document.addEventListener('keydown', (e) => {
    if (e.code === 'Space' || e.code === 'ArrowUp' || e.code === 'KeyW') {
        e.preventDefault();
        jump();
    }
    if (e.code === 'ArrowDown' || e.code === 'KeyS') {
        e.preventDefault();
        slide();
    }
});

// Touch controls
let touchStartY = 0;
canvas.addEventListener('touchstart', (e) => {
    e.preventDefault();
    touchStartY = e.touches[0].clientY;
}, { passive: false });

canvas.addEventListener('touchend', (e) => {
    e.preventDefault();
    const touchEndY = e.changedTouches[0].clientY;
    const diff = touchEndY - touchStartY;
    
    if (diff > 50) {
        slide();
    } else {
        jump();
    }
}, { passive: false });

// Click = jump
canvas.addEventListener('click', () => jump());

// Start screen tap
document.getElementById('startScreen').addEventListener('click', (e) => {
    if (e.target.tagName !== 'BUTTON') startGame();
});
</script>

<script src="/header.js"></script>
</body>
</html>
