<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Highway Dodge ‚Äì Endless Racing | TheGaming.co</title>
    <meta name="description" content="Dodge traffic in this endless racing game. Collect coins, grab power-ups, and see how far you can go!">
    <meta name="theme-color" content="#0a0a0f">
    <link rel="stylesheet" href="/header.css">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --pink: #ff6b9d;
            --blue: #4facfe;
            --purple: #a855f7;
            --cyan: #22d3ee;
            --green: #22c55e;
            --gold: #ffd700;
            --text-dark: #1a1a2e;
        }
        
        html { -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #0f172a 100%);
            color: white;
            min-height: 100vh;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }
        h1, h2, h3 { font-family: 'Bebas Neue', sans-serif; letter-spacing: 2px; }

        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding-top: 60px;
        }

        /* Hero Section */
        .game-hero {
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #1e1b4b 100%);
            padding: 30px 20px 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .game-hero::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 50% 0%, rgba(79, 172, 254, 0.2) 0%, transparent 60%);
        }
        .hero-content { position: relative; z-index: 1; }
        .hero-icon {
            font-size: 3rem;
            margin-bottom: 8px;
            animation: bounce 2s ease-in-out infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        .hero-title {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #fff, var(--cyan), var(--blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 4px;
        }
        .hero-sub { font-size: 0.85rem; color: rgba(255,255,255,0.6); }

        /* Game Container */
        .game-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 16px 30px;
            gap: 16px;
        }

        /* HUD */
        .hud {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
            width: 100%;
            max-width: 400px;
        }
        .hud-item {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 12px;
            padding: 10px 16px;
            text-align: center;
            min-width: 80px;
        }
        .hud-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255,255,255,0.5);
            margin-bottom: 2px;
        }
        .hud-value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.4rem;
            letter-spacing: 1px;
        }
        .hud-value.score { color: var(--cyan); }
        .hud-value.coins { color: var(--gold); }
        .hud-value.speed { color: var(--pink); }

        /* Power-up indicator */
        .powerup-active {
            background: linear-gradient(135deg, var(--purple), var(--pink));
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 0.8rem;
            font-weight: 600;
            display: none;
            align-items: center;
            gap: 8px;
            animation: pulse 1s ease-in-out infinite;
        }
        .powerup-active.show { display: flex; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Canvas */
        #gameCanvas {
            border-radius: 16px;
            box-shadow: 0 8px 40px rgba(0,0,0,0.5), 0 0 60px rgba(79, 172, 254, 0.15);
            max-width: 100%;
            touch-action: none;
        }

        /* Controls hint */
        .controls-hint {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.4);
            text-align: center;
        }

        /* Game Over Overlay */
        .game-over {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 20px;
        }
        .game-over.show { display: flex; }
        .game-over-content {
            background: linear-gradient(135deg, #1e1b4b, #312e81);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 24px;
            padding: 40px 32px;
            text-align: center;
            max-width: 360px;
            width: 100%;
            animation: slideUp 0.4s ease;
        }
        @keyframes slideUp {
            from { transform: translateY(40px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .game-over-title {
            font-size: 2.5rem;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--pink), var(--purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .game-over-subtitle {
            font-size: 0.9rem;
            color: rgba(255,255,255,0.6);
            margin-bottom: 24px;
        }
        .final-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }
        .stat-box {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 16px 12px;
        }
        .stat-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255,255,255,0.5);
            margin-bottom: 4px;
        }
        .stat-value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.6rem;
            color: var(--cyan);
        }
        .stat-value.gold { color: var(--gold); }
        .stat-value.green { color: var(--green); }

        .new-best {
            background: linear-gradient(135deg, var(--gold), #f59e0b);
            color: #000;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            margin-bottom: 20px;
            display: none;
        }
        .new-best.show { display: inline-block; }

        .btn {
            padding: 14px 32px;
            border-radius: 50px;
            border: none;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--cyan), var(--blue));
            color: #000;
            width: 100%;
            margin-bottom: 12px;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(34, 211, 238, 0.4); }
        .btn-secondary {
            background: transparent;
            color: rgba(255,255,255,0.7);
            border: 1px solid rgba(255,255,255,0.2);
            width: 100%;
        }
        .btn-secondary:hover { background: rgba(255,255,255,0.1); }

        /* Start Screen */
        .start-screen {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 20px;
        }
        .start-screen.hidden { display: none; }
        .start-content {
            text-align: center;
            max-width: 360px;
        }
        .start-icon { font-size: 4rem; margin-bottom: 16px; }
        .start-title {
            font-size: 3rem;
            background: linear-gradient(135deg, #fff, var(--cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 12px;
        }
        .start-desc {
            color: rgba(255,255,255,0.6);
            margin-bottom: 32px;
            line-height: 1.6;
        }
        .powerup-legend {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-bottom: 32px;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: rgba(255,255,255,0.7);
        }
        .legend-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }
        .legend-icon.shield { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .legend-icon.magnet { background: linear-gradient(135deg, #a855f7, #7c3aed); }
        .legend-icon.slow { background: linear-gradient(135deg, #22c55e, #16a34a); }

        @media (max-width: 400px) {
            .hero-title { font-size: 2rem; }
            .hud { gap: 8px; }
            .hud-item { padding: 8px 12px; min-width: 70px; }
            .hud-value { font-size: 1.2rem; }
        }
    </style>
</head>
<body>
    <div id="site-header"></div>
    
    <main>
        <section class="game-hero">
            <div class="hero-content">
                <div class="hero-icon">üöó</div>
                <h1 class="hero-title">HIGHWAY DODGE</h1>
                <p class="hero-sub">Dodge traffic, collect coins, grab power-ups!</p>
            </div>
        </section>

        <div class="game-wrapper">
            <div class="hud">
                <div class="hud-item">
                    <div class="hud-label">Score</div>
                    <div class="hud-value score" id="score">0</div>
                </div>
                <div class="hud-item">
                    <div class="hud-label">Coins</div>
                    <div class="hud-value coins" id="coins">0</div>
                </div>
                <div class="hud-item">
                    <div class="hud-label">Speed</div>
                    <div class="hud-value speed" id="speed">60</div>
                </div>
            </div>

            <div class="powerup-active" id="powerupIndicator">
                <span id="powerupIcon">üõ°Ô∏è</span>
                <span id="powerupText">Shield Active</span>
            </div>

            <canvas id="gameCanvas" width="360" height="540"></canvas>

            <div class="controls-hint">
                ‚Üê ‚Üí Arrow Keys or Swipe/Tap to move
            </div>
        </div>
    </main>

    <!-- Start Screen -->
    <div class="start-screen" id="startScreen">
        <div class="start-content">
            <div class="start-icon">üèéÔ∏è</div>
            <h1 class="start-title">HIGHWAY DODGE</h1>
            <p class="start-desc">
                Dodge oncoming traffic and survive as long as you can!
                Collect coins and power-ups to boost your score.
            </p>
            <div class="powerup-legend">
                <div class="legend-item">
                    <div class="legend-icon shield">üõ°Ô∏è</div>
                    <span>Shield</span>
                </div>
                <div class="legend-item">
                    <div class="legend-icon magnet">üß≤</div>
                    <span>Coin Magnet</span>
                </div>
                <div class="legend-item">
                    <div class="legend-icon slow">üê¢</div>
                    <span>Slow-Mo</span>
                </div>
            </div>
            <button class="btn btn-primary" onclick="startGame()">TAP TO START</button>
        </div>
    </div>

    <!-- Game Over -->
    <div class="game-over" id="gameOver">
        <div class="game-over-content">
            <h2 class="game-over-title">GAME OVER</h2>
            <p class="game-over-subtitle">You crashed into traffic!</p>
            
            <div class="new-best" id="newBest">üèÜ NEW HIGH SCORE!</div>
            
            <div class="final-stats">
                <div class="stat-box">
                    <div class="stat-label">Final Score</div>
                    <div class="stat-value" id="finalScore">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Coins</div>
                    <div class="stat-value gold" id="finalCoins">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Distance</div>
                    <div class="stat-value green" id="finalDistance">0m</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Top Speed</div>
                    <div class="stat-value" id="finalSpeed">0</div>
                </div>
            </div>

            <button class="btn btn-primary" onclick="restartGame()">PLAY AGAIN</button>
            <button class="btn btn-secondary" onclick="goToLeaderboard()">VIEW LEADERBOARD</button>
        </div>
    </div>

<script>
const SUPABASE_URL = 'https://tvvivtmzofsyehatzlvl.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR2dml2dG16b2ZzeWVoYXR6bHZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4OTExODYsImV4cCI6MjA4MDQ2NzE4Nn0.Qy8kHMO0Nb4yJ0ZHjby7RuQtzwWB8rUcZvkdnbL1b3M';
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
window.supabaseClient = supabaseClient;

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// Game constants
const LANE_COUNT = 3;
const LANE_WIDTH = canvas.width / LANE_COUNT;
const CAR_WIDTH = 50;
const CAR_HEIGHT = 90;
const PLAYER_Y = canvas.height - 140;

// Game state
let gameRunning = false;
let score = 0;
let coins = 0;
let distance = 0;
let speed = 60;
let maxSpeed = 60;
let playerLane = 1;
let obstacles = [];
let collectibles = [];
let roadOffset = 0;

// Power-ups
let shield = false;
let shieldTimer = 0;
let magnet = false;
let magnetTimer = 0;
let slowMo = false;
let slowMoTimer = 0;

// Spawn timing - FIXED: Guaranteed safe spawning
let spawnTimer = 0;
let spawnInterval = 1500; // Start with 1.5s between cars

// Animation
let animFrame;
let lastTime = 0;

// High score
let highScore = parseInt(localStorage.getItem('highway_dodge_high') || '0');

// Colors
const COLORS = {
    road: '#1a1a2e',
    roadLine: '#3b4a6b',
    player: '#22d3ee',
    playerAccent: '#0891b2',
    obstacle: ['#ef4444', '#f97316', '#ec4899', '#a855f7', '#8b5cf6'],
    coin: '#ffd700',
    shield: '#3b82f6',
    magnet: '#a855f7',
    slow: '#22c55e'
};

function startGame() {
    document.getElementById('startScreen').classList.add('hidden');
    resetGame();
    gameRunning = true;
    lastTime = performance.now();
    gameLoop();
}

function resetGame() {
    score = 0;
    coins = 0;
    distance = 0;
    speed = 60;
    maxSpeed = 60;
    playerLane = 1;
    obstacles = [];
    collectibles = [];
    roadOffset = 0;
    shield = false;
    magnet = false;
    slowMo = false;
    spawnTimer = 0;
    spawnInterval = 1500;
    updateHUD();
    hidePowerupIndicator();
}

function restartGame() {
    document.getElementById('gameOver').classList.remove('show');
    resetGame();
    gameRunning = true;
    lastTime = performance.now();
    gameLoop();
}

function gameLoop(currentTime = 0) {
    if (!gameRunning) return;
    
    const deltaTime = Math.min(currentTime - lastTime, 50);
    lastTime = currentTime;
    
    update(deltaTime);
    draw();
    
    animFrame = requestAnimationFrame(gameLoop);
}

function update(dt) {
    const timeScale = slowMo ? 0.5 : 1;
    const effectiveDt = dt * timeScale;
    
    // Update distance and score
    distance += speed * (effectiveDt / 1000);
    score = Math.floor(distance * 10 + coins * 50);
    
    // Gradually increase speed (slow ramp)
    if (speed < 160) {
        speed += 0.002 * effectiveDt;
    }
    maxSpeed = Math.max(maxSpeed, speed);
    
    // Spawn interval decreases with speed but never below 800ms
    spawnInterval = Math.max(800, 1500 - (speed - 60) * 5);
    
    // Update road animation
    roadOffset += speed * 0.15 * (effectiveDt / 16);
    if (roadOffset > 60) roadOffset = 0;
    
    // Update power-up timers
    updatePowerups(effectiveDt);
    
    // Spawn obstacles on timer
    spawnTimer += effectiveDt;
    if (spawnTimer >= spawnInterval) {
        spawnObstacle();
        spawnTimer = 0;
    }
    
    // Spawn collectibles
    spawnCollectibles(effectiveDt);
    
    // Move obstacles
    for (let i = obstacles.length - 1; i >= 0; i--) {
        const obs = obstacles[i];
        obs.y += (speed * 0.12 + obs.speed) * (effectiveDt / 16);
        
        if (obs.y > canvas.height + 100) {
            obstacles.splice(i, 1);
            continue;
        }
        
        if (checkCollision(obs)) {
            if (shield) {
                shield = false;
                obstacles.splice(i, 1);
                hidePowerupIndicator();
            } else {
                gameOver();
                return;
            }
        }
    }
    
    // Move collectibles
    const playerX = playerLane * LANE_WIDTH + LANE_WIDTH / 2;
    for (let i = collectibles.length - 1; i >= 0; i--) {
        const col = collectibles[i];
        col.y += speed * 0.12 * (effectiveDt / 16);
        
        // Magnet effect
        if (magnet && col.type === 'coin') {
            const dx = playerX - col.x;
            const dy = PLAYER_Y - col.y;
            const dist = Math.sqrt(dx * dx + dy * dy);
            if (dist < 200) {
                col.x += dx * 0.1;
                col.y += dy * 0.1;
            }
        }
        
        if (col.y > canvas.height + 50) {
            collectibles.splice(i, 1);
            continue;
        }
        
        if (checkCollectibleCollision(col)) {
            collectItem(col);
            collectibles.splice(i, 1);
        }
    }
    
    updateHUD();
}

function spawnObstacle() {
    // CRITICAL FIX: Always leave at least 1 lane open
    // Check which lanes are currently dangerous
    const dangerZone = 300; // Pixels from top where cars are "blocking"
    const blockedLanes = new Set();
    
    for (const obs of obstacles) {
        if (obs.y < dangerZone) {
            blockedLanes.add(obs.lane);
        }
    }
    
    // Find safe lanes
    const safeLanes = [0, 1, 2].filter(l => !blockedLanes.has(l));
    
    // If 2+ lanes already blocked, don't spawn more
    if (safeLanes.length <= 1) return;
    
    // Decide how many cars to spawn (1 or 2, never 3)
    // Early game: mostly 1 car. Later: sometimes 2
    const maxCars = distance < 200 ? 1 : (Math.random() < 0.7 ? 1 : 2);
    const numCars = Math.min(maxCars, safeLanes.length - 1); // Always leave 1 safe
    
    // Shuffle safe lanes and pick
    const shuffled = safeLanes.sort(() => Math.random() - 0.5);
    
    for (let i = 0; i < numCars; i++) {
        const lane = shuffled[i];
        obstacles.push({
            lane: lane,
            x: lane * LANE_WIDTH + LANE_WIDTH / 2 - CAR_WIDTH / 2,
            y: -CAR_HEIGHT - (i * 80), // Stagger vertically
            width: CAR_WIDTH,
            height: CAR_HEIGHT,
            speed: 1 + Math.random() * 1.5,
            color: COLORS.obstacle[Math.floor(Math.random() * COLORS.obstacle.length)]
        });
    }
}

function spawnCollectibles(dt) {
    // Coins
    if (Math.random() < 0.01 * (dt / 16)) {
        const lane = Math.floor(Math.random() * 3);
        const blocked = obstacles.some(o => o.lane === lane && o.y < 150);
        if (!blocked) {
            collectibles.push({
                type: 'coin',
                lane: lane,
                x: lane * LANE_WIDTH + LANE_WIDTH / 2,
                y: -30,
                radius: 15
            });
        }
    }
    
    // Power-ups (rarer)
    if (Math.random() < 0.0015 * (dt / 16) && distance > 30) {
        const lane = Math.floor(Math.random() * 3);
        const types = ['shield', 'magnet', 'slow'];
        const type = types[Math.floor(Math.random() * types.length)];
        
        collectibles.push({
            type: type,
            lane: lane,
            x: lane * LANE_WIDTH + LANE_WIDTH / 2,
            y: -30,
            radius: 20
        });
    }
}

function collectItem(item) {
    if (item.type === 'coin') {
        coins++;
    } else if (item.type === 'shield') {
        shield = true;
        shieldTimer = 8000;
        showPowerupIndicator('üõ°Ô∏è', 'Shield Active');
    } else if (item.type === 'magnet') {
        magnet = true;
        magnetTimer = 10000;
        showPowerupIndicator('üß≤', 'Coin Magnet');
    } else if (item.type === 'slow') {
        slowMo = true;
        slowMoTimer = 5000;
        showPowerupIndicator('üê¢', 'Slow Motion');
    }
}

function updatePowerups(dt) {
    if (shield) {
        shieldTimer -= dt;
        if (shieldTimer <= 0) { shield = false; hidePowerupIndicator(); }
    }
    if (magnet) {
        magnetTimer -= dt;
        if (magnetTimer <= 0) { magnet = false; hidePowerupIndicator(); }
    }
    if (slowMo) {
        slowMoTimer -= dt;
        if (slowMoTimer <= 0) { slowMo = false; hidePowerupIndicator(); }
    }
}

function showPowerupIndicator(icon, text) {
    const el = document.getElementById('powerupIndicator');
    document.getElementById('powerupIcon').textContent = icon;
    document.getElementById('powerupText').textContent = text;
    el.classList.add('show');
}

function hidePowerupIndicator() {
    if (!shield && !magnet && !slowMo) {
        document.getElementById('powerupIndicator').classList.remove('show');
    }
}

function checkCollision(obs) {
    const playerX = playerLane * LANE_WIDTH + LANE_WIDTH / 2 - CAR_WIDTH / 2;
    const padding = 10; // Forgiving hitbox
    
    return playerX + padding < obs.x + obs.width - padding &&
           playerX + CAR_WIDTH - padding > obs.x + padding &&
           PLAYER_Y + padding < obs.y + obs.height - padding &&
           PLAYER_Y + CAR_HEIGHT - padding > obs.y + padding;
}

function checkCollectibleCollision(col) {
    const playerX = playerLane * LANE_WIDTH + LANE_WIDTH / 2;
    const playerCenterY = PLAYER_Y + CAR_HEIGHT / 2;
    const dx = playerX - col.x;
    const dy = playerCenterY - col.y;
    return Math.sqrt(dx * dx + dy * dy) < col.radius + 35;
}

function draw() {
    // Road background
    ctx.fillStyle = COLORS.road;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Lane dividers
    ctx.strokeStyle = COLORS.roadLine;
    ctx.lineWidth = 3;
    ctx.setLineDash([40, 20]);
    
    for (let i = 1; i < LANE_COUNT; i++) {
        const x = i * LANE_WIDTH;
        ctx.beginPath();
        ctx.moveTo(x, -60 + roadOffset);
        ctx.lineTo(x, canvas.height);
        ctx.stroke();
    }
    ctx.setLineDash([]);
    
    // Road edges
    const edgeGradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
    edgeGradient.addColorStop(0, 'rgba(79, 172, 254, 0.4)');
    edgeGradient.addColorStop(1, 'rgba(79, 172, 254, 0.1)');
    ctx.fillStyle = edgeGradient;
    ctx.fillRect(0, 0, 5, canvas.height);
    ctx.fillRect(canvas.width - 5, 0, 5, canvas.height);
    
    // Collectibles
    for (const col of collectibles) {
        if (col.type === 'coin') {
            // Coin glow
            ctx.shadowBlur = 15;
            ctx.shadowColor = COLORS.coin;
            ctx.fillStyle = COLORS.coin;
            ctx.beginPath();
            ctx.arc(col.x, col.y, col.radius, 0, Math.PI * 2);
            ctx.fill();
            ctx.shadowBlur = 0;
            
            ctx.fillStyle = '#b8860b';
            ctx.font = 'bold 12px Inter';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('$', col.x, col.y);
        } else {
            const color = col.type === 'shield' ? COLORS.shield : 
                         col.type === 'magnet' ? COLORS.magnet : COLORS.slow;
            const icon = col.type === 'shield' ? 'üõ°Ô∏è' : 
                        col.type === 'magnet' ? 'üß≤' : 'üê¢';
            
            ctx.shadowBlur = 20;
            ctx.shadowColor = color;
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(col.x, col.y, col.radius, 0, Math.PI * 2);
            ctx.fill();
            ctx.shadowBlur = 0;
            
            ctx.font = '18px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(icon, col.x, col.y);
        }
    }
    
    // Enemy cars
    for (const obs of obstacles) {
        drawCar(obs.x, obs.y, obs.width, obs.height, obs.color, false);
    }
    
    // Player car
    const playerX = playerLane * LANE_WIDTH + LANE_WIDTH / 2 - CAR_WIDTH / 2;
    
    // Shield effect
    if (shield) {
        ctx.shadowBlur = 30;
        ctx.shadowColor = '#3b82f6';
        ctx.strokeStyle = 'rgba(59, 130, 246, 0.7)';
        ctx.lineWidth = 4;
        ctx.beginPath();
        ctx.arc(playerX + CAR_WIDTH / 2, PLAYER_Y + CAR_HEIGHT / 2, 55, 0, Math.PI * 2);
        ctx.stroke();
        ctx.shadowBlur = 0;
    }
    
    drawCar(playerX, PLAYER_Y, CAR_WIDTH, CAR_HEIGHT, COLORS.player, true);
}

function drawCar(x, y, w, h, color, isPlayer) {
    // Shadow
    ctx.fillStyle = 'rgba(0,0,0,0.3)';
    ctx.beginPath();
    ctx.ellipse(x + w/2, y + h - 5, w/2 - 5, 10, 0, 0, Math.PI * 2);
    ctx.fill();
    
    // Car body
    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.roundRect(x + 5, y + 10, w - 10, h - 20, 8);
    ctx.fill();
    
    // Roof/cabin
    ctx.fillStyle = isPlayer ? 'rgba(0,0,0,0.3)' : 'rgba(0,0,0,0.4)';
    ctx.beginPath();
    ctx.roundRect(x + 10, y + 20, w - 20, 30, 6);
    ctx.fill();
    
    // Windshield
    ctx.fillStyle = 'rgba(100,200,255,0.4)';
    ctx.beginPath();
    ctx.roundRect(x + 12, isPlayer ? y + 22 : y + h - 40, w - 24, 18, 4);
    ctx.fill();
    
    // Headlights/taillights
    ctx.fillStyle = isPlayer ? '#fff' : '#ef4444';
    ctx.shadowBlur = isPlayer ? 10 : 8;
    ctx.shadowColor = isPlayer ? '#fff' : '#ef4444';
    ctx.beginPath();
    ctx.arc(x + 14, isPlayer ? y + h - 10 : y + 12, 5, 0, Math.PI * 2);
    ctx.arc(x + w - 14, isPlayer ? y + h - 10 : y + 12, 5, 0, Math.PI * 2);
    ctx.fill();
    ctx.shadowBlur = 0;
    
    // Racing stripe for player
    if (isPlayer) {
        ctx.fillStyle = COLORS.playerAccent;
        ctx.fillRect(x + w/2 - 4, y + 12, 8, h - 24);
    }
}

function updateHUD() {
    document.getElementById('score').textContent = score.toLocaleString();
    document.getElementById('coins').textContent = coins;
    document.getElementById('speed').textContent = Math.floor(speed);
}

function gameOver() {
    gameRunning = false;
    cancelAnimationFrame(animFrame);
    
    const isNewBest = score > highScore;
    if (isNewBest) {
        highScore = score;
        localStorage.setItem('highway_dodge_high', score.toString());
    }
    
    document.getElementById('finalScore').textContent = score.toLocaleString();
    document.getElementById('finalCoins').textContent = coins;
    document.getElementById('finalDistance').textContent = Math.floor(distance) + 'm';
    document.getElementById('finalSpeed').textContent = Math.floor(maxSpeed) + ' mph';
    document.getElementById('newBest').classList.toggle('show', isNewBest);
    
    document.getElementById('gameOver').classList.add('show');
    
    submitScore();
}

async function submitScore() {
    try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (!session) return;
        
        await supabaseClient.from('solo_scores').upsert({
            user_id: session.user.id,
            game_id: 'highway-dodge',
            score: score,
            metadata: { coins, distance: Math.floor(distance), maxSpeed: Math.floor(maxSpeed) }
        }, { onConflict: 'user_id,game_id' });
    } catch (e) {
        console.log('Score submission:', e);
    }
}

function goToLeaderboard() {
    window.location.href = '/leaderboards?game=highway-dodge';
}

// Controls
function moveLeft() { if (playerLane > 0) playerLane--; }
function moveRight() { if (playerLane < 2) playerLane++; }

document.addEventListener('keydown', (e) => {
    if (!gameRunning) return;
    if (e.key === 'ArrowLeft' || e.key === 'a') moveLeft();
    if (e.key === 'ArrowRight' || e.key === 'd') moveRight();
});

let touchStartX = 0;
canvas.addEventListener('touchstart', (e) => {
    e.preventDefault();
    touchStartX = e.touches[0].clientX;
}, { passive: false });

canvas.addEventListener('touchend', (e) => {
    e.preventDefault();
    const touchEndX = e.changedTouches[0].clientX;
    const diff = touchEndX - touchStartX;
    
    if (Math.abs(diff) > 30) {
        if (diff > 0) moveRight();
        else moveLeft();
    } else {
        const rect = canvas.getBoundingClientRect();
        const tapX = touchEndX - rect.left;
        if (tapX < canvas.width / 3) moveLeft();
        else if (tapX > canvas.width * 2 / 3) moveRight();
    }
}, { passive: false });

canvas.addEventListener('click', (e) => {
    if (!gameRunning) return;
    const rect = canvas.getBoundingClientRect();
    const clickX = e.clientX - rect.left;
    if (clickX < canvas.width / 3) moveLeft();
    else if (clickX > canvas.width * 2 / 3) moveRight();
});

document.getElementById('startScreen').addEventListener('click', (e) => {
    if (e.target.tagName !== 'BUTTON') startGame();
});
</script>

<script src="/header.js"></script>
</body>
</html>
