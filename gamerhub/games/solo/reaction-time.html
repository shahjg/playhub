<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reaction Time Test | TheGaming.co</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --teal: #00d9a5;
            --red: #ff4757;
            --dark: #0a0a0f;
            --text-light: #ffffff;
            --game-bg: #1a1a2e;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--dark);
            color: var(--text-light);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* NAVIGATION */
        .game-nav {
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.03);
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .back-link { 
            color: rgba(255,255,255,0.6); 
            text-decoration: none; 
            font-weight: 600; 
            font-size: 0.9rem; 
            display: flex;
            align-items: center;
            gap: 8px;
            transition: color 0.2s;
        }
        .back-link:hover { color: var(--teal); }

        .game-title-nav {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.4rem;
            letter-spacing: 1px;
        }

        /* GAME AREA */
        .game-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .click-area {
            width: 100%;
            max-width: 600px;
            height: 400px;
            background: #2a2a3d;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.1s ease;
            user-select: none;
            position: relative;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            border: 2px solid rgba(255,255,255,0.05);
            text-align: center;
            padding: 20px;
        }

        /* GAME STATES */
        .click-area.waiting { background: var(--red); box-shadow: 0 0 50px rgba(255, 71, 87, 0.3); }
        .click-area.go { background: var(--teal); box-shadow: 0 0 50px rgba(0, 217, 165, 0.4); }
        
        .click-icon { font-size: 4rem; margin-bottom: 20px; }
        .click-text { font-family: 'Bebas Neue', sans-serif; font-size: 3.5rem; letter-spacing: 2px; line-height: 1; margin-bottom: 10px; }
        .click-sub { font-size: 1.1rem; opacity: 0.7; }

        /* RESULTS & SAVE */
        .result-panel {
            margin-top: 30px;
            text-align: center;
            display: none; /* Hidden by default */
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

        .score-display { font-size: 3rem; font-family: 'Bebas Neue', sans-serif; color: var(--teal); margin-bottom: 20px; }

        .btn {
            padding: 14px 32px;
            border-radius: 50px;
            border: none;
            font-weight: 700;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .btn-primary { 
            background: white; 
            color: var(--dark); 
            box-shadow: 0 5px 20px rgba(255,255,255,0.2);
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(255,255,255,0.3); }
        .btn-primary:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }

        /* LEADERBOARD SECTION */
        .leaderboard-section {
            width: 100%;
            max-width: 500px;
            margin-top: 50px;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 25px;
        }

        .lb-header { 
            font-family: 'Bebas Neue', sans-serif; 
            font-size: 1.4rem; 
            margin-bottom: 20px; 
            color: rgba(255,255,255,0.9); 
            text-align: center;
            letter-spacing: 1px;
        }
        
        .lb-list { display: flex; flex-direction: column; gap: 8px; }

        .lb-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            font-size: 0.95rem;
        }
        
        .lb-row.top-rank { background: linear-gradient(90deg, rgba(0, 217, 165, 0.1), transparent); border: 1px solid rgba(0, 217, 165, 0.2); }

        .lb-rank { width: 30px; font-weight: 700; color: rgba(255,255,255,0.4); }
        .lb-name { flex: 1; font-weight: 600; color: white; }
        .lb-score { color: var(--teal); font-weight: 700; font-family: 'monospace'; font-size: 1.1rem; }

        /* MOBILE TWEAKS */
        @media (max-width: 600px) {
            .click-text { font-size: 2.5rem; }
            .click-area { height: 350px; }
            .lb-name { max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        }

    </style>
</head>
<body>

    <nav class="game-nav">
        <a href="/solo.html" class="back-link">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            BACK TO MENU
        </a>
        <div class="game-title-nav">REACTION TIME</div>
        <div style="width: 80px;"></div> </nav>

    <div class="game-container">
        
        <div id="game-board" class="click-area" onmousedown="handleGameClick()" ontouchstart="handleGameClick()">
            <div class="click-icon">‚ö°</div>
            <div class="click-text" id="status-text">CLICK TO START</div>
            <div class="click-sub" id="sub-text">Wait for green, then click instantly.</div>
        </div>

        <div class="result-panel" id="result-panel">
            <div class="score-display" id="final-score">0 ms</div>
            <button class="btn btn-primary" id="save-btn" onclick="saveScore()">SAVE TO LEADERBOARD</button>
            <p id="login-warning" style="font-size:0.85rem; color:rgba(255,255,255,0.5); margin-top:15px; display:none;">
                <a href="/login.html" style="color:var(--teal); text-decoration:underline;">Sign In</a> to save your score
            </p>
        </div>

        <div class="leaderboard-section">
            <div class="lb-header">üèÜ TOP 5 PLAYERS</div>
            <div id="lb-list" class="lb-list">
                <div class="lb-row"><span style="opacity:0.5; width:100%; text-align:center;">Loading scores...</span></div>
            </div>
        </div>
    </div>

<script>
    // --- 1. CONFIG & SUPABASE ---
    const GAME_ID = 'reaction-time';
    const SUPABASE_URL = 'https://tvvivtmzofsyehatzlvl.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR2dml2dG16b2ZzeWVoYXR6bHZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4OTExODYsImV4cCI6MjA4MDQ2NzE4Nn0.Qy8kHMO0Nb4yJ0ZHjby7RuQtzwWB8rUcZvkdnbL1b3M';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- 2. GAME VARIABLES ---
    let state = 'idle'; // idle, waiting, green, result
    let startTime = 0;
    let timerId = null;
    let currentScore = 0;
    let currentUser = null;

    const board = document.getElementById('game-board');
    const statusText = document.getElementById('status-text');
    const subText = document.getElementById('sub-text');
    const resultPanel = document.getElementById('result-panel');
    const scoreDisplay = document.getElementById('final-score');
    const saveBtn = document.getElementById('save-btn');
    const loginWarning = document.getElementById('login-warning');

    // --- 3. GAME LOGIC ---
    function handleGameClick(e) {
        if(e) e.preventDefault(); // Prevent double firing on touch devices

        if (state === 'idle' || state === 'result') {
            startGame();
        } else if (state === 'waiting') {
            tooEarly();
        } else if (state === 'green') {
            endGame();
        }
    }

    function startGame() {
        state = 'waiting';
        resultPanel.style.display = 'none';
        
        board.className = 'click-area waiting';
        statusText.textContent = "WAIT FOR GREEN...";
        subText.textContent = "Don't click yet!";
        
        // Random time between 2s and 5s
        const randomTime = Math.floor(Math.random() * 3000) + 2000;
        
        timerId = setTimeout(() => {
            state = 'green';
            board.className = 'click-area go';
            statusText.textContent = "CLICK NOW!";
            subText.textContent = "";
            startTime = Date.now();
        }, randomTime);
    }

    function tooEarly() {
        clearTimeout(timerId);
        state = 'result';
        board.className = 'click-area';
        statusText.textContent = "TOO SOON!";
        subText.textContent = "You clicked before it turned green.";
        
        // No save button for failure
        resultPanel.style.display = 'none'; 
        
        // Brief timeout before letting them try again so they don't spam click
        setTimeout(() => {
            subText.textContent = "Click anywhere to try again";
        }, 500);
    }

    function endGame() {
        const endTime = Date.now();
        currentScore = endTime - startTime;
        state = 'result';
        
        board.className = 'click-area';
        statusText.textContent = `${currentScore} ms`;
        subText.textContent = "Click to try again";
        
        // Show Save UI
        resultPanel.style.display = 'block';
        scoreDisplay.textContent = `${currentScore} ms`;
        
        checkAuthForButton();
    }

    // --- 4. SUPABASE LOGIC ---

    async function checkAuthForButton() {
        const { data } = await supabase.auth.getSession();
        currentUser = data.session?.user;

        if (currentUser) {
            saveBtn.style.display = 'inline-block';
            loginWarning.style.display = 'none';
            saveBtn.textContent = 'SAVE SCORE TO LEADERBOARD';
            saveBtn.disabled = false;
        } else {
            saveBtn.style.display = 'none';
            loginWarning.style.display = 'block';
        }
    }

    async function saveScore() {
        if (!currentUser) return;
        saveBtn.textContent = 'SAVING...';
        saveBtn.disabled = true;

        const { error } = await supabase
            .from('solo_scores')
            .insert({
                user_id: currentUser.id,
                game_id: GAME_ID,
                score: currentScore
            });

        if (error) {
            console.error(error);
            alert('Error saving score. Make sure you ran the SQL script in Supabase!');
            saveBtn.textContent = 'ERROR';
            saveBtn.disabled = false;
        } else {
            saveBtn.textContent = 'SAVED!';
            fetchLeaderboard(); // Refresh list immediately
        }
    }

    async function fetchLeaderboard() {
        const lbList = document.getElementById('lb-list');
        
        // Fetch top 5 scores, joined with profile data
        const { data, error } = await supabase
            .from('solo_scores')
            .select(`
                score,
                profiles (display_name, gamer_tag)
            `)
            .eq('game_id', GAME_ID)
            .order('score', { ascending: true }) // Lower is better
            .limit(5);

        if (error) {
            console.error('Leaderboard error:', error);
            return;
        }

        lbList.innerHTML = '';
        if (data.length === 0) {
            lbList.innerHTML = '<div class="lb-row"><span style="width:100%; text-align:center; opacity:0.5;">No scores yet. Be the first!</span></div>';
            return;
        }

        data.forEach((entry, index) => {
            // Prefer display_name, fallback to gamer_tag, then anonymous
            const name = entry.profiles?.display_name || entry.profiles?.gamer_tag || 'Anonymous Player';
            const isTop = index === 0;
            
            const html = `
                <div class="lb-row ${isTop ? 'top-rank' : ''}">
                    <span class="lb-rank">#${index + 1}</span>
                    <span class="lb-name">${name}</span>
                    <span class="lb-score">${entry.score} ms</span>
                </div>
            `;
            lbList.insertAdjacentHTML('beforeend', html);
        });
    }

    // Init
    checkAuthForButton();
    fetchLeaderboard();

</script>
</body>
</html>
