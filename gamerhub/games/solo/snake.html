<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>Snake ‚Äì Classic Arcade Game | TheGaming.co</title>
    <meta name="description" content="Play the classic Snake game. Eat food, grow longer, don't crash. Free with global leaderboards.">
    <meta name="theme-color" content="#0a0a0f">
    <link rel="stylesheet" href="/header.css">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{
            --accent:#22c55e;--accent-dark:#16a34a;--accent-light:#dcfce7;
            --pink:#ff6b9d;--blue:#4facfe;--purple:#a855f7;
            --gold:#ffd700;--text-dark:#1a1a2e;--text-muted:#6b7280;
        }
        html,body{
            overscroll-behavior:none;
            touch-action:pan-x pan-y;
        }
        body{font-family:'Inter',sans-serif;background:linear-gradient(135deg,#dcfce7 0%,#bbf7d0 50%,#f0fdf4 100%);color:var(--text-dark);min-height:100vh;min-height:100dvh;display:flex;flex-direction:column;overflow-x:hidden}
        h1,h2,h3,h4{font-family:'Bebas Neue',sans-serif;letter-spacing:1px}
        a{color:inherit;text-decoration:none}

        main{flex:1;display:flex;flex-direction:column;padding-top:60px}
        .game-hero{background:radial-gradient(circle at 10% 0%,#166534 0%,#14532d 50%,#052e16 100%);padding:35px 20px;text-align:center;position:relative;overflow:hidden}
        .game-hero::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at 30% 20%,rgba(34,197,94,0.3) 0%,transparent 55%)}
        .game-hero-content{position:relative;z-index:1;max-width:600px;margin:0 auto}
        .game-icon{width:50px;height:50px;margin:0 auto 12px;animation:iconFloat 3s ease-in-out infinite}
        @keyframes iconFloat{0%,100%{transform:translateY(0) rotate(-2deg)}50%{transform:translateY(-8px) rotate(2deg)}}
        .game-hero-title{font-size:clamp(2.2rem,8vw,3.5rem);line-height:0.95;margin-bottom:6px;background:linear-gradient(135deg,#fff,var(--accent-light),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:3px}
        .game-hero-desc{font-size:0.85rem;color:rgba(255,255,255,0.7)}

        .game-wrapper{flex:1;display:flex;flex-direction:column;align-items:center;padding:25px 15px 40px}
        .game-container{width:100%;max-width:420px;display:flex;flex-direction:column;gap:16px}

        .stats-bar{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
        .stat-card{background:#fff;border:2px solid rgba(34,197,94,0.15);border-radius:14px;padding:10px 8px;text-align:center;box-shadow:0 2px 12px rgba(34,197,94,0.08)}
        .stat-label{font-size:0.6rem;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:2px}
        .stat-value{font-family:'Bebas Neue',sans-serif;font-size:1.4rem;letter-spacing:1px;color:var(--accent)}
        .stat-value.best{color:var(--gold)}

        .game-board{background:#fff;border-radius:20px;border:3px solid rgba(34,197,94,0.2);padding:16px;box-shadow:0 8px 30px rgba(34,197,94,0.12);display:flex;flex-direction:column;align-items:center}
        
        .canvas-wrapper{
            position:relative;
            background:#0d1f17;
            border-radius:12px;
            overflow:hidden;
            touch-action:none;
            -webkit-touch-callout:none;
            -webkit-user-select:none;
            user-select:none;
        }
        #canvas{display:block;border-radius:10px}
        
        .game-overlay{position:absolute;inset:0;background:rgba(0,0,0,0.88);display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:20px;border-radius:12px;backdrop-filter:blur(4px)}
        .game-overlay.hidden{display:none}
        .overlay-title{font-family:'Bebas Neue',sans-serif;font-size:2.2rem;letter-spacing:3px;color:#fff;margin-bottom:6px}
        .overlay-title.gameover{color:#ef4444}
        .overlay-title.start{background:linear-gradient(135deg,#fff,var(--accent-light),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .overlay-score{font-family:'Bebas Neue',sans-serif;font-size:3.5rem;color:var(--gold);margin:12px 0}
        .overlay-text{color:rgba(255,255,255,0.6);font-size:0.85rem;margin-bottom:16px}
        .new-best{color:var(--gold);font-weight:700;margin-bottom:10px}
        .btn{padding:14px 28px;border-radius:50px;border:none;font-weight:700;font-size:0.95rem;cursor:pointer;transition:all 0.3s;text-transform:uppercase;letter-spacing:1px;font-family:'Inter',sans-serif}
        .btn-primary{background:linear-gradient(135deg,var(--accent),var(--accent-dark));color:#fff;box-shadow:0 6px 20px rgba(34,197,94,0.3)}
        .btn-primary:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(34,197,94,0.4)}
        .btn-secondary{background:#fff;color:var(--text-dark);border:2px solid rgba(34,197,94,0.3);margin-top:10px}

        /* Mobile D-Pad Controls - Always Visible */
        .mobile-controls{
            display:none;
            margin-top:16px;
            touch-action:manipulation;
        }
        @media(hover:none)and(pointer:coarse){
            .mobile-controls{display:block}
        }
        
        .dpad{
            display:grid;
            grid-template-columns:70px 70px 70px;
            grid-template-rows:70px 70px 70px;
            gap:4px;
            justify-content:center;
        }
        .dpad-btn{
            border-radius:12px;
            background:linear-gradient(145deg,rgba(34,197,94,0.2),rgba(34,197,94,0.1));
            border:3px solid rgba(34,197,94,0.3);
            color:var(--accent);
            cursor:pointer;
            display:flex;
            align-items:center;
            justify-content:center;
            transition:all 0.1s;
            -webkit-tap-highlight-color:transparent;
        }
        .dpad-btn:active{
            background:rgba(34,197,94,0.4);
            transform:scale(0.95);
            border-color:var(--accent);
        }
        .dpad-btn svg{width:32px;height:32px;stroke:currentColor;fill:none;stroke-width:2.5}
        .dpad-center{
            background:linear-gradient(145deg,rgba(34,197,94,0.08),rgba(34,197,94,0.04));
            border:2px dashed rgba(34,197,94,0.2);
            border-radius:50%;
        }
        .dpad-empty{background:transparent;border:none}
        
        .controls-hint{
            text-align:center;
            font-size:0.7rem;
            color:var(--text-muted);
            margin-top:8px;
        }

        .leaderboard-section{background:#fff;border:2px solid rgba(34,197,94,0.2);border-radius:18px;padding:18px;box-shadow:0 8px 30px rgba(34,197,94,0.12)}
        .lb-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;padding-bottom:10px;border-bottom:2px solid rgba(34,197,94,0.15);flex-wrap:wrap;gap:10px}
        .lb-title{font-family:'Bebas Neue',sans-serif;font-size:1.3rem;letter-spacing:2px}
        .lb-tabs{display:flex;gap:5px;background:rgba(34,197,94,0.08);padding:3px;border-radius:10px}
        .lb-tab{padding:6px 12px;border-radius:7px;font-size:0.7rem;font-weight:600;text-transform:uppercase;cursor:pointer;color:var(--text-muted);background:transparent;border:none}
        .lb-tab:hover{color:var(--accent)}
        .lb-tab.active{background:#fff;color:var(--accent);box-shadow:0 2px 8px rgba(34,197,94,0.15)}
        .lb-list{display:flex;flex-direction:column;gap:5px}
        .lb-row{display:flex;align-items:center;gap:10px;padding:8px 12px;background:rgba(34,197,94,0.05);border-radius:10px}
        .lb-row:hover{background:rgba(34,197,94,0.1)}
        .lb-row.top-1{background:linear-gradient(90deg,rgba(255,215,0,0.15),rgba(255,215,0,0.05));border:2px solid rgba(255,215,0,0.4)}
        .lb-row.top-2{background:linear-gradient(90deg,rgba(192,192,192,0.12),rgba(192,192,192,0.04));border:2px solid rgba(192,192,192,0.3)}
        .lb-row.top-3{background:linear-gradient(90deg,rgba(205,127,50,0.12),rgba(205,127,50,0.04));border:2px solid rgba(205,127,50,0.3)}
        .lb-rank{font-family:'Bebas Neue',sans-serif;font-size:1.1rem;width:28px;text-align:center;color:var(--text-muted)}
        .lb-row.top-1 .lb-rank{color:#ffd700}
        .lb-row.top-2 .lb-rank{color:#c0c0c0}
        .lb-row.top-3 .lb-rank{color:#cd7f32}
        .lb-name{flex:1;font-weight:600;font-size:0.8rem}
        .lb-score{font-family:'Bebas Neue',sans-serif;font-size:1.1rem;color:var(--accent)}
        .lb-empty{text-align:center;padding:20px;color:var(--text-muted);font-size:0.8rem}
    </style>
</head>
<body>
    <div id="site-header"></div>

    <main>
        <section class="game-hero">
            <div class="game-hero-content">
                <div class="game-icon">
                    <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                        <rect x="8" y="28" width="10" height="10" rx="2" fill="#22c55e"/>
                        <rect x="18" y="28" width="10" height="10" rx="2" fill="#22c55e"/>
                        <rect x="28" y="28" width="10" height="10" rx="2" fill="#22c55e"/>
                        <rect x="38" y="28" width="10" height="10" rx="2" fill="#22c55e"/>
                        <rect x="38" y="18" width="10" height="10" rx="2" fill="#22c55e"/>
                        <rect x="48" y="18" width="10" height="10" rx="2" fill="#16a34a"/>
                        <circle cx="53" cy="21" r="2" fill="#fff"/>
                        <circle cx="53" cy="27" r="2" fill="#fff"/>
                        <circle cx="20" cy="48" r="6" fill="#ef4444"/>
                    </svg>
                </div>
                <h1 class="game-hero-title">SNAKE</h1>
                <p class="game-hero-desc">Eat food, grow longer, don't crash!</p>
            </div>
        </section>

        <div class="game-wrapper">
            <div class="game-container">
                <div class="stats-bar">
                    <div class="stat-card"><div class="stat-label">Score</div><div class="stat-value" id="score">0</div></div>
                    <div class="stat-card"><div class="stat-label">Length</div><div class="stat-value" id="length">3</div></div>
                    <div class="stat-card"><div class="stat-label">Best</div><div class="stat-value best" id="best">0</div></div>
                </div>

                <div class="game-board">
                    <div class="canvas-wrapper" id="canvas-wrapper">
                        <canvas id="canvas" width="320" height="320"></canvas>
                        <div class="game-overlay" id="start-overlay">
                            <h2 class="overlay-title start">SNAKE</h2>
                            <p class="overlay-text">Arrow keys or D-pad to move</p>
                            <button class="btn btn-primary" id="start-btn">START GAME</button>
                        </div>
                        <div class="game-overlay hidden" id="gameover-overlay">
                            <h2 class="overlay-title gameover">GAME OVER</h2>
                            <div class="new-best" id="new-best" style="display:none">üèÜ NEW HIGH SCORE!</div>
                            <div class="overlay-score" id="final-score">0</div>
                            <button class="btn btn-primary" id="restart-btn">PLAY AGAIN</button>
                            <button class="btn btn-secondary" id="share-btn">SHARE</button>
                        </div>
                    </div>
                    
                    <div class="mobile-controls" id="mobile-controls">
                        <div class="dpad">
                            <div class="dpad-empty"></div>
                            <button class="dpad-btn" id="btn-up">
                                <svg viewBox="0 0 24 24"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
                            </button>
                            <div class="dpad-empty"></div>
                            <button class="dpad-btn" id="btn-left">
                                <svg viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                            </button>
                            <div class="dpad-center"></div>
                            <button class="dpad-btn" id="btn-right">
                                <svg viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                            </button>
                            <div class="dpad-empty"></div>
                            <button class="dpad-btn" id="btn-down">
                                <svg viewBox="0 0 24 24"><path d="M12 5v14M5 12l7 7 7-7"/></svg>
                            </button>
                            <div class="dpad-empty"></div>
                        </div>
                        <p class="controls-hint">Tap direction or swipe on game</p>
                    </div>
                </div>

                <div class="leaderboard-section">
                    <div class="lb-header">
                        <h3 class="lb-title">üèÜ Leaderboard</h3>
                        <div class="lb-tabs">
                            <button class="lb-tab active" data-tab="global">Global</button>
                            <button class="lb-tab" data-tab="today">Today</button>
                            <button class="lb-tab" data-tab="friends">Friends</button>
                        </div>
                    </div>
                    <div class="lb-list" id="lb-list"><div class="lb-empty">Loading...</div></div>
                </div>
            </div>
        </div>
    </main>

<script>
const SUPABASE_URL='https://tvvivtmzofsyehatzlvl.supabase.co';
const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR2dml2dG16b2ZzeWVoYXR6bHZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4OTExODYsImV4cCI6MjA4MDQ2NzE4Nn0.Qy8kHMO0Nb4yJ0ZHjby7RuQtzwWB8rUcZvkdnbL1b3M';
const supabaseClient=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
const GRID=16;
const CELL=canvas.width/GRID;

let snake=[];
let food={};
let direction={x:1,y:0};
let nextDir={x:1,y:0};
let score=0;
let gameLoop=null;
let gameRunning=false;
let currentUserId=null;
let personalBest=0;
let friendIds=[];
let currentTab='global';

async function loadAuth(){
    const{data}=await supabaseClient.auth.getSession();
    const user=data?.session?.user;
    if(user){
        currentUserId=user.id;
        loadPersonalBest();
        loadFriends();
    }
    fetchLeaderboard('global');
}

async function loadPersonalBest(){
    if(!currentUserId)return;
    const{data}=await supabaseClient.from('solo_scores').select('score').eq('user_id',currentUserId).eq('game_id','snake').order('score',{ascending:false}).limit(1).single();
    if(data){personalBest=data.score;document.getElementById('best').textContent=personalBest}
}

async function loadFriends(){
    if(!currentUserId)return;
    try{
        const{data}=await supabaseClient.from('friendships').select('user_id,friend_id').or(`user_id.eq.${currentUserId},friend_id.eq.${currentUserId}`).eq('status','accepted');
        if(data)friendIds=data.map(f=>f.user_id===currentUserId?f.friend_id:f.user_id);
    }catch(e){}
}

function initGame(){
    snake=[{x:8,y:8},{x:7,y:8},{x:6,y:8}];
    direction={x:1,y:0};
    nextDir={x:1,y:0};
    score=0;
    document.getElementById('score').textContent='0';
    document.getElementById('length').textContent='3';
    spawnFood();
}

function spawnFood(){
    do{
        food={x:Math.floor(Math.random()*GRID),y:Math.floor(Math.random()*GRID)};
    }while(snake.some(s=>s.x===food.x&&s.y===food.y));
}

function draw(){
    // Clear with dark background
    ctx.fillStyle='#0d1f17';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    
    // Draw subtle grid
    ctx.strokeStyle='rgba(34,197,94,0.08)';
    ctx.lineWidth=1;
    for(let i=0;i<=GRID;i++){
        ctx.beginPath();
        ctx.moveTo(i*CELL,0);
        ctx.lineTo(i*CELL,canvas.height);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(0,i*CELL);
        ctx.lineTo(canvas.width,i*CELL);
        ctx.stroke();
    }
    
    // Draw food with glow
    ctx.shadowColor='#ef4444';
    ctx.shadowBlur=15;
    ctx.fillStyle='#ef4444';
    ctx.beginPath();
    ctx.arc(food.x*CELL+CELL/2,food.y*CELL+CELL/2,CELL/2-3,0,Math.PI*2);
    ctx.fill();
    ctx.shadowBlur=0;
    
    // Draw snake with gradient
    snake.forEach((seg,i)=>{
        const gradient=ctx.createRadialGradient(
            seg.x*CELL+CELL/2,seg.y*CELL+CELL/2,0,
            seg.x*CELL+CELL/2,seg.y*CELL+CELL/2,CELL/2
        );
        if(i===0){
            // Head - brighter
            gradient.addColorStop(0,'#4ade80');
            gradient.addColorStop(1,'#22c55e');
        }else{
            // Body - slightly darker towards tail
            const fade=1-i/snake.length*0.3;
            gradient.addColorStop(0,`rgba(34,197,94,${fade})`);
            gradient.addColorStop(1,`rgba(22,163,74,${fade})`);
        }
        ctx.fillStyle=gradient;
        ctx.beginPath();
        ctx.roundRect(seg.x*CELL+2,seg.y*CELL+2,CELL-4,CELL-4,4);
        ctx.fill();
        
        // Eyes on head
        if(i===0){
            ctx.fillStyle='#fff';
            const eyeOffset=direction.x!==0?4:6;
            const eyeY=direction.y===1?8:direction.y===-1?12:10;
            ctx.beginPath();
            ctx.arc(seg.x*CELL+6,seg.y*CELL+eyeY,2,0,Math.PI*2);
            ctx.arc(seg.x*CELL+CELL-6,seg.y*CELL+eyeY,2,0,Math.PI*2);
            ctx.fill();
        }
    });
}

function update(){
    direction=nextDir;
    const head={x:snake[0].x+direction.x,y:snake[0].y+direction.y};
    
    // Wall collision
    if(head.x<0||head.x>=GRID||head.y<0||head.y>=GRID){
        gameOver();
        return;
    }
    
    // Self collision
    if(snake.some(s=>s.x===head.x&&s.y===head.y)){
        gameOver();
        return;
    }
    
    snake.unshift(head);
    
    // Eat food
    if(head.x===food.x&&head.y===food.y){
        score+=10;
        document.getElementById('score').textContent=score;
        document.getElementById('length').textContent=snake.length;
        spawnFood();
    }else{
        snake.pop();
    }
    
    draw();
}

function gameOver(){
    gameRunning=false;
    clearInterval(gameLoop);
    
    document.getElementById('final-score').textContent=score;
    const isNew=score>personalBest;
    document.getElementById('new-best').style.display=isNew?'block':'none';
    
    if(isNew){
        personalBest=score;
        document.getElementById('best').textContent=personalBest;
    }
    
    document.getElementById('gameover-overlay').classList.remove('hidden');
    saveScore();
}

async function saveScore(){
    if(!currentUserId||score===0)return;
    await supabaseClient.from('solo_scores').insert({user_id:currentUserId,game_id:'snake',score:score});
    fetchLeaderboard(currentTab);
}

function startGame(){
    document.getElementById('start-overlay').classList.add('hidden');
    document.getElementById('gameover-overlay').classList.add('hidden');
    initGame();
    draw();
    gameRunning=true;
    gameLoop=setInterval(update,120);
}

// Button handlers
document.getElementById('start-btn').addEventListener('click',startGame);
document.getElementById('restart-btn').addEventListener('click',startGame);
document.getElementById('share-btn').addEventListener('click',()=>{
    const t=`üêç Snake - TheGaming.co\nüèÜ Score: ${score}\nüìè Length: ${snake.length}\n\nthegaming.co/games/solo/snake.html`;
    navigator.share?navigator.share({text:t}):navigator.clipboard.writeText(t);
});

// Keyboard controls
document.addEventListener('keydown',e=>{
    if(!gameRunning)return;
    if(e.key==='ArrowUp'&&direction.y!==1){nextDir={x:0,y:-1};e.preventDefault()}
    else if(e.key==='ArrowDown'&&direction.y!==-1){nextDir={x:0,y:1};e.preventDefault()}
    else if(e.key==='ArrowLeft'&&direction.x!==1){nextDir={x:-1,y:0};e.preventDefault()}
    else if(e.key==='ArrowRight'&&direction.x!==-1){nextDir={x:1,y:0};e.preventDefault()}
});

// D-Pad controls
function setDirection(x,y){
    if(!gameRunning)return;
    if(x===0&&y===-1&&direction.y!==1)nextDir={x:0,y:-1};
    else if(x===0&&y===1&&direction.y!==-1)nextDir={x:0,y:1};
    else if(x===-1&&y===0&&direction.x!==1)nextDir={x:-1,y:0};
    else if(x===1&&y===0&&direction.x!==-1)nextDir={x:1,y:0};
}

document.getElementById('btn-up').addEventListener('click',e=>{e.preventDefault();setDirection(0,-1)});
document.getElementById('btn-down').addEventListener('click',e=>{e.preventDefault();setDirection(0,1)});
document.getElementById('btn-left').addEventListener('click',e=>{e.preventDefault();setDirection(-1,0)});
document.getElementById('btn-right').addEventListener('click',e=>{e.preventDefault();setDirection(1,0)});

// Touch support for D-pad (touchstart for faster response)
document.getElementById('btn-up').addEventListener('touchstart',e=>{e.preventDefault();setDirection(0,-1)},{passive:false});
document.getElementById('btn-down').addEventListener('touchstart',e=>{e.preventDefault();setDirection(0,1)},{passive:false});
document.getElementById('btn-left').addEventListener('touchstart',e=>{e.preventDefault();setDirection(-1,0)},{passive:false});
document.getElementById('btn-right').addEventListener('touchstart',e=>{e.preventDefault();setDirection(1,0)},{passive:false});

// Swipe controls on canvas - PREVENT SCROLL
const canvasWrapper=document.getElementById('canvas-wrapper');
let touchStartX=0,touchStartY=0;

canvasWrapper.addEventListener('touchstart',e=>{
    touchStartX=e.touches[0].clientX;
    touchStartY=e.touches[0].clientY;
    e.preventDefault();
},{passive:false});

canvasWrapper.addEventListener('touchmove',e=>{
    e.preventDefault();
},{passive:false});

canvasWrapper.addEventListener('touchend',e=>{
    if(!gameRunning)return;
    const dx=e.changedTouches[0].clientX-touchStartX;
    const dy=e.changedTouches[0].clientY-touchStartY;
    
    if(Math.abs(dx)>Math.abs(dy)){
        if(dx>25&&direction.x!==1)nextDir={x:1,y:0};
        else if(dx<-25&&direction.x!==-1)nextDir={x:-1,y:0};
    }else{
        if(dy>25&&direction.y!==1)nextDir={x:0,y:1};
        else if(dy<-25&&direction.y!==-1)nextDir={x:0,y:-1};
    }
    e.preventDefault();
},{passive:false});

// Leaderboard
document.querySelectorAll('.lb-tab').forEach(tab=>{
    tab.addEventListener('click',()=>{
        document.querySelectorAll('.lb-tab').forEach(t=>t.classList.remove('active'));
        tab.classList.add('active');
        currentTab=tab.dataset.tab;
        fetchLeaderboard(currentTab);
    });
});

async function fetchLeaderboard(tab){
    const lbList=document.getElementById('lb-list');
    lbList.innerHTML='<div class="lb-empty">Loading...</div>';
    
    let query=supabaseClient.from('solo_scores').select('score,user_id,created_at').eq('game_id','snake').order('score',{ascending:false}).limit(50);
    
    if(tab==='today'){
        const t=new Date();t.setHours(0,0,0,0);
        query=query.gte('created_at',t.toISOString());
    }else if(tab==='friends'){
        if(!friendIds.length){lbList.innerHTML='<div class="lb-empty">Add friends to see scores</div>';return}
        query=query.in('user_id',[...friendIds,currentUserId]);
    }
    
    const{data,error}=await query;
    if(error||!data?.length){lbList.innerHTML='<div class="lb-empty">No scores yet</div>';return}
    
    const best=new Map();
    data.forEach(e=>{if(!best.has(e.user_id)||e.score>best.get(e.user_id).score)best.set(e.user_id,e)});
    const deduped=Array.from(best.values()).sort((a,b)=>b.score-a.score);
    
    const userIds=[...new Set(deduped.map(e=>e.user_id))];
    const{data:profiles}=await supabaseClient.from('profiles').select('id,display_name,gamer_tag').in('id',userIds);
    const pm={};profiles?.forEach(p=>pm[p.id]=p);
    
    lbList.innerHTML='';
    deduped.slice(0,10).forEach((e,i)=>{
        const p=pm[e.user_id];
        const name=p?.display_name||p?.gamer_tag||'Anonymous';
        const topClass=i===0?'top-1':i===1?'top-2':i===2?'top-3':'';
        const row=document.createElement('div');
        row.className=`lb-row ${topClass}`;
        row.innerHTML=`<div class="lb-rank">${i+1}</div><div class="lb-name">${name}</div><div class="lb-score">${e.score}</div>`;
        lbList.appendChild(row);
    });
}

loadAuth();
draw();
fetchLeaderboard('global');
</script>
<script src="/header.js"></script>
</body>
</html>
