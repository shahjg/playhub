<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>Block Stack ‚Äì Free Falling Block Puzzle | TheGaming.co</title>
    <meta name="description" content="Classic falling block puzzle game. Stack blocks, clear lines, beat high scores.">
    <meta name="theme-color" content="#0a0a0f">
    <link rel="stylesheet" href="/header.css">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{
            --accent:#a855f7;--accent-dark:#9333ea;--accent-light:#e9d5ff;
            --cyan:#06b6d4;--pink:#ff6b9d;--blue:#4facfe;--purple:#a855f7;
            --gold:#ffd700;--text-dark:#1a1a2e;--text-muted:#6b7280;
        }
        html,body{overscroll-behavior:none}
        body{font-family:'Inter',sans-serif;background:linear-gradient(135deg,#f3e8ff 0%,#e9d5ff 50%,#faf5ff 100%);color:var(--text-dark);min-height:100vh;min-height:100dvh;display:flex;flex-direction:column;overflow-x:hidden}
        h1,h2,h3,h4{font-family:'Bebas Neue',sans-serif;letter-spacing:1px}
        a{color:inherit;text-decoration:none}

        main{flex:1;display:flex;flex-direction:column;padding-top:60px}
        .game-hero{background:radial-gradient(circle at 10% 0%,#581c87 0%,#3b0764 50%,#1e1b4b 100%);padding:30px 20px;text-align:center;position:relative;overflow:hidden}
        .game-hero::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at 30% 20%,rgba(168,85,247,0.3) 0%,transparent 55%)}
        .game-hero-content{position:relative;z-index:1;max-width:600px;margin:0 auto}
        .game-hero-title{font-size:clamp(2rem,7vw,3rem);line-height:0.95;margin-bottom:6px;background:linear-gradient(135deg,#fff,var(--accent-light),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:3px}
        .game-hero-desc{font-size:0.85rem;color:rgba(255,255,255,0.7)}

        .game-wrapper{flex:1;display:flex;flex-direction:column;align-items:center;padding:20px 10px 40px}
        .game-container{width:100%;max-width:500px;display:flex;flex-direction:column;gap:16px}

        .game-board{background:#fff;border-radius:20px;border:3px solid rgba(168,85,247,0.2);padding:12px;box-shadow:0 8px 30px rgba(168,85,247,0.12)}
        
        .game-layout{display:flex;gap:12px;justify-content:center;align-items:flex-start}
        
        .canvas-wrapper{
            position:relative;
            background:linear-gradient(180deg,#1a1a2e 0%,#0f0f1a 100%);
            border-radius:10px;
            overflow:hidden;
            box-shadow:inset 0 0 30px rgba(0,0,0,0.5),0 0 20px rgba(168,85,247,0.2);
        }
        #game-canvas{display:block}
        
        /* In-game score overlay */
        .game-hud{
            position:absolute;
            top:8px;
            left:8px;
            right:8px;
            display:flex;
            justify-content:space-between;
            pointer-events:none;
            z-index:10;
        }
        .hud-item{
            background:rgba(0,0,0,0.7);
            padding:4px 10px;
            border-radius:6px;
            backdrop-filter:blur(4px);
        }
        .hud-label{font-size:0.55rem;color:rgba(255,255,255,0.6);text-transform:uppercase;letter-spacing:0.5px}
        .hud-value{font-family:'Bebas Neue',sans-serif;font-size:1.1rem;color:#fff;letter-spacing:1px}
        .hud-value.score{color:var(--gold)}
        .hud-value.level{color:var(--cyan)}
        
        .game-overlay{position:absolute;inset:0;background:rgba(0,0,0,0.9);display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:20px;border-radius:10px;backdrop-filter:blur(6px)}
        .game-overlay.hidden{display:none}
        .overlay-title{font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:3px;color:#fff;margin-bottom:6px}
        .overlay-score{font-family:'Bebas Neue',sans-serif;font-size:3rem;color:var(--accent);margin:12px 0}
        .overlay-text{color:rgba(255,255,255,0.6);font-size:0.8rem;margin-bottom:14px}
        .new-best{color:var(--gold);font-weight:700;margin-bottom:8px}

        .side-panel{
            display:flex;
            flex-direction:column;
            gap:10px;
            min-width:70px;
        }
        .panel-box{
            background:rgba(168,85,247,0.1);
            border:2px solid rgba(168,85,247,0.2);
            border-radius:10px;
            padding:8px;
            text-align:center;
        }
        .panel-title{font-size:0.55rem;font-weight:700;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px;letter-spacing:0.5px}
        .preview-grid{
            display:grid;
            grid-template-columns:repeat(4,10px);
            grid-template-rows:repeat(4,10px);
            gap:1px;
            justify-content:center;
        }
        .preview-cell{background:rgba(0,0,0,0.1);border-radius:1px}
        .preview-cell.filled{box-shadow:inset 0 0 4px rgba(255,255,255,0.3)}
        .preview-cell.I{background:#06b6d4}
        .preview-cell.O{background:#eab308}
        .preview-cell.T{background:#a855f7}
        .preview-cell.S{background:#22c55e}
        .preview-cell.Z{background:#ef4444}
        .preview-cell.J{background:#3b82f6}
        .preview-cell.L{background:#f97316}

        .btn{padding:12px 24px;border-radius:50px;border:none;font-weight:700;font-size:0.9rem;cursor:pointer;transition:all 0.3s;text-transform:uppercase;letter-spacing:1px;font-family:'Inter',sans-serif}
        .btn-primary{background:linear-gradient(135deg,var(--accent),var(--cyan));color:#fff;box-shadow:0 6px 20px rgba(168,85,247,0.3)}
        .btn-primary:hover{transform:translateY(-2px)}
        .btn-secondary{background:#fff;color:var(--text-dark);border:2px solid rgba(168,85,247,0.3)}

        .mobile-controls{
            display:none;
            gap:8px;
            margin-top:12px;
            justify-content:center;
        }
        @media(hover:none)and(pointer:coarse){.mobile-controls{display:flex}}
        .ctrl-btn{
            width:60px;
            height:50px;
            border-radius:10px;
            background:rgba(168,85,247,0.15);
            border:2px solid rgba(168,85,247,0.25);
            color:var(--accent);
            font-size:0.7rem;
            font-weight:700;
            cursor:pointer;
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:center;
            gap:2px;
            -webkit-tap-highlight-color:transparent;
        }
        .ctrl-btn:active{background:rgba(168,85,247,0.3);transform:scale(0.95)}
        .ctrl-btn svg{width:20px;height:20px;stroke:currentColor;fill:none;stroke-width:2}

        .leaderboard-section{background:#fff;border:2px solid rgba(168,85,247,0.2);border-radius:16px;padding:16px;box-shadow:0 8px 30px rgba(168,85,247,0.12)}
        .lb-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;padding-bottom:10px;border-bottom:2px solid rgba(168,85,247,0.15);flex-wrap:wrap;gap:8px}
        .lb-title{font-family:'Bebas Neue',sans-serif;font-size:1.2rem;letter-spacing:2px}
        .lb-tabs{display:flex;gap:4px;background:rgba(168,85,247,0.08);padding:3px;border-radius:8px}
        .lb-tab{padding:5px 10px;border-radius:6px;font-size:0.65rem;font-weight:600;text-transform:uppercase;cursor:pointer;color:var(--text-muted);background:transparent;border:none}
        .lb-tab:hover{color:var(--accent)}
        .lb-tab.active{background:#fff;color:var(--accent);box-shadow:0 2px 6px rgba(168,85,247,0.15)}
        .lb-list{display:flex;flex-direction:column;gap:5px}
        .lb-row{display:flex;align-items:center;gap:10px;padding:8px 10px;background:rgba(168,85,247,0.05);border-radius:8px}
        .lb-row:hover{background:rgba(168,85,247,0.1)}
        .lb-row.top-1{background:linear-gradient(90deg,rgba(255,215,0,0.15),rgba(255,215,0,0.05));border:2px solid rgba(255,215,0,0.4)}
        .lb-row.top-2{background:linear-gradient(90deg,rgba(192,192,192,0.12),rgba(192,192,192,0.04));border:2px solid rgba(192,192,192,0.3)}
        .lb-row.top-3{background:linear-gradient(90deg,rgba(205,127,50,0.12),rgba(205,127,50,0.04));border:2px solid rgba(205,127,50,0.3)}
        .lb-rank{font-family:'Bebas Neue',sans-serif;font-size:1rem;width:25px;text-align:center;color:var(--text-muted)}
        .lb-row.top-1 .lb-rank{color:#ffd700}
        .lb-row.top-2 .lb-rank{color:#c0c0c0}
        .lb-row.top-3 .lb-rank{color:#cd7f32}
        .lb-name{flex:1;font-weight:600;font-size:0.75rem}
        .lb-score{font-family:'Bebas Neue',sans-serif;font-size:1rem;color:var(--accent)}
        .lb-empty{text-align:center;padding:20px;color:var(--text-muted);font-size:0.75rem}

        /* Line clear flash effect */
        .line-flash{
            position:absolute;
            left:0;
            right:0;
            height:24px;
            background:linear-gradient(90deg,transparent,rgba(255,255,255,0.9),transparent);
            pointer-events:none;
            animation:lineFlash 0.3s ease-out forwards;
        }
        @keyframes lineFlash{
            0%{opacity:1;transform:scaleX(0)}
            50%{opacity:1;transform:scaleX(1.1)}
            100%{opacity:0;transform:scaleX(1)}
        }
    </style>
</head>
<body>
    <div id="site-header"></div>

    <main>
        <section class="game-hero">
            <div class="game-hero-content">
                <h1 class="game-hero-title">BLOCK STACK</h1>
                <p class="game-hero-desc">Stack blocks, clear lines, beat high scores!</p>
            </div>
        </section>

        <div class="game-wrapper">
            <div class="game-container">
                <div class="game-board">
                    <div class="game-layout">
                        <div class="side-panel">
                            <div class="panel-box">
                                <div class="panel-title">Hold</div>
                                <div class="preview-grid" id="hold-preview"></div>
                            </div>
                            <div class="panel-box">
                                <div class="panel-title">Lines</div>
                                <div style="font-family:'Bebas Neue';font-size:1.3rem;color:var(--accent)" id="lines-display">0</div>
                            </div>
                        </div>
                        
                        <div class="canvas-wrapper" id="canvas-wrapper">
                            <div class="game-hud">
                                <div class="hud-item">
                                    <div class="hud-label">Score</div>
                                    <div class="hud-value score" id="hud-score">0</div>
                                </div>
                                <div class="hud-item">
                                    <div class="hud-label">Level</div>
                                    <div class="hud-value level" id="hud-level">1</div>
                                </div>
                            </div>
                            <canvas id="game-canvas" width="240" height="480"></canvas>
                            <div class="game-overlay" id="start-overlay">
                                <h2 class="overlay-title">BLOCK STACK</h2>
                                <p class="overlay-text">Arrow keys to move ‚Ä¢ Up to rotate<br>Space for hard drop ‚Ä¢ C to hold</p>
                                <button class="btn btn-primary" id="start-btn">START</button>
                            </div>
                            <div class="game-overlay hidden" id="gameover-overlay">
                                <h2 class="overlay-title" style="color:#ef4444">GAME OVER</h2>
                                <div class="new-best" id="new-best" style="display:none">üèÜ NEW RECORD!</div>
                                <div class="overlay-score" id="final-score">0</div>
                                <button class="btn btn-primary" id="restart-btn">PLAY AGAIN</button>
                                <button class="btn btn-secondary" id="share-btn" style="margin-top:8px">SHARE</button>
                            </div>
                        </div>
                        
                        <div class="side-panel">
                            <div class="panel-box">
                                <div class="panel-title">Next</div>
                                <div class="preview-grid" id="next-preview"></div>
                            </div>
                            <div class="panel-box">
                                <div class="panel-title">Best</div>
                                <div style="font-family:'Bebas Neue';font-size:1.3rem;color:var(--gold)" id="best-display">0</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mobile-controls" id="mobile-controls">
                        <button class="ctrl-btn" id="btn-left">
                            <svg viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                            <span>LEFT</span>
                        </button>
                        <button class="ctrl-btn" id="btn-rotate">
                            <svg viewBox="0 0 24 24"><path d="M23 4v6h-6M1 20v-6h6M20.49 9A9 9 0 005.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 013.51 15"/></svg>
                            <span>SPIN</span>
                        </button>
                        <button class="ctrl-btn" id="btn-down">
                            <svg viewBox="0 0 24 24"><path d="M12 5v14M5 12l7 7 7-7"/></svg>
                            <span>DROP</span>
                        </button>
                        <button class="ctrl-btn" id="btn-right">
                            <svg viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                            <span>RIGHT</span>
                        </button>
                    </div>
                </div>

                <div class="leaderboard-section">
                    <div class="lb-header">
                        <h3 class="lb-title">üèÜ Leaderboard</h3>
                        <div class="lb-tabs">
                            <button class="lb-tab active" data-tab="global">Global</button>
                            <button class="lb-tab" data-tab="today">Today</button>
                            <button class="lb-tab" data-tab="friends">Friends</button>
                        </div>
                    </div>
                    <div class="lb-list" id="lb-list"><div class="lb-empty">Loading...</div></div>
                </div>
            </div>
        </div>
    </main>

<script>
const SUPABASE_URL='https://tvvivtmzofsyehatzlvl.supabase.co';
const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR2dml2dG16b2ZzeWVoYXR6bHZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4OTExODYsImV4cCI6MjA4MDQ2NzE4Nn0.Qy8kHMO0Nb4yJ0ZHjby7RuQtzwWB8rUcZvkdnbL1b3M';
const supabaseClient=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

const canvas=document.getElementById('game-canvas');
const ctx=canvas.getContext('2d');
const COLS=10,ROWS=20,CELL=24;

const PIECES={
    I:{shape:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],color:'#06b6d4'},
    O:{shape:[[1,1],[1,1]],color:'#eab308'},
    T:{shape:[[0,1,0],[1,1,1],[0,0,0]],color:'#a855f7'},
    S:{shape:[[0,1,1],[1,1,0],[0,0,0]],color:'#22c55e'},
    Z:{shape:[[1,1,0],[0,1,1],[0,0,0]],color:'#ef4444'},
    J:{shape:[[1,0,0],[1,1,1],[0,0,0]],color:'#3b82f6'},
    L:{shape:[[0,0,1],[1,1,1],[0,0,0]],color:'#f97316'}
};
const PIECE_NAMES=Object.keys(PIECES);

let board,currentPiece,nextPiece,holdPiece,canHold;
let score,level,lines,personalBest=0;
let gameLoop,gameRunning,lastTime,dropCounter;
let currentUserId=null,friendIds=[],currentTab='global';

async function loadAuth(){
    const{data}=await supabaseClient.auth.getSession();
    const user=data?.session?.user;
    if(user){
        currentUserId=user.id;
        loadPersonalBest();
        loadFriends();
    }
    fetchLeaderboard('global');
}

async function loadPersonalBest(){
    if(!currentUserId)return;
    const{data}=await supabaseClient.from('solo_scores').select('score').eq('user_id',currentUserId).eq('game_id','block-stack').order('score',{ascending:false}).limit(1).single();
    if(data){personalBest=data.score;document.getElementById('best-display').textContent=personalBest.toLocaleString()}
}

async function loadFriends(){
    if(!currentUserId)return;
    try{
        const{data}=await supabaseClient.from('friendships').select('user_id,friend_id').or(`user_id.eq.${currentUserId},friend_id.eq.${currentUserId}`).eq('status','accepted');
        if(data)friendIds=data.map(f=>f.user_id===currentUserId?f.friend_id:f.user_id);
    }catch(e){}
}

function createBoard(){return Array(ROWS).fill(null).map(()=>Array(COLS).fill(0))}

function randomPiece(){
    const name=PIECE_NAMES[Math.floor(Math.random()*PIECE_NAMES.length)];
    return{
        name,
        shape:PIECES[name].shape.map(r=>[...r]),
        color:PIECES[name].color,
        x:Math.floor((COLS-PIECES[name].shape[0].length)/2),
        y:0
    };
}

function rotate(shape){
    const N=shape.length;
    return shape.map((row,i)=>row.map((val,j)=>shape[N-1-j][i]));
}

function collision(x,y,shape){
    for(let r=0;r<shape.length;r++){
        for(let c=0;c<shape[r].length;c++){
            if(shape[r][c]){
                const newX=x+c,newY=y+r;
                if(newX<0||newX>=COLS||newY>=ROWS)return true;
                if(newY>=0&&board[newY][newX])return true;
            }
        }
    }
    return false;
}

function merge(){
    currentPiece.shape.forEach((row,r)=>{
        row.forEach((val,c)=>{
            if(val&&currentPiece.y+r>=0){
                board[currentPiece.y+r][currentPiece.x+c]=currentPiece.color;
            }
        });
    });
}

function clearLines(){
    let cleared=0;
    const linesToClear=[];
    
    for(let r=ROWS-1;r>=0;r--){
        if(board[r].every(cell=>cell)){
            linesToClear.push(r);
            cleared++;
        }
    }
    
    // Flash effect for cleared lines
    if(linesToClear.length>0){
        const wrapper=document.getElementById('canvas-wrapper');
        linesToClear.forEach(row=>{
            const flash=document.createElement('div');
            flash.className='line-flash';
            flash.style.top=`${row*CELL+40}px`; // +40 for HUD
            wrapper.appendChild(flash);
            setTimeout(()=>flash.remove(),300);
        });
        
        // Remove lines
        linesToClear.forEach(r=>{
            board.splice(r,1);
            board.unshift(Array(COLS).fill(0));
        });
    }
    
    if(cleared>0){
        const points=[0,100,300,500,800];
        score+=points[cleared]*level;
        lines+=cleared;
        level=Math.floor(lines/10)+1;
        updateHUD();
    }
}

function updateHUD(){
    document.getElementById('hud-score').textContent=score.toLocaleString();
    document.getElementById('hud-level').textContent=level;
    document.getElementById('lines-display').textContent=lines;
}

function drawPreview(container,piece){
    container.innerHTML='';
    for(let r=0;r<4;r++){
        for(let c=0;c<4;c++){
            const cell=document.createElement('div');
            cell.className='preview-cell';
            if(piece&&piece.shape[r]&&piece.shape[r][c]){
                cell.classList.add('filled',piece.name);
            }
            container.appendChild(cell);
        }
    }
}

function draw(){
    ctx.fillStyle='#0f0f1a';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    
    // Grid lines
    ctx.strokeStyle='rgba(168,85,247,0.1)';
    ctx.lineWidth=1;
    for(let c=0;c<=COLS;c++){
        ctx.beginPath();
        ctx.moveTo(c*CELL,0);
        ctx.lineTo(c*CELL,canvas.height);
        ctx.stroke();
    }
    for(let r=0;r<=ROWS;r++){
        ctx.beginPath();
        ctx.moveTo(0,r*CELL);
        ctx.lineTo(canvas.width,r*CELL);
        ctx.stroke();
    }
    
    // Draw board
    board.forEach((row,r)=>{
        row.forEach((color,c)=>{
            if(color){
                drawBlock(c,r,color);
            }
        });
    });
    
    // Draw ghost piece
    if(currentPiece){
        let ghostY=currentPiece.y;
        while(!collision(currentPiece.x,ghostY+1,currentPiece.shape))ghostY++;
        ctx.globalAlpha=0.3;
        currentPiece.shape.forEach((row,r)=>{
            row.forEach((val,c)=>{
                if(val){
                    drawBlock(currentPiece.x+c,ghostY+r,currentPiece.color);
                }
            });
        });
        ctx.globalAlpha=1;
        
        // Draw current piece
        currentPiece.shape.forEach((row,r)=>{
            row.forEach((val,c)=>{
                if(val){
                    drawBlock(currentPiece.x+c,currentPiece.y+r,currentPiece.color);
                }
            });
        });
    }
}

function drawBlock(x,y,color){
    const padding=1;
    ctx.fillStyle=color;
    ctx.fillRect(x*CELL+padding,y*CELL+padding,CELL-padding*2,CELL-padding*2);
    
    // Highlight
    ctx.fillStyle='rgba(255,255,255,0.3)';
    ctx.fillRect(x*CELL+padding,y*CELL+padding,CELL-padding*2,3);
    ctx.fillRect(x*CELL+padding,y*CELL+padding,3,CELL-padding*2);
    
    // Shadow
    ctx.fillStyle='rgba(0,0,0,0.3)';
    ctx.fillRect(x*CELL+CELL-padding-3,y*CELL+padding,3,CELL-padding*2);
    ctx.fillRect(x*CELL+padding,y*CELL+CELL-padding-3,CELL-padding*2,3);
}

function drop(){
    if(!collision(currentPiece.x,currentPiece.y+1,currentPiece.shape)){
        currentPiece.y++;
    }else{
        merge();
        clearLines();
        currentPiece=nextPiece;
        nextPiece=randomPiece();
        canHold=true;
        drawPreview(document.getElementById('next-preview'),nextPiece);
        if(collision(currentPiece.x,currentPiece.y,currentPiece.shape)){
            gameOver();
        }
    }
}

function hardDrop(){
    while(!collision(currentPiece.x,currentPiece.y+1,currentPiece.shape)){
        currentPiece.y++;
        score+=2;
    }
    updateHUD();
    drop();
}

function move(dir){
    if(!collision(currentPiece.x+dir,currentPiece.y,currentPiece.shape)){
        currentPiece.x+=dir;
    }
}

function rotatePiece(){
    const rotated=rotate(currentPiece.shape);
    const kicks=[0,-1,1,-2,2];
    for(const kick of kicks){
        if(!collision(currentPiece.x+kick,currentPiece.y,rotated)){
            currentPiece.shape=rotated;
            currentPiece.x+=kick;
            return;
        }
    }
}

function hold(){
    if(!canHold)return;
    canHold=false;
    if(holdPiece){
        const temp=holdPiece;
        holdPiece={name:currentPiece.name,shape:PIECES[currentPiece.name].shape.map(r=>[...r]),color:currentPiece.color};
        currentPiece=temp;
        currentPiece.x=Math.floor((COLS-currentPiece.shape[0].length)/2);
        currentPiece.y=0;
    }else{
        holdPiece={name:currentPiece.name,shape:PIECES[currentPiece.name].shape.map(r=>[...r]),color:currentPiece.color};
        currentPiece=nextPiece;
        nextPiece=randomPiece();
        drawPreview(document.getElementById('next-preview'),nextPiece);
    }
    drawPreview(document.getElementById('hold-preview'),holdPiece);
}

function update(time=0){
    const delta=time-lastTime;
    lastTime=time;
    dropCounter+=delta;
    const dropInterval=Math.max(80,1000-level*80);
    if(dropCounter>dropInterval){
        drop();
        dropCounter=0;
    }
    draw();
    if(gameRunning)gameLoop=requestAnimationFrame(update);
}

function startGame(){
    board=createBoard();
    score=0;level=1;lines=0;canHold=true;holdPiece=null;
    currentPiece=randomPiece();
    nextPiece=randomPiece();
    updateHUD();
    drawPreview(document.getElementById('next-preview'),nextPiece);
    drawPreview(document.getElementById('hold-preview'),null);
    document.getElementById('start-overlay').classList.add('hidden');
    document.getElementById('gameover-overlay').classList.add('hidden');
    gameRunning=true;lastTime=0;dropCounter=0;
    update();
}

function gameOver(){
    gameRunning=false;
    cancelAnimationFrame(gameLoop);
    document.getElementById('final-score').textContent=score.toLocaleString();
    const isNew=score>personalBest;
    document.getElementById('new-best').style.display=isNew?'block':'none';
    if(isNew){
        personalBest=score;
        document.getElementById('best-display').textContent=personalBest.toLocaleString();
    }
    document.getElementById('gameover-overlay').classList.remove('hidden');
    saveScore();
}

async function saveScore(){
    if(!currentUserId||score===0)return;
    await supabaseClient.from('solo_scores').insert({user_id:currentUserId,game_id:'block-stack',score});
    fetchLeaderboard(currentTab);
}

document.getElementById('start-btn').addEventListener('click',startGame);
document.getElementById('restart-btn').addEventListener('click',startGame);
document.getElementById('share-btn').addEventListener('click',()=>{
    const t=`üß± Block Stack - TheGaming.co\nüèÜ Score: ${score.toLocaleString()}\nüìä Level: ${level}\nüìè Lines: ${lines}\n\nthegaming.co/games/solo/block-stack.html`;
    navigator.share?navigator.share({text:t}):navigator.clipboard.writeText(t);
});

document.addEventListener('keydown',e=>{
    if(!gameRunning)return;
    if(e.key==='ArrowLeft'){move(-1);e.preventDefault()}
    else if(e.key==='ArrowRight'){move(1);e.preventDefault()}
    else if(e.key==='ArrowDown'){drop();score+=1;updateHUD();e.preventDefault()}
    else if(e.key==='ArrowUp'){rotatePiece();e.preventDefault()}
    else if(e.key===' '){hardDrop();e.preventDefault()}
    else if(e.key.toLowerCase()==='c'||e.key==='Shift'){hold();e.preventDefault()}
});

// Mobile controls
document.getElementById('btn-left')?.addEventListener('click',()=>gameRunning&&move(-1));
document.getElementById('btn-right')?.addEventListener('click',()=>gameRunning&&move(1));
document.getElementById('btn-down')?.addEventListener('click',()=>gameRunning&&hardDrop());
document.getElementById('btn-rotate')?.addEventListener('click',()=>gameRunning&&rotatePiece());

// Touch for faster response
['btn-left','btn-right','btn-down','btn-rotate'].forEach(id=>{
    document.getElementById(id)?.addEventListener('touchstart',e=>{
        e.preventDefault();
        if(!gameRunning)return;
        if(id==='btn-left')move(-1);
        else if(id==='btn-right')move(1);
        else if(id==='btn-down')hardDrop();
        else if(id==='btn-rotate')rotatePiece();
    },{passive:false});
});

// Leaderboard
document.querySelectorAll('.lb-tab').forEach(tab=>{
    tab.addEventListener('click',()=>{
        document.querySelectorAll('.lb-tab').forEach(t=>t.classList.remove('active'));
        tab.classList.add('active');
        currentTab=tab.dataset.tab;
        fetchLeaderboard(currentTab);
    });
});

async function fetchLeaderboard(tab){
    const lbList=document.getElementById('lb-list');
    lbList.innerHTML='<div class="lb-empty">Loading...</div>';
    let query=supabaseClient.from('solo_scores').select('score,user_id,created_at').eq('game_id','block-stack').order('score',{ascending:false}).limit(50);
    
    if(tab==='today'){
        const t=new Date();t.setHours(0,0,0,0);
        query=query.gte('created_at',t.toISOString());
    }else if(tab==='friends'){
        if(!friendIds.length){lbList.innerHTML='<div class="lb-empty">Add friends to see scores</div>';return}
        query=query.in('user_id',[...friendIds,currentUserId]);
    }
    
    const{data,error}=await query;
    if(error||!data?.length){lbList.innerHTML='<div class="lb-empty">No scores yet</div>';return}
    
    const best=new Map();
    data.forEach(e=>{if(!best.has(e.user_id)||e.score>best.get(e.user_id).score)best.set(e.user_id,e)});
    const deduped=Array.from(best.values()).sort((a,b)=>b.score-a.score);
    
    const userIds=[...new Set(deduped.map(e=>e.user_id))];
    const{data:profiles}=await supabaseClient.from('profiles').select('id,display_name,gamer_tag').in('id',userIds);
    const pm={};profiles?.forEach(p=>pm[p.id]=p);
    
    lbList.innerHTML='';
    deduped.slice(0,10).forEach((e,i)=>{
        const p=pm[e.user_id];
        const name=p?.display_name||p?.gamer_tag||'Anonymous';
        const topClass=i===0?'top-1':i===1?'top-2':i===2?'top-3':'';
        const row=document.createElement('div');
        row.className=`lb-row ${topClass}`;
        row.innerHTML=`<div class="lb-rank">${i+1}</div><div class="lb-name">${name}</div><div class="lb-score">${e.score.toLocaleString()}</div>`;
        lbList.appendChild(row);
    });
}

loadAuth();
draw();
</script>
<script src="/header.js"></script>
</body>
</html>
