<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Waiting Room - PlayHub</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #fafbff;
            color: #1a1a1a;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        h1, h2, h3 {
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 1px;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 0 40px;
            flex: 1;
        }

        nav {
            padding: 30px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid #1a1a1a;
            margin-bottom: 40px;
        }

        .logo-nav {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.1rem;
            letter-spacing: 2px;
            color: #1a1a1a;
            text-decoration: none;
        }

        .waiting-content {
            text-align: center;
            padding: 40px 0;
        }

        .room-code-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            border: 4px solid #4a3575;
            box-shadow: 8px 8px 0 #4a3575;
            margin-bottom: 40px;
            display: inline-block;
        }

        .room-code-label {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .room-code {
            font-size: 4rem;
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 8px;
        }

        .waiting-message {
            font-size: 1.3rem;
            color: #666;
            margin-bottom: 40px;
            font-weight: 600;
        }

        /* Players List */
        .players-section {
            background: white;
            border: 3px solid #1a1a1a;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 5px 5px 0 #e0e0e0;
        }

        .players-section h2 {
            font-size: 2rem;
            margin-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .players-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .player-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            background: #f9f9f9;
            border: 2px solid #e0e0e0;
            transition: all 0.2s ease;
        }

        .player-item.host {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border-color: #667eea;
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .player-number {
            background: #667eea;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.2rem;
        }

        .player-name {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .player-badge {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .player-count {
            text-align: center;
            color: #999;
            font-weight: 600;
            margin-top: 15px;
            font-size: 0.95rem;
        }

        /* Start Button */
        .start-section {
            margin: 30px 0;
        }

        .start-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 18px 60px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            box-shadow: 5px 5px 0 #4a3575;
            width: 100%;
        }

        .start-btn:hover:not(:disabled) {
            transform: translate(2px, -2px);
            box-shadow: 3px 3px 0 #4a3575;
        }

        .start-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .min-players-warning {
            color: #ff6b9d;
            font-weight: 600;
            margin-top: 15px;
            font-size: 0.95rem;
        }

        /* Footer */
        footer {
            background: #1a1a1a;
            color: white;
            padding: 30px 0;
            margin-top: auto;
            text-align: center;
        }

        .footer-bottom {
            opacity: 0.6;
            font-size: 0.9rem;
        }

        @media (max-width: 600px) {
            .container {
                padding: 0 20px;
            }

            .room-code {
                font-size: 3rem;
                letter-spacing: 4px;
            }

            .room-code-display {
                padding: 30px 25px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <nav>
            <a href="index.html" class="logo-nav">PLAYHUB</a>
        </nav>

        <div class="waiting-content">
            <div class="room-code-display">
                <div class="room-code-label">ROOM CODE</div>
                <div class="room-code" id="roomCode">------</div>
            </div>

            <p class="waiting-message" id="waitingMessage">Waiting for players...</p>

            <!-- Players List -->
            <div class="players-section">
                <h2>Players <span id="playerCountBadge">(0)</span></h2>
                <div class="players-list" id="playersList">
                    <!-- Players will be added here dynamically -->
                </div>
                <p class="player-count">Minimum 3 players required</p>
            </div>

            <!-- Start Game Button (only for host) -->
            <div class="start-section" id="startSection" style="display: none;">
                <button class="start-btn" id="startBtn" onclick="startGame()" disabled>
                    Start Game
                </button>
                <p class="min-players-warning" id="minPlayersWarning">
                    Need at least 3 players to start
                </p>
            </div>
        </div>
    </div>

    <footer>
        <div class="footer-bottom">
            Â© 2024 PlayHub. All games free forever.
        </div>
    </footer>

    <script>
        const BACKEND_URL = 'https://web-production-519c7.up.railway.app';
        const socket = io(BACKEND_URL);

        // Get room info from URL and localStorage
        const urlParams = new URLSearchParams(window.location.search);
        const roomCode = urlParams.get('code');
        const playerName = localStorage.getItem('playerName');
        const isHost = localStorage.getItem('isHost') === 'true';
        const gameType = localStorage.getItem('gameType') || 'imposter';

        console.log('Room Code:', roomCode);
        console.log('Player Name:', playerName);
        console.log('Is Host:', isHost);

        // Display room code
        document.getElementById('roomCode').textContent = roomCode;

        // Show start button if host
        if (isHost) {
            document.getElementById('startSection').style.display = 'block';
        }

        // Socket connection
        socket.on('connect', () => {
            console.log('Connected to server, socket ID:', socket.id);
            
            // Rejoin room on connection
            if (!isHost) {
                console.log('Rejoining room as non-host');
                socket.emit('join-room', {
                    roomCode: roomCode,
                    playerName: playerName
                });
            } else {
                console.log('Connected as host');
                // Host should already be in room from lobby
                // Just request current room state
                socket.emit('get-room-state', { roomCode: roomCode });
            }
        });

        // Room created (for host reconnection)
        socket.on('room-created', (data) => {
            console.log('Room created event:', data);
            if (data.success) {
                updatePlayersList(data.room.players);
            }
        });

        // Room joined successfully
        socket.on('room-joined', (data) => {
            console.log('Room joined event:', data);
            if (data.success) {
                updatePlayersList(data.room.players);
            }
        });

        // Player joined (broadcast to all in room)
        socket.on('player-joined', (data) => {
            console.log('Player joined event:', data);
            updatePlayersList(data.room.players);
        });

        // Player disconnected
        socket.on('player-disconnected', (data) => {
            console.log('Player disconnected:', data.playerName);
        });

        // New host assigned
        socket.on('new-host', (data) => {
            console.log('New host assigned:', data);
            if (socket.id === data.hostId) {
                document.getElementById('startSection').style.display = 'block';
                alert(`You are now the host!`);
            }
        });

        // Game started
        socket.on('game-started', (data) => {
            console.log('Game started!', data);
            // Redirect to game page
            window.location.href = `game-imposter.html?code=${roomCode}`;
        });

        // Error handling
        socket.on('error', (data) => {
            console.error('Socket error:', data);
            alert(data.message);
        });

        socket.on('join-error', (data) => {
            console.error('Join error:', data);
            alert(`Error joining room: ${data.message}`);
        });

        function updatePlayersList(players) {
            console.log('Updating players list:', players);
            
            const playersList = document.getElementById('playersList');
            const playerCountBadge = document.getElementById('playerCountBadge');
            const startBtn = document.getElementById('startBtn');
            const minPlayersWarning = document.getElementById('minPlayersWarning');
            
            if (!players || players.length === 0) {
                console.warn('No players to display');
                return;
            }

            playersList.innerHTML = '';
            
            players.forEach((player, index) => {
                const playerItem = document.createElement('div');
                playerItem.className = `player-item ${player.isHost ? 'host' : ''}`;
                
                const playerInfo = document.createElement('div');
                playerInfo.className = 'player-info';
                
                // Player number
                const playerNumber = document.createElement('div');
                playerNumber.className = 'player-number';
                playerNumber.textContent = index + 1;
                
                // Player name
                const playerNameSpan = document.createElement('span');
                playerNameSpan.className = 'player-name';
                playerNameSpan.textContent = player.name;
                
                playerInfo.appendChild(playerNumber);
                playerInfo.appendChild(playerNameSpan);
                playerItem.appendChild(playerInfo);
                
                // Host badge
                if (player.isHost) {
                    const badge = document.createElement('span');
                    badge.className = 'player-badge';
                    badge.textContent = 'HOST';
                    playerItem.appendChild(badge);
                }
                
                playersList.appendChild(playerItem);
            });

            // Update player count
            playerCountBadge.textContent = `(${players.length})`;

            // Enable/disable start button based on player count
            if (isHost) {
                if (players.length >= 3) {
                    startBtn.disabled = false;
                    minPlayersWarning.style.display = 'none';
                } else {
                    startBtn.disabled = true;
                    minPlayersWarning.style.display = 'block';
                }
            }
        }

        function startGame() {
            if (confirm('Start the game now?')) {
                console.log('Starting game...');
                socket.emit('start-game', {
                    roomCode: roomCode
                });
            }
        }

        // Handle browser close/refresh
        window.addEventListener('beforeunload', () => {
            socket.disconnect();
        });

        // Debug: Log all socket events
        socket.onAny((eventName, ...args) => {
            console.log('Socket event:', eventName, args);
        });
    </script>
</body>
</html>
