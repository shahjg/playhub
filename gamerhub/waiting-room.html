<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Waiting Room - PlayHub</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* Animated Background Blobs */
        .blob {
            position: fixed;
            border-radius: 50%;
            filter: blur(60px);
            opacity: 0.5;
            z-index: 0;
            animation: float 20s infinite ease-in-out;
        }

        .blob-1 {
            width: 300px;
            height: 300px;
            background: rgba(255, 107, 107, 0.4);
            top: -100px;
            left: -100px;
            animation-delay: 0s;
        }

        .blob-2 {
            width: 400px;
            height: 400px;
            background: rgba(78, 205, 196, 0.4);
            bottom: -150px;
            right: -150px;
            animation-delay: 5s;
        }

        .blob-3 {
            width: 250px;
            height: 250px;
            background: rgba(255, 195, 113, 0.4);
            top: 50%;
            left: 50%;
            animation-delay: 10s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(50px, -50px) scale(1.1); }
            66% { transform: translate(-50px, 50px) scale(0.9); }
        }

        /* Header */
        header {
            background: rgba(255, 255, 255, 0.95);
            border-bottom: 4px solid #000;
            box-shadow: 0 4px 0 rgba(0, 0, 0, 0.2);
            padding: 1rem 2rem;
            position: relative;
            z-index: 10;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2rem;
            color: #000;
            text-decoration: none;
            letter-spacing: 2px;
        }

        /* Main Container */
        .container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            position: relative;
            z-index: 1;
        }

        .waiting-room-card {
            background: rgba(255, 255, 255, 0.98);
            border: 4px solid #000;
            border-radius: 20px;
            box-shadow: 8px 8px 0 rgba(0, 0, 0, 0.3);
            padding: 2.5rem;
            max-width: 600px;
            width: 100%;
        }

        h1 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.5rem;
            text-align: center;
            margin-bottom: 0.5rem;
            letter-spacing: 2px;
        }

        .room-code-display {
            text-align: center;
            margin-bottom: 2rem;
        }

        .room-code-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .room-code {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 3rem;
            color: #667eea;
            letter-spacing: 4px;
            text-shadow: 2px 2px 0 rgba(0, 0, 0, 0.1);
        }

        .player-count {
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
            color: #666;
            margin-bottom: 1.5rem;
        }

        /* Players List */
        .players-section {
            margin-bottom: 2rem;
        }

        .section-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem;
            margin-bottom: 1rem;
            letter-spacing: 1px;
        }

        .players-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            max-height: 300px;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .player-item {
            background: #f8f9fa;
            border: 3px solid #000;
            border-radius: 10px;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.2s;
        }

        .player-item:hover {
            transform: translateX(5px);
        }

        .player-item.host {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .player-number {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem;
            width: 35px;
            height: 35px;
            background: #000;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .player-item.host .player-number {
            background: rgba(255, 255, 255, 0.3);
        }

        .player-name {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .player-badge {
            background: #ffd700;
            color: #000;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            border: 2px solid #000;
        }

        /* Start Section */
        .start-section {
            text-align: center;
        }

        .min-players-warning {
            background: #fff3cd;
            border: 3px solid #ffc107;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            color: #856404;
            font-weight: 600;
        }

        .start-btn {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem;
            letter-spacing: 2px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: 4px solid #000;
            border-radius: 10px;
            padding: 1rem 3rem;
            cursor: pointer;
            box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
            transition: all 0.2s;
            width: 100%;
        }

        .start-btn:hover:not(:disabled) {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 rgba(0, 0, 0, 0.3);
        }

        .start-btn:active:not(:disabled) {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 rgba(0, 0, 0, 0.3);
        }

        .start-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Footer */
        footer {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            text-align: center;
            padding: 1.5rem;
            position: relative;
            z-index: 10;
        }

        /* Scrollbar Styling */
        .players-list::-webkit-scrollbar {
            width: 8px;
        }

        .players-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .players-list::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        .players-list::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }

        /* Loading State */
        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .waiting-room-card {
                padding: 1.5rem;
            }

            h1 {
                font-size: 2rem;
            }

            .room-code {
                font-size: 2rem;
            }

            .player-name {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>
    <div class="blob blob-3"></div>

    <!-- Header -->
    <header>
        <div class="header-content">
            <a href="index.html" class="logo">PLAYHUB</a>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <div class="waiting-room-card">
            <h1>WAITING ROOM</h1>
            
            <div class="room-code-display">
                <div class="room-code-label">Room Code:</div>
                <div class="room-code" id="roomCode">------</div>
            </div>

            <div class="player-count" id="playerCountDisplay">0/15 Players</div>

            <div class="players-section">
                <div class="section-title">Players in Lobby</div>
                <div class="players-list" id="playersList">
                    <div class="loading">Connecting...</div>
                </div>
            </div>

            <div class="start-section" id="startSection" style="display: none;">
                <div class="min-players-warning" id="minPlayersWarning">
                    ⚠️ Need at least 3 players to start
                </div>
                <button class="start-btn" id="startBtn" onclick="startGame()" disabled>
                    START GAME
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div>© 2024 PlayHub. All games free forever.</div>
    </footer>

    <!-- Socket.io Client -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

    <script>
        const BACKEND_URL = 'https://web-production-519c7.up.railway.app';
        const socket = io(BACKEND_URL);

        // Get room code from URL
        const urlParams = new URLSearchParams(window.location.search);
        const roomCode = urlParams.get('code');
        const playerName = localStorage.getItem('playerName');
        const isHost = localStorage.getItem('isHost') === 'true';

        console.log('Waiting room initialized:', { roomCode, playerName, isHost });

        // Display room code
        document.getElementById('roomCode').textContent = roomCode;

        // Show start button if host
        if (isHost) {
            document.getElementById('startSection').style.display = 'block';
        }

        // Socket connection
        socket.on('connect', () => {
            console.log('Connected to server, socket ID:', socket.id);
            
            // Request room state to get current players
            socket.emit('get-room-state', { roomCode: roomCode });
        });

        // Connection error
        socket.on('connect_error', (error) => {
            console.error('Connection error:', error);
            document.getElementById('playersList').innerHTML = '<div class="loading">Connection error. Retrying...</div>';
        });

        // Player joined (when someone NEW joins the room)
        socket.on('player-joined', (data) => {
            console.log('Player joined event:', data);
            updatePlayersList(data.room.players);
        });

        // Room joined successfully (when YOU join as a player)
        socket.on('room-joined', (data) => {
            console.log('Room joined event:', data);
            updatePlayersList(data.room.players);
        });

        // Room created (for host when they create the room)
        socket.on('room-created', (data) => {
            console.log('Room created event:', data);
            if (data.success) {
                updatePlayersList(data.room.players);
            }
        });

        // Room state received (response to get-room-state request)
        socket.on('room-state', (data) => {
            console.log('Room state received:', data);
            if (data.success) {
                updatePlayersList(data.room.players);
            }
        });

        // Player disconnected
        socket.on('player-disconnected', (data) => {
            console.log('Player disconnected:', data);
            updatePlayersList(data.room.players);
        });

        // New host assigned
        socket.on('new-host', (data) => {
            console.log('New host assigned:', data);
            if (socket.id === data.hostId) {
                document.getElementById('startSection').style.display = 'block';
                alert('You are now the host!');
            }
        });

        // Game started
        socket.on('game-started', (data) => {
            console.log('Game started, redirecting...');
            window.location.href = `game-imposter.html?code=${roomCode}`;
        });

        // Error handling
        socket.on('error', (data) => {
            console.error('Socket error:', data);
            alert(data.message);
        });

        socket.on('join-error', (data) => {
            console.error('Join error:', data);
            alert(`Error: ${data.message}`);
        });

        // Update players list UI
        function updatePlayersList(players) {
            console.log('Updating players list:', players);
            
            const playersList = document.getElementById('playersList');
            const playerCountDisplay = document.getElementById('playerCountDisplay');
            const startBtn = document.getElementById('startBtn');
            const minPlayersWarning = document.getElementById('minPlayersWarning');
            
            if (!players || players.length === 0) {
                console.warn('No players to display');
                playersList.innerHTML = '<div class="loading">Waiting for players...</div>';
                return;
            }

            // Clear the list
            playersList.innerHTML = '';
            
            // Add each player
            players.forEach((player, index) => {
                const playerItem = document.createElement('div');
                playerItem.className = `player-item ${player.isHost ? 'host' : ''}`;
                
                const playerInfo = document.createElement('div');
                playerInfo.className = 'player-info';
                
                // Player number
                const playerNumber = document.createElement('div');
                playerNumber.className = 'player-number';
                playerNumber.textContent = index + 1;
                
                // Player name
                const playerNameSpan = document.createElement('span');
                playerNameSpan.className = 'player-name';
                playerNameSpan.textContent = player.name;
                
                playerInfo.appendChild(playerNumber);
                playerInfo.appendChild(playerNameSpan);
                playerItem.appendChild(playerInfo);
                
                // Host badge
                if (player.isHost) {
                    const badge = document.createElement('span');
                    badge.className = 'player-badge';
                    badge.textContent = 'HOST';
                    playerItem.appendChild(badge);
                }
                
                playersList.appendChild(playerItem);
            });

            // Update player count display
            playerCountDisplay.textContent = `${players.length}/15 Players`;

            // Enable/disable start button based on player count (only if user is host)
            if (isHost) {
                if (players.length >= 3) {
                    startBtn.disabled = false;
                    minPlayersWarning.style.display = 'none';
                } else {
                    startBtn.disabled = true;
                    minPlayersWarning.style.display = 'block';
                }
            }
        }

        // Start game function
        function startGame() {
            if (confirm('Start the game now? All players will be taken to the game screen.')) {
                console.log('Starting game...');
                socket.emit('start-game', {
                    roomCode: roomCode
                });
            }
        }

        // Handle browser close/refresh
        window.addEventListener('beforeunload', () => {
            socket.disconnect();
        });

        // Debug: Log all socket events
        socket.onAny((eventName, ...args) => {
            console.log('Socket event:', eventName, args);
        });
    </script>
</body>
</html>
