<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Lobby - TheGaming.co</title>
    
    <meta name="description" content="Waiting room - invite friends with your room code!">
    <meta name="robots" content="noindex, nofollow">
    <meta name="theme-color" content="#0a0a0f">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/js/cosmetics.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --accent: #14b8a6;
            --accent-glow: rgba(20, 184, 166, 0.4);
            --accent-soft: rgba(20, 184, 166, 0.12);
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: rgba(255, 255, 255, 0.02);
            --border: rgba(255, 255, 255, 0.08);
            --border-accent: rgba(20, 184, 166, 0.3);
            --text: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.5);
            --gold: #fbbf24;
            --green: #22c55e;
            --red: #ef4444;
        }

        /* START OF NEW THEME CSS */
        .theme-spyfall { --accent: #14b8a6; --accent-glow: rgba(20, 184, 166, 0.4); --accent-soft: rgba(20, 184, 166, 0.12); --border-accent: rgba(20, 184, 166, 0.3); }
        .theme-word-bomb { --accent: #f43f5e; --accent-glow: rgba(244, 63, 94, 0.4); --accent-soft: rgba(244, 63, 94, 0.12); --border-accent: rgba(244, 63, 94, 0.3); }
        .theme-codenames { --accent: #22c55e; --accent-glow: rgba(34, 197, 94, 0.4); --accent-soft: rgba(34, 197, 94, 0.12); --border-accent: rgba(34, 197, 94, 0.3); }
        .theme-werewolf { --accent: #a855f7; --accent-glow: rgba(168, 85, 247, 0.4); --accent-soft: rgba(168, 85, 247, 0.12); --border-accent: rgba(168, 85, 247, 0.3); }
        .theme-fake-artist { --accent: #ec4899; --accent-glow: rgba(236, 72, 153, 0.4); --accent-soft: rgba(236, 72, 153, 0.12); --border-accent: rgba(236, 72, 153, 0.3); }
        .theme-herd-mentality { --accent: #3b82f6; --accent-glow: rgba(59, 130, 246, 0.4); --accent-soft: rgba(59, 130, 246, 0.12); --border-accent: rgba(59, 130, 246, 0.3); }
        .theme-avalon { --accent: #eab308; --accent-glow: rgba(234, 179, 8, 0.4); --accent-soft: rgba(234, 179, 8, 0.12); --border-accent: rgba(234, 179, 8, 0.3); }
        .theme-imposter { --accent: #ef4444; --accent-glow: rgba(239, 68, 68, 0.4); --accent-soft: rgba(239, 68, 68, 0.12); --border-accent: rgba(239, 68, 68, 0.3); }
        .theme-insider { --accent: #6366f1; --accent-glow: rgba(99, 102, 241, 0.4); --accent-soft: rgba(99, 102, 241, 0.12); --border-accent: rgba(99, 102, 241, 0.3); }
        .theme-wavelength { --accent: #f97316; --accent-glow: rgba(249, 115, 22, 0.4); --accent-soft: rgba(249, 115, 22, 0.12); --border-accent: rgba(249, 115, 22, 0.3); }
        .theme-npat { --accent: #f59e0b; --accent-glow: rgba(245, 158, 11, 0.4); --accent-soft: rgba(245, 158, 11, 0.12); --border-accent: rgba(245, 158, 11, 0.3); }
        .theme-categories { --accent: #00d9ff; --accent-glow: rgba(0, 217, 255, 0.4); --accent-soft: rgba(0, 217, 255, 0.12); --border-accent: rgba(0, 217, 255, 0.3); }
        .theme-word-association { --accent: #a855f7; --accent-glow: rgba(168, 85, 247, 0.4); --accent-soft: rgba(168, 85, 247, 0.12); --border-accent: rgba(168, 85, 247, 0.3); }
        .theme-charades { --accent: #10b981; --accent-glow: rgba(16, 185, 129, 0.4); --accent-soft: rgba(16, 185, 129, 0.12); --border-accent: rgba(16, 185, 129, 0.3); }
        .theme-celebrity { --accent: #f472b6; --accent-glow: rgba(244, 114, 182, 0.4); --accent-soft: rgba(244, 114, 182, 0.12); --border-accent: rgba(244, 114, 182, 0.3); }
        .theme-fishbowl { --accent: #06b6d4; --accent-glow: rgba(6, 182, 212, 0.4); --accent-soft: rgba(6, 182, 212, 0.12); --border-accent: rgba(6, 182, 212, 0.3); }
        .theme-most-likely-to { --accent: #f43f5e; --accent-glow: rgba(244, 63, 94, 0.4); --accent-soft: rgba(244, 63, 94, 0.12); --border-accent: rgba(244, 63, 94, 0.3); }
        .theme-trivia-royale { --accent: #8b5cf6; --accent-glow: rgba(139, 92, 246, 0.4); --accent-soft: rgba(139, 92, 246, 0.12); --border-accent: rgba(139, 92, 246, 0.3); }
        .theme-this-or-that-party { --accent: #f97316; --accent-glow: rgba(249, 115, 22, 0.4); --accent-soft: rgba(249, 115, 22, 0.12); --border-accent: rgba(249, 115, 22, 0.3); }
        .theme-hot-takes-party { --accent: #ef4444; --accent-glow: rgba(239, 68, 68, 0.4); --accent-soft: rgba(239, 68, 68, 0.12); --border-accent: rgba(239, 68, 68, 0.3); }
        .theme-never-ever-party { --accent: #ec4899; --accent-glow: rgba(236, 72, 153, 0.4); --accent-soft: rgba(236, 72, 153, 0.12); --border-accent: rgba(236, 72, 153, 0.3); }
        .theme-bet-or-bluff { --accent: #10b981; --accent-glow: rgba(16, 185, 129, 0.4); --accent-soft: rgba(16, 185, 129, 0.12); --border-accent: rgba(16, 185, 129, 0.3); }
        /* END OF NEW THEME CSS */

        /* ========== PARTY GAME PLAYER GRID ========== */
.party-mode .players-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 10px;
    max-height: 400px;
    overflow-y: auto;
    padding: 1rem;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 12px;
    border: 1px solid var(--border);
}

.party-mode .player-item {
    padding: 0.6rem 0.8rem;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
    flex-direction: row;
    justify-content: flex-start;
}

.party-mode .player-item:hover {
    border-color: var(--accent);
    background: var(--accent-soft);
}

.party-mode .player-item.is-host {
    border-color: var(--gold);
    background: rgba(251, 191, 36, 0.1);
}

.party-mode .player-avatar {
    width: 28px;
    height: 28px;
    min-width: 28px;
    font-size: 0.75rem;
}

.party-mode .player-info {
    flex: 1;
    min-width: 0;
    gap: 6px;
}

.party-mode .player-name {
    font-size: 0.85rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.party-mode .player-badges {
    display: none;
}

.party-mode .badge-host-icon {
    margin-left: auto;
    font-size: 0.7rem;
}

.party-player-count {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    padding: 1rem;
    background: linear-gradient(135deg, var(--accent-soft), transparent);
    border: 1px solid var(--border-accent);
    border-radius: 12px;
    margin-bottom: 1rem;
}

.party-player-count .count-number {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2.5rem;
    color: var(--accent);
    line-height: 1;
}

.party-player-count .count-label {
    font-size: 0.8rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1px;
}

.party-player-count .count-status {
    font-size: 0.75rem;
    color: var(--text-muted);
    padding: 4px 10px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 20px;
}

.party-player-count .count-status.ready {
    background: rgba(34, 197, 94, 0.2);
    color: #86efac;
}

.party-mode .players-list::-webkit-scrollbar { width: 6px; }
.party-mode .players-list::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); border-radius: 3px; }
.party-mode .players-list::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 3px; }

@media (max-width: 600px) {
    .party-mode .players-list {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 8px;
        max-height: 300px;
        padding: 0.75rem;
    }
    .party-mode .player-item { padding: 0.5rem 0.6rem; }
    .party-mode .player-avatar { width: 24px; height: 24px; min-width: 24px; font-size: 0.65rem; }
    .party-mode .player-name { font-size: 0.8rem; }
    .party-player-count .count-number { font-size: 2rem; }
}
/* ========== END PARTY GRID CSS ========== */
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* ========== ANIMATED BACKGROUND ========== */
        .bg-container {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .bg-gradient {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: 
                radial-gradient(ellipse 80% 50% at 20% 0%, var(--accent-soft) 0%, transparent 50%),
                radial-gradient(ellipse 60% 40% at 90% 100%, var(--accent-soft) 0%, transparent 50%),
                var(--bg-primary);
        }

        .glow-orb {
            position: absolute;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, var(--accent-glow) 0%, transparent 70%);
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.3;
            animation: orbFloat 25s ease-in-out infinite;
        }

        .glow-orb:nth-child(2) {
            width: 300px;
            height: 300px;
            animation-delay: -12s;
            animation-duration: 30s;
        }

        @keyframes orbFloat {
            0%, 100% { transform: translate(0, 0); }
            33% { transform: translate(60vw, 20vh); }
            66% { transform: translate(30vw, 60vh); }
        }

        .grid-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: 
                linear-gradient(var(--border) 1px, transparent 1px),
                linear-gradient(90deg, var(--border) 1px, transparent 1px);
            background-size: 60px 60px;
            opacity: 0.3;
        }

        /* ========== HEADER ========== */
        header {
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 100;
            height: 60px;
            display: flex;
            align-items: center;
            padding: 0 18px;
            background: rgba(10, 10, 15, 0.88);
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .nav-inner {
            width: 100%;
            max-width: 1100px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            gap: 24px;
        }

        .nav-left { justify-self: flex-start; }
        .nav-right-wrapper { justify-self: flex-end; display: flex; justify-content: flex-end; }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            border-radius: 8px;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-muted);
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .back-btn:hover { 
            background: rgba(239, 68, 68, 0.1); 
            color: var(--red);
            border-color: var(--red);
        }

        .back-btn svg { width: 16px; height: 16px; }

        .header-logo {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.6rem;
            letter-spacing: 4px;
            color: white;
            text-decoration: none;
            position: relative;
            white-space: nowrap;
            justify-self: center;
        }

        .header-logo::after {
            content: '';
            position: absolute;
            bottom: -2px; left: 0; right: 0;
            height: 2px;
            background: linear-gradient(90deg, #ff6b9d, #4facfe, #a855f7);
        }

        .header-actions { display: flex; align-items: center; gap: 16px; }
        .nav-right-logged-out, .nav-right-logged-in { display: none !important; }

        .auth-link {
            font-size: 0.85rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.75);
            text-decoration: none;
            white-space: nowrap;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            transition: color 0.2s ease;
            height: 36px;
            display: inline-flex;
            align-items: center;
        }

        .auth-link:hover { color: #ffffff; }

        .user-menu-wrapper { position: relative; }

        .user-pill {
            display: inline-flex;
            align-items: center;
            height: 36px;
            padding: 0 16px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.18);
            background: rgba(255, 255, 255, 0.04);
            cursor: pointer;
            transition: background 0.2s ease, transform 0.15s ease;
            color: inherit;
            font-family: inherit;
        }

        .user-pill:hover { background: rgba(255, 255, 255, 0.08); transform: translateY(-1px); }

        .user-pill-label {
            font-family: 'Inter', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            letter-spacing: 0.02em;
            white-space: nowrap;
            color: rgba(255, 255, 255, 0.9);
        }

        .user-pill-skeleton {
            width: 100px;
            height: 36px;
            border-radius: 999px;
            background: linear-gradient(90deg, rgba(255,255,255,0.04) 0%, rgba(255,255,255,0.08) 50%, rgba(255,255,255,0.04) 100%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }

        .user-menu {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            min-width: 170px;
            padding: 6px;
            border-radius: 14px;
            background: rgba(10, 10, 15, 0.97);
            border: 1px solid rgba(255, 255, 255, 0.14);
            box-shadow: 0 18px 55px rgba(0, 0, 0, 0.8);
            opacity: 0;
            transform: translateY(-4px);
            pointer-events: none;
            transition: opacity 0.15s ease, transform 0.15s ease;
            backdrop-filter: blur(10px);
            z-index: 120;
        }

        .user-menu.open { opacity: 1; transform: translateY(0); pointer-events: auto; }

        .user-menu-item {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            border-radius: 9px;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.9);
            background: none;
            border: none;
            text-align: left;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            text-decoration: none;
        }

        .user-menu-item:hover { background: rgba(255, 255, 255, 0.08); }

        /* ========== MAIN CONTENT ========== */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 80px 20px 40px;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
            position: relative;
            z-index: 1;
        }

        /* Game Title */
        .game-header {
            text-align: center;
            margin-bottom: 1.5rem;
            width: 100%;
        }

        .game-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 3rem;
            letter-spacing: 5px;
            color: var(--text);
            margin-bottom: 0.25rem;
        }

        .how-to-play-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-muted);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .how-to-play-btn:hover {
            background: var(--accent-soft);
            color: var(--accent);
            border-color: var(--accent);
        }

        /* ========== ROOM CODE SECTION ========== */
        .room-code-section {
            width: 100%;
            margin-bottom: 1.5rem;
        }

        .room-code-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            position: relative;
        }

        .room-code-card::before {
            content: '';
            position: absolute;
            top: 0; left: 40px; right: 40px;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
        }

        .room-code-label {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 0.75rem;
        }

        .room-code-value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 5rem;
            letter-spacing: 12px;
            color: var(--accent);
            text-shadow: 0 0 60px var(--accent-glow);
            line-height: 1;
            animation: codeGlow 4s ease-in-out infinite;
        }

        @keyframes codeGlow {
            0%, 100% { text-shadow: 0 0 40px var(--accent-glow); }
            50% { text-shadow: 0 0 80px var(--accent-glow), 0 0 120px var(--accent-glow); }
        }

        .room-code-hint {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 1rem;
            margin-bottom: 1rem;
        }

        .room-code-actions {
            display: flex;
            justify-content: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .copy-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            color: var(--text-muted);
            padding: 0.7rem 1.1rem;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .copy-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-soft);
        }

        .copy-btn.copied {
            border-color: var(--green);
            color: var(--green);
            background: rgba(34, 197, 94, 0.1);
        }

        .copy-btn svg { width: 16px; height: 16px; }

        /* ========== PLAYERS SECTION ========== */
        .players-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.25rem;
            width: 100%;
            margin-bottom: 1.5rem;
        }

        .players-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .players-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.15rem;
            letter-spacing: 2px;
            color: var(--text);
        }

        .players-count {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .players-count span { color: var(--accent); font-weight: 800; }

        .players-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 280px;
            overflow-y: auto;
        }

        .player-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.7rem 0.9rem;
            background: var(--bg-card);
            border-radius: 10px;
            border: 1px solid transparent;
            transition: all 0.2s ease;
            animation: slideIn 0.3s ease forwards;
            opacity: 0;
        }

        @keyframes slideIn {
            to { opacity: 1; }
        }

        .player-item:hover { border-color: var(--border); }
        .player-item.is-host { background: var(--accent-soft); border-color: var(--border-accent); }
        .player-item.is-me { border-color: var(--accent); }

        .player-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-avatar {
            width: 32px;
            height: 32px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 0.9rem;
            color: var(--accent);
        }

        .player-item.is-host .player-avatar {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg-primary);
        }

        .player-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text);
        }

        .player-name.premium {
            background: linear-gradient(90deg, var(--gold), #f59e0b, var(--gold));
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: goldShimmer 3s linear infinite;
        }

        @keyframes goldShimmer { 0% { background-position: 0% center; } 100% { background-position: 200% center; } }

        .player-badges { display: flex; align-items: center; gap: 6px; }

        .badge {
            font-size: 0.6rem;
            font-weight: 800;
            padding: 0.2rem 0.5rem;
            border-radius: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-host { background: var(--gold); color: var(--bg-primary); }
        .badge-you { background: rgba(255, 255, 255, 0.1); color: var(--text-muted); border: 1px solid var(--border); }

        .kick-btn {
            background: transparent;
            border: 1px solid var(--red);
            color: var(--red);
            padding: 0.25rem 0.5rem;
            border-radius: 5px;
            font-size: 0.65rem;
            font-weight: 800;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s ease;
            text-transform: uppercase;
        }

        .player-item:hover .kick-btn { opacity: 1; }
        .kick-btn:hover { background: var(--red); color: white; }

        .players-empty {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .players-list::-webkit-scrollbar { width: 5px; }
        .players-list::-webkit-scrollbar-track { background: transparent; }
        .players-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

        /* Floating kick button for cosmetics player cards */
        .kick-btn-floating {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: transparent;
            border: 1px solid var(--red);
            color: var(--red);
            font-size: 12px;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .player-card:hover .kick-btn-floating,
        .player-item:hover .kick-btn-floating { opacity: 1; }
        .kick-btn-floating:hover { background: var(--red); color: white; }

        /* Make player cards in list relative for kick button positioning */
        .players-list .player-card {
            position: relative;
            margin-bottom: 8px;
        }

        /* ========== SETTINGS SECTION ========== */
        .settings-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.25rem;
            width: 100%;
            margin-bottom: 1.5rem;
        }

        .settings-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 1rem;
        }

        .settings-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.1rem;
            letter-spacing: 2px;
            color: var(--text);
        }

        .host-badge {
            font-size: 0.55rem;
            font-weight: 800;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            background: var(--gold);
            color: var(--bg-primary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .setting-group { margin-bottom: 1rem; }
        .setting-group:last-child { margin-bottom: 0; }

        .setting-label {
            display: block;
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--text-muted);
            margin-bottom: 0.4rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .setting-select {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.9rem;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .setting-select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .setting-select option { background: var(--bg-secondary); }

        .setting-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 0.75rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .setting-checkbox:hover { border-color: var(--accent); }

        .setting-checkbox input {
            width: 18px;
            height: 18px;
            accent-color: var(--accent);
            cursor: pointer;
        }

        .setting-checkbox-text { flex: 1; }
        .setting-checkbox-title { font-weight: 600; font-size: 0.9rem; color: var(--text); }
        .setting-checkbox-desc { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.15rem; }

        .location-preview {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 0.75rem;
            margin-top: 0.5rem;
            border: 1px solid var(--border);
        }

        .location-preview-title {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        .location-tags { display: flex; flex-wrap: wrap; gap: 5px; }

        .location-tag {
            background: var(--accent-soft);
            border: 1px solid var(--border-accent);
            padding: 0.25rem 0.5rem;
            border-radius: 5px;
            font-size: 0.7rem;
            color: var(--accent);
            font-weight: 600;
        }

        /* ========== START SECTION ========== */
        .start-section { width: 100%; }

        .min-players-warning {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.25);
            border-radius: 10px;
            padding: 0.9rem;
            text-align: center;
            margin-bottom: 1rem;
            color: var(--red);
            font-size: 0.85rem;
            font-weight: 600;
        }

        .waiting-message {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1.25rem;
            text-align: center;
            color: var(--text-muted);
            font-size: 0.95rem;
        }

        .waiting-dots {
            display: inline-flex;
            gap: 4px;
            margin-left: 6px;
        }

        .waiting-dot {
            width: 5px;
            height: 5px;
            background: var(--accent);
            border-radius: 50%;
            animation: dotBounce 1.4s ease-in-out infinite;
        }

        .waiting-dot:nth-child(2) { animation-delay: 0.15s; }
        .waiting-dot:nth-child(3) { animation-delay: 0.3s; }

        @keyframes dotBounce {
            0%, 80%, 100% { transform: translateY(0); opacity: 0.4; }
            40% { transform: translateY(-5px); opacity: 1; }
        }

        .btn {
            width: 100%;
            padding: 1rem;
            border-radius: 10px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.3rem;
            letter-spacing: 3px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            box-shadow: 0 4px 20px var(--accent-glow);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px var(--accent-glow);
            filter: brightness(1.1);
        }

        .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none !important; }

        /* ========== MODAL ========== */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
            overflow-y: auto;
        }

        .modal-overlay.visible { display: flex; }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 20px;
            width: 100%;
            max-width: 480px;
            max-height: calc(100vh - 2rem);
            display: flex;
            flex-direction: column;
            animation: modalIn 0.25s ease;
            box-shadow: 0 0 60px var(--accent-glow);
            margin: auto;
        }

        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.95) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .modal-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.4rem;
            letter-spacing: 2px;
            color: var(--accent);
        }

        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            line-height: 1;
            transition: color 0.2s;
        }

        .modal-close:hover { color: var(--text); }

        .modal-body {
            padding: 1.5rem;
            color: var(--text-muted);
            line-height: 1.7;
            overflow-y: auto;
            flex: 1;
        }

        .modal-body h3 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.1rem;
            color: var(--accent);
            margin-top: 1.25rem;
            margin-bottom: 0.4rem;
            letter-spacing: 1px;
        }

        .modal-body h3:first-child { margin-top: 0; }
        .modal-body p { margin-bottom: 0.75rem; }
        .modal-body ul { margin-left: 1.25rem; margin-bottom: 0.75rem; }
        .modal-body li { margin-bottom: 0.35rem; color: var(--text); }
        .modal-body strong { color: var(--accent); }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            flex-shrink: 0;
        }

        .modal-btn {
            width: 100%;
            padding: 0.8rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 10px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.1rem;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .modal-btn:hover { filter: brightness(1.1); }

        /* Confirm Modal */
        .confirm-modal .modal-body { text-align: center; padding: 2rem 1.5rem; }
        .confirm-modal .modal-message { font-size: 1rem; color: var(--text); margin-bottom: 1.5rem; }
        .confirm-modal .modal-actions { display: flex; gap: 0.75rem; }
        .confirm-modal .modal-btn { flex: 1; }
        .confirm-modal .modal-btn.cancel { background: var(--bg-primary); border: 1px solid var(--border); color: var(--text-muted); }
        .confirm-modal .modal-btn.danger { background: var(--red); }

        /* ========== FOOTER ========== */
        footer { 
            background: #000; 
            position: relative; 
            z-index: 10;
            margin-top: auto; 
        }
        
        .footer-border { 
            height: 3px; 
            background: linear-gradient(90deg, #ff6b9d, #4facfe, #a855f7, #ff6b9d); 
            background-size: 300% 100%; 
            animation: gradientSlide 6s linear infinite; 
        }
        
        @keyframes gradientSlide { 0% { background-position: 0% 50%; } 100% { background-position: 300% 50%; } }
        
        .footer-main { max-width: 1100px; margin: 0 auto; padding: 40px 20px 25px; }
        
        .footer-links { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 30px; 
            max-width: 500px; 
            margin-left: auto; 
            margin-right: auto; 
        }
        
        .footer-column { text-align: center; }
        .footer-column h5 { 
            font-family: 'Bebas Neue', sans-serif; 
            font-size: 0.9rem; 
            letter-spacing: 2px; 
            margin-bottom: 12px; 
            color: rgba(255, 255, 255, 0.8); 
        }
        .footer-column ul { list-style: none; display: flex; flex-direction: column; gap: 8px; }
        .footer-column a { color: rgba(255, 255, 255, 0.4); font-size: 0.85rem; transition: color 0.2s ease; text-decoration: none; }
        .footer-column a:hover { color: var(--accent); }
        
        .footer-bottom { padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.06); text-align: center; }
        .footer-copyright { font-size: 0.8rem; color: rgba(255, 255, 255, 0.35); margin-bottom: 10px; }
        .footer-legal { display: flex; justify-content: center; gap: 20px; }
        .footer-legal a { color: rgba(255, 255, 255, 0.35); font-size: 0.75rem; text-decoration: none; transition: color 0.2s; }
        .footer-legal a:hover { color: white; }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 600px) {
            header { height: 56px; padding: 0 14px; }
            .nav-inner { gap: 12px; }
            .header-logo { font-size: 1.4rem; letter-spacing: 3px; }
            .back-btn { padding: 6px 10px; font-size: 0.75rem; }
            .back-btn span { display: none; }
            
            main { padding: 70px 16px 30px; }

            .game-title { font-size: 2.4rem; }

            .room-code-card { padding: 1.5rem; }
            .room-code-value { font-size: 3.5rem; letter-spacing: 8px; }
            .room-code-actions { flex-direction: column; }
            .copy-btn { width: 100%; justify-content: center; }

            .players-section, .settings-section { padding: 1rem; }
            .player-item { padding: 0.6rem 0.75rem; }
            .player-avatar { width: 28px; height: 28px; font-size: 0.8rem; }
            .player-name { font-size: 0.85rem; }
            .kick-btn { opacity: 1; }

            .btn { padding: 0.9rem; font-size: 1.15rem; }

            .modal { max-height: calc(100vh - 1rem); border-radius: 16px; }
            .modal-header { padding: 1rem 1.25rem; }
            .modal-body { padding: 1.25rem; }
            .modal-footer { padding: 0.85rem 1.25rem; }
            
            .footer-links { grid-template-columns: 1fr; gap: 20px; }
            .footer-main { padding: 30px 20px 20px; }
        }

        @media (max-height: 700px) {
            .modal { max-height: calc(100vh - 1rem); }
            .modal-body { max-height: 50vh; }
        }
    </style>
</head>
<body class="theme-spyfall">

<div class="bg-container">
    <div class="bg-gradient"></div>
    <div class="glow-orb"></div>
    <div class="glow-orb"></div>
    <div class="grid-overlay"></div>
</div>

<header>
    <nav class="nav-inner">
        <div class="nav-left">
            <a href="/squad-games.html" class="back-btn" id="leave-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                <span>Leave</span>
            </a>
        </div>
        <a href="/" class="header-logo">THEGAMING.CO</a>
        <div class="nav-right-wrapper">
            <div class="header-actions">
                <div class="user-pill-skeleton" id="auth-skeleton"></div>
                <div class="nav-right-logged-out">
                    <a href="login.html" class="auth-link">Sign In</a>
                </div>
                <div class="nav-right-logged-in">
                    <div class="user-menu-wrapper">
                        <button class="user-pill" type="button" id="user-menu-button" aria-haspopup="true" aria-expanded="false">
                            <span class="user-pill-label" id="header-username-label">Player</span>
                        </button>
                        <div class="user-menu" id="user-menu" role="menu">
                            <a href="profile.html" class="user-menu-item" role="menuitem"><span>Profile</span></a>
                            <button type="button" class="user-menu-item" id="user-menu-signout" role="menuitem"><span>Sign Out</span></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>
</header>

<main>
        <div class="game-header">
        <h1 class="game-title" id="game-title">SPY HUNT</h1>
        <button class="how-to-play-btn" onclick="showHowToPlay()">How to Play</button>
    </div>

        <div class="room-code-section">
        <div class="room-code-card">
            <div class="room-code-label">Share This Code</div>
            <div class="room-code-value" id="room-code">------</div>
            <div class="room-code-hint">Join at thegaming.co/lobby</div>
            <div class="room-code-actions">
                <button class="copy-btn" id="copy-code-btn" onclick="copyRoomCode()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                    Copy Code
                </button>
                <button class="copy-btn" id="copy-link-btn" onclick="copyLink()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                    Copy Link
                </button>
            </div>
        </div>
    </div>

        <div class="players-section">
        <div class="players-header">
            <h2 class="players-title">Players </h2>
            <div class="players-count"><span id="player-count">0</span>/<span id="max-players">20</span></div>
        </div>
        <div class="players-list" id="players-list">
            <div class="players-empty">Connecting...</div>
        </div>
    </div>

        <div class="settings-section" id="settings-section" style="display: none;">
        <div class="settings-header">
            <h2 class="settings-title">Settings</h2>
            <span class="host-badge">Host</span>
        </div>
        
        <div class="setting-group" id="category-group">
            <label class="setting-label" id="category-label">Location Pack</label>
            <select class="setting-select" id="category-select" onchange="updateLocationPreview()"></select>
            <div class="location-preview" id="location-preview" style="display: none;">
                <div class="location-preview-title">Included Locations</div>
                <div class="location-tags" id="location-tags"></div>
            </div>
        </div>

        <div class="setting-group" id="two-spies-group" style="display: none;">
            <label class="setting-checkbox" for="two-spies">
                <input type="checkbox" id="two-spies">
                <div class="setting-checkbox-text">
                    <div class="setting-checkbox-title">Two Spies Mode</div>
                    <div class="setting-checkbox-desc">Requires 5+ players</div>
                </div>
            </label>
        </div>
    </div>

        <div class="start-section">
        <div class="min-players-warning" id="min-warning" style="display: none;">
            Need <span id="min-players">4</span> players to start
        </div>
        <div class="waiting-message" id="waiting-message" style="display: none;">
            Waiting for host to start
            <span class="waiting-dots">
                <span class="waiting-dot"></span>
                <span class="waiting-dot"></span>
                <span class="waiting-dot"></span>
            </span>
        </div>
        <button class="btn btn-primary" id="start-btn" onclick="startGame()" style="display: none;">
            Start Game
        </button>
    </div>
</main>

<div class="modal-overlay" id="how-to-play-modal">
    <div class="modal">
        <div class="modal-header">
            <h2 class="modal-title" id="modal-title">How to Play</h2>
            <button class="modal-close" onclick="closeModal('how-to-play-modal')">&times;</button>
        </div>
        <div class="modal-body" id="modal-body"></div>
        <div class="modal-footer">
            <button class="modal-btn" onclick="closeModal('how-to-play-modal')">Got It</button>
        </div>
    </div>
</div>

<div class="modal-overlay confirm-modal" id="confirm-modal">
    <div class="modal">
        <div class="modal-header">
            <h2 class="modal-title" id="confirm-title">Confirm</h2>
            <button class="modal-close" onclick="closeModal('confirm-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <p class="modal-message" id="confirm-message">Are you sure?</p>
            <div class="modal-actions">
                <button class="modal-btn cancel" onclick="closeModal('confirm-modal')">Cancel</button>
                <button class="modal-btn danger" id="confirm-btn" onclick="confirmAction()">Confirm</button>
            </div>
        </div>
    </div>
</div>

<footer>
    <div class="footer-border"></div>
    <div class="footer-main">
        <div class="footer-links">
            <div class="footer-column">
                <h5>GAMES</h5>
                <ul>
                    <li><a href="/solo.html">Solo</a></li>
                    <li><a href="/squad-games.html">Squad</a></li>
                    <li><a href="/party-games.html">Party</a></li>
                </ul>
            </div>
            <div class="footer-column">
                <h5>COMMUNITY</h5>
                <ul>
                    <li><a href="/leaderboards.html">Leaderboards</a></li>
                    <li><a href="/supporters.html">Supporters</a></li>
                </ul>
            </div>
            <div class="footer-column">
                <h5>COMPANY</h5>
                <ul>
                    <li><a href="/about.html">About</a></li>
                    <li><a href="/contact.html">Contact</a></li>
            </ul>
        </div>
        </div>
        <div class="footer-bottom">
            <p class="footer-copyright">© 2025 TheGaming.co — Free party games, forever.</p>
            <div class="footer-legal">
                <a href="/privacy.html">Privacy</a>
                <a href="/terms.html">Terms</a>
            </div>
        </div>
    </div>
</footer>

<script>
    const BACKEND_URL = 'https://web-production-519c7.up.railway.app';
    const socket = io(BACKEND_URL, { transports: ['websocket', 'polling'] });

    // ========== SUPABASE AUTH ==========
    const SUPABASE_URL = 'https://tvvivtmzofsyehatzlvl.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR2dml2dG16b2ZzeWVoYXR6bHZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4OTExODYsImV4cCI6MjA4MDQ2NzE4Nn0.Qy8kHMO0Nb4yJ0ZHjby7RuQtzwWB8rUcZvkdnbL1b3M';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const authSkeleton = document.getElementById('auth-skeleton');
    const loggedOutNav = document.querySelector('.nav-right-logged-out');
    const loggedInNav = document.querySelector('.nav-right-logged-in');
    const headerUsernameLabel = document.getElementById('header-username-label');
    const userMenuButton = document.getElementById('user-menu-button');
    const userMenu = document.getElementById('user-menu');
    const userMenuSignOut = document.getElementById('user-menu-signout');

    (function primeHeaderFromCache() {
        try {
            const cachedLabel = localStorage.getItem('tgco_header_label');
            const cachedFull = localStorage.getItem('tgco_header_full');
            if (cachedLabel && cachedFull) {
                headerUsernameLabel.textContent = cachedLabel;
                headerUsernameLabel.title = cachedFull;
                if (authSkeleton) authSkeleton.style.display = 'none';
                if (loggedInNav) loggedInNav.style.setProperty('display', 'flex', 'important');
            } else {
                if (authSkeleton) authSkeleton.style.display = 'none';
                if (loggedOutNav) loggedOutNav.style.setProperty('display', 'flex', 'important');
            }
        } catch (e) {
            if (authSkeleton) authSkeleton.style.display = 'none';
            if (loggedOutNav) loggedOutNav.style.setProperty('display', 'flex', 'important');
        }
    })();

    function updateAuthUI(user) {
        if (authSkeleton) authSkeleton.style.display = 'none';
        if (user) {
            if (loggedOutNav) loggedOutNav.style.setProperty('display', 'none', 'important');
            if (loggedInNav) loggedInNav.style.setProperty('display', 'flex', 'important');
        } else {
            if (loggedOutNav) loggedOutNav.style.setProperty('display', 'flex', 'important');
            if (loggedInNav) loggedInNav.style.setProperty('display', 'none', 'important');
            try { localStorage.removeItem('tgco_header_label'); localStorage.removeItem('tgco_header_full'); } catch (e) {}
        }
    }

    function applyHeaderNameFromProfile(display_name, gamer_tag, user) {
        const base = (display_name && display_name.trim()) || (gamer_tag && gamer_tag.trim()) || (user && user.email && user.email.split('@')[0]) || '';
        const trimmed = base.trim();
        if (!trimmed) { headerUsernameLabel.textContent = 'Player'; headerUsernameLabel.title = ''; return; }
        const maxLen = 16;
        let label = trimmed;
        if (label.length > maxLen) label = label.slice(0, maxLen - 1) + '…';
        headerUsernameLabel.textContent = label;
        headerUsernameLabel.title = trimmed;
        try { localStorage.setItem('tgco_header_full', trimmed); localStorage.setItem('tgco_header_label', label); } catch (e) {}
    }

    async function loadSessionAndProfile() {
        const { data, error } = await supabaseClient.auth.getSession();
        if (error) { updateAuthUI(null); return; }
        const user = data?.session?.user ?? null;
        updateAuthUI(user);
        if (!user) return;
        try {
            const { data: profile, error: profErr, status } = await supabaseClient.from('profiles').select('display_name,gamer_tag').eq('id', user.id).single();
            if (profErr && status !== 406) { applyHeaderNameFromProfile(null, null, user); return; }
            if (profile) { applyHeaderNameFromProfile(profile.display_name, profile.gamer_tag, user); } else { applyHeaderNameFromProfile(null, null, user); }
        } catch (err) { applyHeaderNameFromProfile(null, null, user); }
    }

    loadSessionAndProfile();
    supabaseClient.auth.onAuthStateChange((_event, session) => { const user = session?.user ?? null; updateAuthUI(user); if (user) loadSessionAndProfile(); });

    let userMenuOpen = false;
    function setUserMenuOpen(open) {
        userMenuOpen = open;
        if (!userMenuButton || !userMenu) return;
        if (open) { userMenu.classList.add('open'); userMenuButton.setAttribute('aria-expanded', 'true'); }
        else { userMenu.classList.remove('open'); userMenuButton.setAttribute('aria-expanded', 'false'); }
    }
    if (userMenuButton && userMenu) {
        userMenuButton.addEventListener('click', (event) => { event.stopPropagation(); setUserMenuOpen(!userMenuOpen); });
        document.addEventListener('click', () => { if (userMenuOpen) setUserMenuOpen(false); });
        document.addEventListener('keydown', (event) => { if (event.key === 'Escape') setUserMenuOpen(false); });
    }
    async function signOutUser() {
        try { localStorage.removeItem('tgco_header_label'); localStorage.removeItem('tgco_header_full'); } catch (e) {}
        await supabaseClient.auth.signOut();
        window.location.href = '/';
    }
    if (userMenuSignOut) { userMenuSignOut.addEventListener('click', (event) => { event.preventDefault(); setUserMenuOpen(false); signOutUser(); }); }

    // START OF NEW GAMES OBJECT
    const GAMES = {
        // ==================== DECEPTION & DEDUCTION ====================
        'spyfall': {
            displayName: 'SPY HUNT', backendType: 'spyfall', theme: 'theme-spyfall',
            minPlayers: 4, maxPlayers: 20, categoryLabel: 'Location Pack',
            categories: [
                { value: 'random', text: '🎲 Random (All)' },
                { value: 'classic', text: '🏛️ Classic' },
                { value: 'modern', text: '🏙️ Modern Life' },
                { value: 'adult', text: '🔞 Adult (18+)' },
                { value: 'marvel', text: '🦸 Marvel' },
                { value: 'dc', text: '🦇 DC' },
                { value: 'movies', text: '🎬 Movies & Shows' },
                { value: 'medieval', text: '⚔️ Medieval' },
                { value: 'websites', text: '🌐 Websites' },
                { value: 'popculture', text: '📺 Pop Culture' },
                { value: 'anime', text: '🎌 Anime' },
                { value: 'horror', text: '🔪 Horror' },
                { value: 'realitytv', text: '📺 Reality TV' },
                { value: 'videogames', text: '🎮 Video Games' },
                { value: 'bollywood', text: '🇮🇳 Bollywood' }
            ],
            showTwoSpies: true, showLocationPreview: true,
            howToPlay: `<h3>The Setup</h3><p>One player is randomly chosen as the <strong>Spy</strong>. Everyone else sees a secret location and their role. The Spy sees nothing.</p><h3>How to Play</h3><p>Players take turns asking each other questions. The goal is to identify the Spy without revealing the location.</p><ul><li>Ask questions someone at the location would know</li><li>Answer vaguely to not give away the location</li><li>Watch for suspicious answers</li></ul><h3>Winning</h3><ul><li><strong>Players win</strong> by voting out the Spy</li><li><strong>Spy wins</strong> by guessing the location OR surviving the vote</li></ul>`,
            gameFile: '/spyfall.html'
        },
        'avalon': {
            displayName: 'SECRET ROLES', backendType: 'avalon', theme: 'theme-avalon',
            minPlayers: 5, maxPlayers: 15, categoryLabel: 'Game Mode',
            categories: [{ value: 'standard', text: 'Standard' }, { value: 'advanced', text: 'Advanced Roles' }],
            showTwoSpies: false, showLocationPreview: false,
            howToPlay: `<h3>The Setup</h3><p>Players are secretly <strong>Loyal Servants</strong> or <strong>Minions of Mordred</strong>.</p><h3>Quests</h3><p>Vote on teams for quests. Quest members secretly choose success or fail.</p><h3>Winning</h3><ul><li><strong>Good wins</strong> if 3 quests succeed</li><li><strong>Evil wins</strong> if 3 quests fail OR Assassin kills Merlin</li></ul>`,
            gameFile: '/avalon.html'
        },
        'werewolf': {
            displayName: 'MAFIA', backendType: 'werewolf', theme: 'theme-werewolf',
            minPlayers: 6, maxPlayers: 20, categoryLabel: 'Mode',
            categories: [{ value: 'standard', text: 'Standard' }, { value: 'extended', text: 'Extended Roles' }],
            showTwoSpies: false, showLocationPreview: false,
            howToPlay: `<h3>Roles</h3><ul><li><strong>Mafia</strong> — Eliminate villagers at night</li><li><strong>Seer</strong> — Check one player per night</li><li><strong>Doctor</strong> — Protect one player per night</li><li><strong>Villager</strong> — Find the mafia</li></ul><h3>Winning</h3><ul><li>Villagers win when all mafia are gone</li><li>Mafia wins when they outnumber villagers</li></ul>`,
            gameFile: '/werewolf.html'
        },
        'imposter': {
            displayName: 'IMPOSTER', backendType: 'imposter', theme: 'theme-imposter',
            minPlayers: 4, maxPlayers: 10, categoryLabel: 'Word Pack',
            categories: [{ value: 'standard', text: 'Standard' }, { value: 'hard', text: 'Hard Mode' }],
            showTwoSpies: false, showLocationPreview: false,
            howToPlay: `<h3>The Setup</h3><p>Everyone except the <strong>Imposter</strong> sees a secret word.</p><h3>How to Play</h3><p>Take turns giving one-word clues. The Imposter must fake it!</p><h3>Winning</h3><ul><li><strong>Players win</strong> if they identify the Imposter</li><li><strong>Imposter wins</strong> if they avoid detection OR guess the word</li></ul>`,
            gameFile: '/imposter.html'
        },
        'fake-artist': {
            displayName: 'FAKE ARTIST', backendType: 'fake-artist', theme: 'theme-fake-artist',
            minPlayers: 4, maxPlayers: 10, categoryLabel: 'Difficulty',
            categories: [{ value: 'easy', text: 'Easy' }, { value: 'medium', text: 'Medium' }, { value: 'hard', text: 'Hard' }],
            showTwoSpies: false, showLocationPreview: false,
            howToPlay: `<h3>The Setup</h3><p>Everyone except the Fake Artist sees the drawing topic.</p><h3>Drawing</h3><ul><li>Take turns adding ONE stroke</li><li>Fake Artist must blend in</li></ul><h3>Winning</h3><ul><li>Players win by identifying the Fake Artist</li><li>Fake Artist wins by avoiding detection OR guessing the topic</li></ul>`,
            gameFile: '/fake-artist.html'
        },
        'insider': {
            displayName: 'INSIDER', backendType: 'insider', theme: 'theme-insider',
            minPlayers: 4, maxPlayers: 8, categoryLabel: 'Word Pack',
            categories: [{ value: 'standard', text: 'Standard' }, { value: 'hard', text: 'Hard Mode' }],
            showTwoSpies: false, showLocationPreview: false,
            howToPlay: `<h3>The Setup</h3><p>One player is the <strong>Master</strong> who knows the word. Another is the secret <strong>Insider</strong>.</p><h3>The Game</h3><p>Ask yes/no questions. The Insider subtly guides the group.</p><h3>Winning</h3><ul><li><strong>Players win</strong> if they identify the Insider</li><li><strong>Insider wins</strong> if they avoid detection</li></ul>`,
            gameFile: '/insider.html'
        },
        // ==================== WORD & TEAM GAMES ====================
        'codenames': {
            displayName: 'CODEWORDS', backendType: 'codenames', theme: 'theme-codenames',
            minPlayers: 4, maxPlayers: 20, categoryLabel: 'Word Pack',
            categories: [{ value: 'standard', text: 'Standard' }, { value: 'duet', text: 'Duet (Co-op)' }],
            showTwoSpies: false, showLocationPreview: false,
            howToPlay: `<h3>Teams</h3><p>Split into Red and Blue teams. Each has one Spymaster and Operatives.</p><h3>Giving Clues</h3><p>Spymasters give a one-word clue and number (e.g., "ANIMALS 3").</p><h3>Winning</h3><ul><li>Find all your words first to win</li><li>Hit the Assassin = instant loss</li></ul>`,
            gameFile: '/codenames.html'
        },
        'categories': {
            displayName: 'CATEGORIES', backendType: 'categories', theme: 'theme-categories',
            minPlayers: 2, maxPlayers: 20, categoryLabel: 'Rounds',
            categories: [{ value: '5', text: '5 Rounds' }, { value: '10', text: '10 Rounds' }, { value: '15', text: '15 Rounds' }],
            showTwoSpies: false, showLocationPreview: false,
            howToPlay: `<h3>The Game</h3><p>A category appears. Race to type a valid answer first!</p><h3>Scoring</h3><ul><li>First valid answer scores the point</li><li>Invalid answers can be challenged</li></ul><h3>Winning</h3><p>Most points after all rounds wins!</p>`,
            gameFile: '/categories.html'
        },
        'word-association': {
            displayName: 'WORD ASSOCIATION', backendType: 'word-association', theme: 'theme-word-association',
            minPlayers: 3, maxPlayers: 12, categoryLabel: 'Starting Lives',
            categories: [{ value: '2', text: '2 Lives' }, { value: '3', text: '3 Lives' }, { value: '5', text: '5 Lives' }],
            showTwoSpies: false, showLocationPreview: false,
            howToPlay: `<h3>The Game</h3><p>Say a word related to the previous one before time runs out!</p><h3>Rules</h3><ul><li>No repeating words</li><li>Timer gets faster as players are eliminated</li></ul><h3>Winning</h3><p>Last player standing wins!</p>`,
            gameFile: '/word-association.html'
        },
        'wavelength': {
            displayName: 'SPECTRUM', backendType: 'wavelength', theme: 'theme-wavelength',
            minPlayers: 4, maxPlayers: 12, categoryLabel: 'Points to Win',
            categories: [{ value: '10', text: '10 Points' }, { value: '15', text: '15 Points' }, { value: '20', text: '20 Points' }],
            showTwoSpies: false, showLocationPreview: false,
            howToPlay: `<h3>The Setup</h3><p>A spectrum appears with two opposites. A hidden target is placed somewhere.</p><h3>Giving Clues</h3><p>Give a clue to help your team find the target on the spectrum.</p><h3>Winning</h3><p>First team to the target score wins!</p>`,
            gameFile: '/wavelength.html'
        },
        'herd-mentality': {
            displayName: 'THINK ALIKE', backendType: 'herd-mentality', theme: 'theme-herd-mentality',
            minPlayers: 4, maxPlayers: 20, categoryLabel: 'Points to Win',
            categories: [{ value: 'quick', text: 'Quick (5)' }, { value: 'standard', text: 'Standard (8)' }, { value: 'marathon', text: 'Marathon (12)' }],
            showTwoSpies: false, showLocationPreview: false,
            howToPlay: `<h3>The Game</h3><p>Answer questions to match the majority.</p><h3>Scoring</h3><ul><li>Match majority = 1 point</li><li>Unique answer = Pink Cow</li></ul><h3>Pink Cow</h3><p>You CAN'T win while holding it!</p>`,
            gameFile: '/herd-mentality.html'
        },
        'word-bomb': {
            displayName: 'WORD BOMB', backendType: 'word-bomb', theme: 'theme-word-bomb',
            minPlayers: 2, maxPlayers: 16, categoryLabel: 'Difficulty',
            categories: [{ value: 'easy', text: 'Easy' }, { value: 'medium', text: 'Medium' }, { value: 'hard', text: 'Hard' }],
            showTwoSpies: false, showLocationPreview: false,
            howToPlay: `<h3>The Game</h3><p>Type a valid word containing the given letter combination before time runs out.</p><h3>Rules</h3><ul><li>Each word can only be used once</li><li>Words must be real English words</li><li>If time runs out, you lose a life</li></ul><h3>Winning</h3><p>Last player standing wins!</p>`,
            gameFile: '/word-bomb.html'
        },
        'npat': {
            displayName: 'NAME PLACE ANIMAL THING', backendType: 'npat', theme: 'theme-npat',
            minPlayers: 2, maxPlayers: 20, categoryLabel: 'Time Per Round',
            categories: [
                { value: '30', text: '30 seconds' },
                { value: '45', text: '45 seconds' },
                { value: '60', text: '60 seconds' },
                { value: '90', text: '90 seconds' }
            ],
            showTwoSpies: false, showLocationPreview: false,
            howToPlay: `<h3>The Game</h3><p>A random letter appears. Fill in words starting with that letter for each category before time runs out!</p><h3>Categories</h3><p>Name, Place, Animal, Thing — plus optional extras!</p><h3>Scoring</h3><ul><li><strong>10 points</strong> — Unique answer</li><li><strong>5 points</strong> — Shared answer</li><li><strong>0 points</strong> — Blank or invalid</li></ul>`,
            gameFile: '/npat.html'
        },
        // ==================== PARTY & PERFORMANCE ====================
        'charades': {
            displayName: 'CHARADES', backendType: 'charades', theme: 'theme-charades',
            minPlayers: 4, maxPlayers: 20, categoryLabel: 'Word Pack',
            categories: [{ value: 'standard', text: 'Standard' }, { value: 'movies', text: 'Movies' }, { value: 'actions', text: 'Actions' }],
            showTwoSpies: false, showLocationPreview: false,
            howToPlay: `<h3>The Setup</h3><p>Split into teams. One player acts while teammates guess.</p><h3>Rules</h3><ul><li>No speaking or sounds</li><li>Use gestures and mime only</li></ul><h3>Winning</h3><p>Team with most points wins!</p>`,
            gameFile: '/charades.html'
        },
        'celebrity': {
            displayName: 'CELEBRITY', backendType: 'celebrity', theme: 'theme-celebrity',
            minPlayers: 4, maxPlayers: 16, categoryLabel: 'Names Per Player',
            categories: [{ value: '2', text: '2 Names' }, { value: '3', text: '3 Names' }, { value: '5', text: '5 Names' }],
            showTwoSpies: false, showLocationPreview: false,
            howToPlay: `<h3>Three Rounds</h3><ul><li><strong>Round 1:</strong> Describe freely</li><li><strong>Round 2:</strong> One word only</li><li><strong>Round 3:</strong> Act it out</li></ul><h3>Winning</h3><p>Team with most points across all rounds wins!</p>`,
            gameFile: '/celebrity.html'
        },
        'fishbowl': {
            displayName: 'FISHBOWL', backendType: 'fishbowl', theme: 'theme-fishbowl',
            minPlayers: 6, maxPlayers: 20, categoryLabel: 'Words Per Player',
            categories: [{ value: '2', text: '2 Words' }, { value: '3', text: '3 Words' }, { value: '4', text: '4 Words' }],
            showTwoSpies: false, showLocationPreview: false,
            howToPlay: `<h3>Setup</h3><p>Everyone writes words/phrases on slips.</p><h3>Rounds</h3><ul><li><strong>Round 1:</strong> Taboo-style</li><li><strong>Round 2:</strong> One word</li><li><strong>Round 3:</strong> Charades</li></ul><h3>Winning</h3><p>Team with most total points wins!</p>`,
            gameFile: '/fishbowl.html'
        },
        'most-likely-to': {
            displayName: 'MOST LIKELY TO', backendType: 'most-likely-to', theme: 'theme-most-likely-to',
            minPlayers: 3, maxPlayers: 20, categoryLabel: 'Question Pack',
            categories: [{ value: 'clean', text: 'Clean' }, { value: 'spicy', text: 'Spicy' }, { value: 'random', text: 'Random Mix' }],
            showTwoSpies: false, showLocationPreview: false,
            howToPlay: `<h3>The Game</h3><p>A scenario appears. Vote on who in the group best fits!</p><h3>Reveal</h3><p>All votes are revealed. Laugh and debate!</p><h3>The Fun</h3><p>This game is more about laughs than winning!</p>`,
            gameFile: '/most-likely-to.html'
        },
  // ==================== PARTY GAMES (10-100 Players) ====================
        'trivia-royale': {
            displayName: 'TRIVIA ROYALE', backendType: 'trivia-royale', theme: 'theme-trivia-royale',
            minPlayers: 2, maxPlayers: 100, categoryLabel: 'Difficulty',
            categories: [{ value: 'mixed', text: 'Mixed' }, { value: 'easy', text: 'Easy' }, { value: 'hard', text: 'Hard' }],
            showTwoSpies: false, showLocationPreview: false, isPartyGame: true,
            howToPlay: `<h3>The Game</h3><p>10 rounds of trivia. Faster answers = more points!</p><h3>Scoring</h3><ul><li><strong>Base:</strong> 100 points for correct</li><li><strong>Speed Bonus:</strong> Up to +100 extra</li><li><strong>Streak:</strong> 2x multiplier at 3+ correct</li></ul>`,
            gameFile: '/trivia-royale.html'
        },
        'this-or-that-party': {
            displayName: 'THIS OR THAT', backendType: 'this-or-that-party', theme: 'theme-this-or-that-party',
            minPlayers: 2, maxPlayers: 100, categoryLabel: 'Question Pack',
            categories: [{ value: 'mixed', text: 'Mixed' }, { value: 'lifestyle', text: 'Lifestyle' }, { value: 'hypothetical', text: 'Hypothetical' }],
            showTwoSpies: false, showLocationPreview: false, isPartyGame: true,
            howToPlay: `<h3>The Game</h3><p>Choose between two options. Match the majority to score!</p><h3>Scoring</h3><ul><li>Score = your side's percentage</li><li>50/50 split = everyone gets 50</li></ul>`,
            gameFile: '/this-or-that-party.html'
        },
        'hot-takes-party': {
            displayName: 'HOT TAKES', backendType: 'hot-takes-party', theme: 'theme-hot-takes-party',
            minPlayers: 2, maxPlayers: 100, categoryLabel: 'Spice Level',
            categories: [{ value: 'mild', text: 'Mild' }, { value: 'medium', text: 'Medium' }, { value: 'spicy', text: 'Extra Spicy' }],
            showTwoSpies: false, showLocationPreview: false, isPartyGame: true,
            howToPlay: `<h3>The Game</h3><p>Rate statements 1-5. Match the crowd's average to score!</p><h3>Scoring</h3><ul><li>Exact match = 100 points</li><li>1 off = 50 points</li><li>3+ off = 0 points</li></ul>`,
            gameFile: '/hot-takes-party.html'
        },
        'never-ever-party': {
            displayName: 'NEVER HAVE I EVER', backendType: 'never-ever-party', theme: 'theme-never-ever-party',
            minPlayers: 2, maxPlayers: 100, categoryLabel: 'Question Pack',
            categories: [{ value: 'clean', text: 'Clean' }, { value: 'spicy', text: 'Spicy' }, { value: 'extreme', text: 'Extreme' }],
            showTwoSpies: false, showLocationPreview: false, isPartyGame: true,
            howToPlay: `<h3>The Game</h3><p>Vote if you HAVE or HAVE NOT done it.</p><h3>Scoring</h3><ul><li>Minority answer = more points!</li><li>Under 20% = 100 points</li><li>Over 80% = 20 points</li></ul>`,
            gameFile: '/never-ever-party.html'
        },
        'bet-or-bluff': {
            displayName: 'BET OR BLUFF', backendType: 'bet-or-bluff', theme: 'theme-bet-or-bluff',
            minPlayers: 2, maxPlayers: 100, categoryLabel: 'Starting Points',
            categories: [{ value: '500', text: '500 Points' }, { value: '1000', text: '1000 Points' }],
            showTwoSpies: false, showLocationPreview: false, isPartyGame: true,
            howToPlay: `<h3>Phase 1:</h3><p>Answer trivia secretly.</p><h3>Phase 2:</h3><p>Bet on yourself or the crowd!</p><h3>Scoring</h3><ul><li>Correct = 100 base</li><li>Winning bet = 2x wager</li></ul>`,
            gameFile: '/bet-or-bluff.html'
        }
    };
    // END OF NEW GAMES OBJECT

    const LOCATION_PACKS = {
        classic: ['Airport', 'Bank', 'Beach', 'Casino', 'Cathedral', 'Circus', 'Hospital', 'Hotel', 'Military Base', 'Movie Studio'],
        modern: ['Coffee Shop', 'Gym', 'Shopping Mall', 'Tech Startup', 'Spa', 'Escape Room', 'Coworking Space'],
        adult: ['Strip Club', 'Vegas Casino', 'Hookah Lounge', 'Wine Tasting', 'Nightclub', 'Speakeasy'],
        marvel: ['Avengers Tower', 'Asgard', 'Wakanda', 'X-Mansion', 'Stark Industries', 'SHIELD'],
        dc: ['Batcave', 'Fortress of Solitude', 'Arkham Asylum', 'Metropolis', 'Gotham City'],
        movies: ['Hogwarts', 'The Shire', 'Death Star', 'Jurassic Park', 'The Matrix'],
        medieval: ['Castle', 'Tavern', 'Blacksmith', 'Market', 'Monastery', 'Tournament'],
        websites: ['Reddit', 'YouTube', 'Discord', 'TikTok', 'Twitter', 'Twitch'],
        popculture: ['Squid Game', 'The Office', 'Friends', 'Stranger Things', 'Among Us'],
        anime: ['U.A. High School', 'Survey Corps HQ', 'Hidden Leaf Village', 'Thousand Sunny', 'Death Note HQ', 'Spirit Bathhouse', 'Demon Slayer Corps', 'Capsule Corp', 'Tokyo Jujutsu High', 'Hunter Exam Site', 'Sword Art Online', 'Ouran Host Club', 'Nerv HQ', 'Fairy Tail Guild', 'Anteiku Coffee Shop'],
        horror: ['Haunted Mansion', 'Camp Crystal Lake', 'Overlook Hotel', 'Elm Street', 'Cabin in the Woods', 'Raccoon City', 'The Conjuring House', 'Haddonfield', 'Saw Trap Room', 'Amityville House', 'The Upside Down', 'Purge Night', 'Silent Hill', 'Texas Chainsaw Farm', 'Shining Hedge Maze'],
        realitytv: ['Love Island Villa', 'Survivor Tribal Council', 'Big Brother House', 'Bachelor Mansion', 'Drag Race Werkroom', 'MasterChef Kitchen', 'The Circle', 'Jersey Shore', 'Amazing Race Pit Stop', "Hell's Kitchen", 'Kardashian Mansion', 'Shark Tank', 'Real World House', 'Too Hot to Handle', 'Queer Eye House'],
        videogames: ['Los Santos (GTA)', 'Hyrule Castle', 'Pokemon Gym', 'Verdansk Warzone', 'Lands Between', 'Rapture (Bioshock)', 'USG Ishimura', 'Aperture Science', 'Hogwarts Legacy', 'Night City', 'Silent Cartographer', 'Firelink Shrine', 'Sanctuary', 'Fortnite Island', 'City 17'],
        bollywood: ['DDLJ Train Platform', 'Bollywood Film Set', 'Big Fat Indian Wedding', '3 Idiots College', 'Mumbai Local Train', 'KJo House Party', 'IPL Stadium', 'Gangs of Wasseypur', 'Goa Beach Party', 'Bigg Boss House', 'Europe Trip (DDLJ)', 'Filmfare Awards', 'Sacred Games Mumbai', 'HAHK Wedding House', 'ZNMD Road Trip']
    };

    const urlParams = new URLSearchParams(window.location.search);
    const roomCode = urlParams.get('room') || localStorage.getItem('tempRoomCode');
    const playerName = localStorage.getItem('tempPlayerName');
    const isPremium = localStorage.getItem('tempIsPremium') === 'true';
    const myCosmetics = JSON.parse(localStorage.getItem('tempCosmetics') || 'null');
    const myUserId = localStorage.getItem('tempUserId') || null;

    let gameType = localStorage.getItem('tempGameType') || 'spyfall';
    let gameConfig = GAMES[gameType] || GAMES['spyfall'];
    let isHost = localStorage.getItem('tempIsHost') === 'true';
    let currentRoom = null;
    let myPlayerId = null;
    let confirmCallback = null;
    let joinAttempts = 0;
    const maxJoinAttempts = 3;

    // Validate we have required data
    console.log('Room code from URL:', urlParams.get('room'));
    console.log('Room code from localStorage:', localStorage.getItem('tempRoomCode'));
    console.log('Final room code:', roomCode);
    console.log('Player name:', playerName);
    console.log('Is host:', isHost);
    
    if (!roomCode || !playerName) {
        console.error('Missing room code or player name, redirecting to lobby');
        window.location.href = `/lobby.html?game=${gameType}`;
    }

    document.body.className = gameConfig.theme;
    document.getElementById('room-code').textContent = roomCode || '------';
    document.getElementById('max-players').textContent = gameConfig.maxPlayers;
    updateGameUI();

    // Set leave button URL based on game type
    const isPartyGame = gameConfig.isPartyGame || false;
    document.getElementById('leave-btn').href = isPartyGame ? '/party-games.html' : '/squad-games.html';
    
    function attemptJoinRoom() {
        if (!roomCode || !playerName) return;
        
        joinAttempts++;
        console.log(`Attempting to join room ${roomCode} (attempt ${joinAttempts}/${maxJoinAttempts})`);
        
        socket.emit('rejoin-room', { 
            roomCode, 
            playerName,
            isPremium,
            cosmetics: myCosmetics,
            userId: myUserId
        });
    }

    socket.on('connect', () => {
        console.log('Socket connected, joining room...');
        joinAttempts = 0;
        attemptJoinRoom();
    });

    socket.on('reconnect', () => {
        console.log('Socket reconnected, rejoining room...');
        joinAttempts = 0;
        attemptJoinRoom();
    });

    socket.on('room-joined', (data) => {
        console.log('Successfully joined room:', data.roomCode);
        joinAttempts = 0;
        handleRoomUpdate(data.room);
    });
    socket.on('room-state', (data) => { if (data.success) handleRoomUpdate(data.room); });
    socket.on('player-joined', (data) => handleRoomUpdate(data.room));
    socket.on('player-disconnected', (data) => handleRoomUpdate(data.room));
    socket.on('player-kicked', (data) => handleRoomUpdate(data.room));

    socket.on('kicked', (data) => showConfirm('Kicked', data.message, () => window.location.href = '/squad-games.html', false));
    socket.on('host-left', (data) => showConfirm('Host Left', data.message, () => window.location.href = '/squad-games.html', false));

    // MODIFIED: Incorporating new game redirections
 socket.on('game-started', (data) => { 
    console.log('Game started:', data);
    
    // Priority: server data > currentRoom > local variable
    const gameTypeFromData = data.gameType || currentRoom?.gameType || gameType;
    const targetGameConfig = GAMES[gameTypeFromData];

    if (targetGameConfig && targetGameConfig.gameFile) {
        window.location.href = `${targetGameConfig.gameFile}?room=${roomCode}`;
    } else {
        window.location.href = `/game-room-error.html?reason=UnknownGame&game=${gameTypeFromData}`;
    }
});

    socket.on('error', (data) => {
        console.error('Socket error:', data.message);
        // Retry if room not found and we haven't exceeded attempts
        if (data.message === 'Room not found' && joinAttempts < maxJoinAttempts) {
            console.log(`Room not found, retrying in 500ms...`);
            setTimeout(attemptJoinRoom, 500);
        } else if (data.message === 'Room not found') {
            // Room genuinely doesn't exist
            showConfirm('Room Expired', 'This room no longer exists. It may have been closed or the server restarted.', () => {
                // Clear old room data
                localStorage.removeItem('tempRoomCode');
                window.location.href = `/lobby.html?game=${gameType}`;
            }, false);
        } else {
            showConfirm('Error', data.message, () => window.location.href = `/lobby.html?game=${gameType}`, false);
        }
    });
    
    socket.on('join-error', (data) => {
        console.error('Join error:', data.message);
        showConfirm('Cannot Join', data.message, () => window.location.href = `/lobby.html?game=${gameType}`, false);
    });

    function handleRoomUpdate(room) {
        currentRoom = room;
        // Update gameType and gameConfig if the room dictates a different game
        if (room.gameType && room.gameType !== gameType) {
            gameType = room.gameType;
            gameConfig = GAMES[gameType] || GAMES['spyfall'];
            document.body.className = gameConfig.theme;
            updateGameUI();
        }

        const me = room.players.find(p => p.name === playerName);
        if (me) { myPlayerId = me.id; isHost = me.isHost; }

        updatePlayersList(room.players);
        document.getElementById('player-count').textContent = room.players.length;

        if (isHost) {
            document.getElementById('settings-section').style.display = 'block';
            document.getElementById('start-btn').style.display = 'block';
            document.getElementById('waiting-message').style.display = 'none';

            if (room.players.length < gameConfig.minPlayers) {
                document.getElementById('min-warning').style.display = 'block';
                document.getElementById('min-players').textContent = gameConfig.minPlayers;
                document.getElementById('start-btn').disabled = true;
            } else {
                document.getElementById('min-warning').style.display = 'none';
                document.getElementById('start-btn').disabled = false;
            }

            const twoSpies = document.getElementById('two-spies');
            if (twoSpies) { twoSpies.disabled = room.players.length < 5; if (room.players.length < 5) twoSpies.checked = false; }
        } else {
            document.getElementById('settings-section').style.display = 'none';
            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('waiting-message').style.display = 'block';
            document.getElementById('min-warning').style.display = 'none';
        }
    }

function updatePlayersList(players) {
        const list = document.getElementById('players-list');
        const isPartyGame = gameConfig.isPartyGame || false;
        
        // Add/remove party-mode class on body
        if (isPartyGame) {
            document.body.classList.add('party-mode');
        } else {
            document.body.classList.remove('party-mode');
        }
        
        if (!players.length) { 
            list.innerHTML = '<div class="players-empty">No players yet</div>'; 
            return; 
        }

        // Party game layout with count banner
        let html = '';
        if (isPartyGame) {
            const minPlayers = gameConfig.minPlayers || 10;
            const hasEnough = players.length >= minPlayers;
            html += `
                <div class="party-player-count">
                    <div>
                        <div class="count-number">${players.length}</div>
                        <div class="count-label">Players</div>
                    </div>
                    <div class="count-status ${hasEnough ? 'ready' : ''}">
                        ${hasEnough ? '✓ Ready to start!' : `Need ${minPlayers - players.length} more`}
                    </div>
                </div>
            `;
        }

        html += players.map((player, idx) => {
            const isMe = player.name === playerName;
            const playerIsPremium = player.isPremium || false;
            const playerCosmetics = player.cosmetics || {};
            
            // Use cosmetics.js to render the player card if available
            if (window.TGCOCosmetics && !isPartyGame) {
                return window.TGCOCosmetics.renderPlayerCard({
                    name: player.name,
                    cosmetics: playerCosmetics,
                    isPremium: playerIsPremium,
                    isHost: player.isHost,
                    isMe: isMe,
                    showEntrance: player.justJoined || false
                }) + (isHost && !player.isHost ? `<button class="kick-btn-floating" onclick="kickPlayer('${player.id}', '${escapeHtml(player.name)}')">✕</button>` : '');
            }
            
            // Standard/Party layout
            const initial = player.name.replace(/[^a-zA-Z]/g, '')[0]?.toUpperCase() || '?';
            const premiumClass = playerIsPremium ? 'premium' : '';
            
            if (isPartyGame) {
                // Compact party grid card
                return `
                    <div class="player-item ${player.isHost ? 'is-host' : ''} ${isMe ? 'is-me' : ''}" style="animation-delay: ${idx * 0.02}s">
                        <div class="player-avatar">${player.isHost ? '★' : initial}</div>
                        <span class="player-name ${premiumClass}">${escapeHtml(player.name)}</span>
                        ${player.isHost ? '<span class="badge-host-icon">👑</span>' : ''}
                    </div>
                `;
            } else {
                // Standard squad layout
                return `
                    <div class="player-item ${player.isHost ? 'is-host' : ''} ${isMe ? 'is-me' : ''}" style="animation-delay: ${idx * 0.05}s">
                        <div class="player-info">
                            <div class="player-avatar">${player.isHost ? '★' : initial}</div>
                            <span class="player-name ${premiumClass}">${escapeHtml(player.name)}</span>
                        </div>
                        <div class="player-badges">
                            ${player.isHost ? '<span class="badge badge-host">Host</span>' : ''}
                            ${isMe ? '<span class="badge badge-you">You</span>' : ''}
                            ${isHost && !player.isHost ? `<button class="kick-btn" onclick="kickPlayer('${player.id}', '${escapeHtml(player.name)}')">Kick</button>` : ''}
                        </div>
                    </div>
                `;
            }
        }).join('');

        list.innerHTML = html;
    }

    function updateGameUI() {
        document.getElementById('game-title').textContent = gameConfig.displayName;
        document.getElementById('modal-title').textContent = `How to Play ${gameConfig.displayName}`;
        document.getElementById('modal-body').innerHTML = gameConfig.howToPlay;
        document.getElementById('max-players').textContent = gameConfig.maxPlayers;
        document.title = `${gameConfig.displayName} Lobby - TheGaming.co`;

        document.getElementById('category-label').textContent = gameConfig.categoryLabel;
        const select = document.getElementById('category-select');
        select.innerHTML = gameConfig.categories.map(c => `<option value="${c.value}">${c.text}</option>`).join('');

        document.getElementById('two-spies-group').style.display = gameConfig.showTwoSpies ? 'block' : 'none';
        if (gameConfig.showLocationPreview) updateLocationPreview();
        else document.getElementById('location-preview').style.display = 'none';
    }

    function updateLocationPreview() {
        if (!gameConfig.showLocationPreview) return;
        const category = document.getElementById('category-select').value;
        const preview = document.getElementById('location-preview');
        const tags = document.getElementById('location-tags');

        if (category === 'random') {
            preview.style.display = 'block';
            tags.innerHTML = '<span class="location-tag">All packs combined</span>';
        } else if (LOCATION_PACKS[category]) {
            preview.style.display = 'block';
            const locs = LOCATION_PACKS[category];
            tags.innerHTML = locs.slice(0, 8).map(l => `<span class="location-tag">${l}</span>`).join('') + 
                (locs.length > 8 ? `<span class="location-tag">+${locs.length - 8} more</span>` : '');
        } else {
            preview.style.display = 'none';
        }
    }

    function copyRoomCode() {
        navigator.clipboard.writeText(roomCode);
        const btn = document.getElementById('copy-code-btn');
        btn.classList.add('copied');
        btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg> Copied`;
        setTimeout(() => {
            btn.classList.remove('copied');
            btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg> Copy Code`;
        }, 2000);
    }

    function copyLink() {
        const link = `${window.location.origin}/lobby.html?game=${gameType}&join=${roomCode}`;
        navigator.clipboard.writeText(link);
        const btn = document.getElementById('copy-link-btn');
        btn.classList.add('copied');
        btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg> Copied`;
        setTimeout(() => {
            btn.classList.remove('copied');
            btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg> Copy Link`;
        }, 2000);
    }

    function kickPlayer(playerId, name) {
        showConfirm('Kick Player', `Remove ${name}?`, () => socket.emit('kick-player', { roomCode, playerId }));
    }

    function startGame() {
        const category = document.getElementById('category-select').value;
        const twoSpies = document.getElementById('two-spies')?.checked || false;
        showConfirm('Start Game', 'Everyone ready?', () => socket.emit('start-game', { roomCode, category, twoSpies }));
    }

    function showHowToPlay() { document.getElementById('how-to-play-modal').classList.add('visible'); }

    function closeModal(id) { document.getElementById(id).classList.remove('visible'); }

    function showConfirm(title, message, callback, showCancel = true) {
        document.getElementById('confirm-title').textContent = title;
        document.getElementById('confirm-message').textContent = message;
        document.getElementById('confirm-modal').classList.add('visible');
        document.querySelector('#confirm-modal .cancel').style.display = showCancel ? 'block' : 'none';
        confirmCallback = callback;
    }

    function confirmAction() { closeModal('confirm-modal'); if (confirmCallback) confirmCallback(); }

    document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.classList.remove('visible'); });
    });

    function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }

    window.addEventListener('beforeunload', () => socket.disconnect());
</script>

</body>
</html>
