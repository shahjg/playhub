<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spy Hunt - TheGaming.co</title>
    
    <meta name="description" content="Find the Spy! A social deduction game.">
    <meta name="robots" content="noindex, nofollow">
    <meta name="theme-color" content="#0a0a0f">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --accent: #14b8a6;
            --accent-glow: rgba(20, 184, 166, 0.4);
            --accent-soft: rgba(20, 184, 166, 0.12);
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: rgba(255, 255, 255, 0.02);
            --border: rgba(255, 255, 255, 0.08);
            --border-accent: rgba(20, 184, 166, 0.3);
            --text: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.5);
            --gold: #fbbf24;
            --green: #22c55e;
            --red: #ef4444;
            --spy-red: #dc2626;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* ========== BACKGROUND ========== */
        .bg-container {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .bg-gradient {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: 
                radial-gradient(ellipse 80% 50% at 20% 0%, var(--accent-soft) 0%, transparent 50%),
                radial-gradient(ellipse 60% 40% at 90% 100%, var(--accent-soft) 0%, transparent 50%),
                var(--bg-primary);
            transition: background 0.5s ease;
        }

        .bg-gradient.spy-mode {
            background: 
                radial-gradient(ellipse 80% 50% at 20% 0%, rgba(220, 38, 38, 0.12) 0%, transparent 50%),
                radial-gradient(ellipse 60% 40% at 90% 100%, rgba(220, 38, 38, 0.12) 0%, transparent 50%),
                var(--bg-primary);
        }

        .glow-orb {
            position: absolute;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, var(--accent-glow) 0%, transparent 70%);
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.3;
            animation: orbFloat 25s ease-in-out infinite;
            transition: background 0.5s ease;
        }

        .spy-mode .glow-orb {
            background: radial-gradient(circle, rgba(220, 38, 38, 0.4) 0%, transparent 70%);
        }

        .glow-orb:nth-child(2) {
            width: 300px;
            height: 300px;
            animation-delay: -12s;
            animation-duration: 30s;
        }

        @keyframes orbFloat {
            0%, 100% { transform: translate(0, 0); }
            33% { transform: translate(60vw, 20vh); }
            66% { transform: translate(30vw, 60vh); }
        }

        .grid-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: 
                linear-gradient(var(--border) 1px, transparent 1px),
                linear-gradient(90deg, var(--border) 1px, transparent 1px);
            background-size: 60px 60px;
            opacity: 0.3;
        }

        /* ========== HEADER ========== */
        header {
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 100;
            height: 60px;
            display: flex;
            align-items: center;
            padding: 0 20px;
            background: rgba(10, 10, 15, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
        }

        .nav-inner {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .room-badge {
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 0.4rem 0.8rem;
            border-radius: 8px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1rem;
            letter-spacing: 2px;
            color: var(--accent);
        }

        .header-logo {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.4rem;
            letter-spacing: 3px;
            color: white;
            text-decoration: none;
        }

        .header-logo::after {
            content: '';
            display: block;
            height: 2px;
            background: linear-gradient(90deg, #ff6b9d, #4facfe, #a855f7);
            margin-top: 2px;
        }

        /* Timer */
        .timer-display {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 0.5rem 1rem;
            border-radius: 10px;
        }

        .timer-display svg {
            width: 20px;
            height: 20px;
            color: var(--accent);
        }

        .timer-display.warning svg { color: var(--gold); }
        .timer-display.danger svg { color: var(--red); animation: pulse 1s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .timer-value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem;
            letter-spacing: 2px;
            color: var(--text);
        }

        .timer-display.warning .timer-value { color: var(--gold); }
        .timer-display.danger .timer-value { color: var(--red); }

        /* ========== MAIN CONTENT ========== */
        main {
            flex: 1;
            padding: 80px 20px 40px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            position: relative;
            z-index: 1;
        }

        .game-grid {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 20px;
            min-height: calc(100vh - 160px);
        }

        /* ========== ROLE CARD ========== */
        .role-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .role-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border-accent);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .role-card::before {
            content: '';
            position: absolute;
            top: 0; left: 40px; right: 40px;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
        }

        .role-card.spy-card {
            border-color: rgba(220, 38, 38, 0.4);
            background: linear-gradient(180deg, rgba(220, 38, 38, 0.08) 0%, var(--bg-secondary) 100%);
        }

        .role-card.spy-card::before {
            background: linear-gradient(90deg, transparent, var(--spy-red), transparent);
        }

        .role-label {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .role-value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 3rem;
            letter-spacing: 4px;
            color: var(--accent);
            text-shadow: 0 0 40px var(--accent-glow);
            margin-bottom: 0.5rem;
        }

        .spy-card .role-value {
            color: var(--spy-red);
            text-shadow: 0 0 40px rgba(220, 38, 38, 0.5);
            font-size: 4rem;
        }

        .location-value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2rem;
            letter-spacing: 3px;
            color: var(--text);
            margin-bottom: 1rem;
        }

        .spy-hint {
            color: var(--text-muted);
            font-size: 0.9rem;
            line-height: 1.5;
            max-width: 400px;
            margin: 0 auto;
        }

        .role-divider {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 1rem 0;
        }

        .role-divider-line {
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        .role-divider-text {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-muted);
        }

        /* Hide/Show Role */
        .role-hidden {
            filter: blur(20px);
            user-select: none;
            pointer-events: none;
        }

        .toggle-role-btn {
            background: var(--accent-soft);
            border: 1px solid var(--border-accent);
            color: var(--accent);
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
            margin-top: 1rem;
        }

        .toggle-role-btn:hover {
            background: var(--accent);
            color: white;
        }

        /* ========== LOCATIONS GRID ========== */
        .locations-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.25rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .section-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.1rem;
            letter-spacing: 2px;
            color: var(--text);
        }

        .locations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 8px;
            max-height: 400px;
            overflow-y: auto;
        }

        .location-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.6rem 0.8rem;
            font-size: 0.8rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .location-item:hover {
            border-color: var(--accent);
            color: var(--text);
        }

        .location-item.crossed {
            text-decoration: line-through;
            opacity: 0.4;
        }

        .location-item.current {
            background: var(--accent-soft);
            border-color: var(--accent);
            color: var(--accent);
            font-weight: 700;
            pointer-events: none;
        }

        .locations-grid::-webkit-scrollbar { width: 5px; }
        .locations-grid::-webkit-scrollbar-track { background: transparent; }
        .locations-grid::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

        /* ========== SIDEBAR ========== */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* Players Panel */
        .players-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1rem;
        }

        .players-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 200px;
            overflow-y: auto;
        }

        .player-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0.7rem;
            background: var(--bg-card);
            border-radius: 8px;
            border: 1px solid transparent;
            transition: all 0.2s;
        }

        .player-row:hover { border-color: var(--border); }
        .player-row.is-me { border-color: var(--accent); }
        .player-row.eliminated { opacity: 0.4; }

        .player-row-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .player-avatar-small {
            width: 28px;
            height: 28px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 0.8rem;
            color: var(--accent);
        }

        .player-row-name {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text);
        }

        .player-row.eliminated .player-row-name {
            text-decoration: line-through;
        }

        .players-list::-webkit-scrollbar { width: 5px; }
        .players-list::-webkit-scrollbar-track { background: transparent; }
        .players-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

        /* Actions Panel */
        .actions-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1rem;
        }

        .action-btn {
            width: 100%;
            padding: 0.9rem;
            border-radius: 10px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.1rem;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            margin-bottom: 0.75rem;
        }

        .action-btn:last-child { margin-bottom: 0; }

        .action-btn.primary {
            background: var(--accent);
            color: white;
            box-shadow: 0 4px 15px var(--accent-glow);
        }

        .action-btn.primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px var(--accent-glow);
        }

        .action-btn.danger {
            background: var(--red);
            color: white;
        }

        .action-btn.danger:hover:not(:disabled) {
            filter: brightness(1.1);
        }

        .action-btn.secondary {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            color: var(--text);
        }

        .action-btn.secondary:hover:not(:disabled) {
            border-color: var(--accent);
        }

        .action-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none !important;
        }

        .action-hint {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: center;
            margin-top: 0.5rem;
        }

        /* Spy Guess Panel */
        .spy-guess-panel {
            background: linear-gradient(180deg, rgba(220, 38, 38, 0.1) 0%, var(--bg-secondary) 100%);
            border: 1px solid rgba(220, 38, 38, 0.3);
            border-radius: 16px;
            padding: 1rem;
        }

        .spy-guess-panel .section-title {
            color: var(--spy-red);
        }

        /* ========== OVERLAYS ========== */
        .overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
            padding: 1rem;
        }

        .overlay.visible { display: flex; }

        .overlay-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 24px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 2rem;
            text-align: center;
            animation: modalIn 0.3s ease;
        }

        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.9) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .overlay-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2rem;
            letter-spacing: 3px;
            color: var(--accent);
            margin-bottom: 0.5rem;
        }

        .overlay-subtitle {
            color: var(--text-muted);
            margin-bottom: 1.5rem;
        }

        .vote-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 1.5rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .vote-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.8rem 1rem;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .vote-option:hover { border-color: var(--accent); }
        .vote-option.selected { border-color: var(--accent); background: var(--accent-soft); }

        .vote-option-name {
            font-weight: 600;
            color: var(--text);
        }

        .vote-option-votes {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .overlay-actions {
            display: flex;
            gap: 0.75rem;
        }

        .overlay-btn {
            flex: 1;
            padding: 0.9rem;
            border-radius: 10px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.1rem;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .overlay-btn.primary { background: var(--accent); color: white; }
        .overlay-btn.secondary { background: var(--bg-primary); color: var(--text); border: 1px solid var(--border); }
        .overlay-btn:disabled { opacity: 0.4; cursor: not-allowed; }

        /* ========== GAME OVER OVERLAY ========== */
        .game-over-content {
            max-width: 600px;
        }

        .game-over-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 3rem;
            letter-spacing: 5px;
            margin-bottom: 0.5rem;
        }

        .game-over-title.winners { color: var(--green); }
        .game-over-title.spy-wins { color: var(--spy-red); }

        .game-over-subtitle {
            font-size: 1.1rem;
            color: var(--text-muted);
            margin-bottom: 2rem;
        }

        .reveal-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .reveal-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
        }

        .reveal-row:not(:last-child) {
            border-bottom: 1px solid var(--border);
        }

        .reveal-label {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .reveal-value {
            font-weight: 700;
            color: var(--accent);
        }

        .reveal-value.spy { color: var(--spy-red); }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 900px) {
            .game-grid {
                grid-template-columns: 1fr;
            }

            .sidebar {
                order: -1;
                flex-direction: row;
                flex-wrap: wrap;
            }

            .players-panel, .actions-panel, .spy-guess-panel {
                flex: 1;
                min-width: 200px;
            }

            .role-card { padding: 1.5rem; }
            .role-value { font-size: 2.5rem; }
            .spy-card .role-value { font-size: 3rem; }
            .location-value { font-size: 1.5rem; }
        }

        @media (max-width: 600px) {
            header { height: 56px; padding: 0 16px; }
            .header-logo { font-size: 1.2rem; }
            .room-badge { font-size: 0.85rem; padding: 0.3rem 0.6rem; }
            .timer-value { font-size: 1.2rem; }

            main { padding: 70px 16px 30px; }

            .sidebar { flex-direction: column; }
            .players-panel, .actions-panel, .spy-guess-panel { min-width: 100%; }

            .locations-grid { grid-template-columns: repeat(2, 1fr); }

            .overlay-content { padding: 1.5rem; }
            .overlay-title { font-size: 1.5rem; }
            .game-over-title { font-size: 2rem; }
        }
    </style>
</head>
<body>

<!-- Background -->
<div class="bg-container" id="bg-container">
    <div class="bg-gradient" id="bg-gradient"></div>
    <div class="glow-orb"></div>
    <div class="glow-orb"></div>
    <div class="grid-overlay"></div>
</div>

<!-- Header -->
<header>
    <nav class="nav-inner">
        <div class="header-left">
            <a href="/" class="header-logo">THEGAMING.CO</a>
            <div class="room-badge" id="room-badge">ROOM: ------</div>
        </div>
        <div class="timer-display" id="timer-display">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12 6 12 12 16 14"/>
            </svg>
            <span class="timer-value" id="timer-value">8:00</span>
        </div>
    </nav>
</header>

<!-- Main Content -->
<main>
    <div class="game-grid">
        <!-- Left: Role & Locations -->
        <div class="role-section">
            <!-- Role Card -->
            <div class="role-card" id="role-card">
                <div id="role-content">
                    <div class="role-label">Your Role</div>
                    <div class="role-value" id="role-name">Loading...</div>
                    <div class="role-divider">
                        <div class="role-divider-line"></div>
                        <span class="role-divider-text" id="role-divider-label">Location</span>
                        <div class="role-divider-line"></div>
                    </div>
                    <div class="location-value" id="location-name">---</div>
                    <p class="spy-hint" id="spy-hint" style="display: none;">
                        You don't know the location. Blend in by asking vague questions. Use the location list below to narrow it down.
                    </p>
                </div>
                <button class="toggle-role-btn" id="toggle-role-btn" onclick="toggleRoleVisibility()">
                    Hide Role
                </button>
            </div>

            <!-- Locations Reference -->
            <div class="locations-section">
                <div class="section-header">
                    <h2 class="section-title">All Locations</h2>
                    <span style="font-size: 0.75rem; color: var(--text-muted);">Click to cross off</span>
                </div>
                <div class="locations-grid" id="locations-grid">
                    <div style="padding: 2rem; text-align: center; color: var(--text-muted);">Loading locations...</div>
                </div>
            </div>
        </div>

        <!-- Right: Sidebar -->
        <div class="sidebar">
            <!-- Players -->
            <div class="players-panel">
                <div class="section-header">
                    <h2 class="section-title">Players</h2>
                    <span id="players-count" style="font-size: 0.8rem; color: var(--text-muted);">0</span>
                </div>
                <div class="players-list" id="players-list">
                    <div style="padding: 1rem; text-align: center; color: var(--text-muted);">Connecting...</div>
                </div>
            </div>

            <!-- Actions -->
            <div class="actions-panel" id="actions-panel">
                <div class="section-header">
                    <h2 class="section-title">Actions</h2>
                </div>
                <button class="action-btn primary" id="call-vote-btn" onclick="callVote()">
                    Call Vote
                </button>
                <p class="action-hint">Accuse someone of being the Spy</p>
            </div>

            <!-- Spy Guess (Only visible to Spy) -->
            <div class="spy-guess-panel" id="spy-guess-panel" style="display: none;">
                <div class="section-header">
                    <h2 class="section-title">Spy Action</h2>
                </div>
                <button class="action-btn danger" id="guess-location-btn" onclick="openSpyGuess()">
                    Guess Location
                </button>
                <p class="action-hint">Win instantly if you guess correctly!</p>
            </div>
        </div>
    </div>
</main>

<!-- Voting Overlay -->
<div class="overlay" id="vote-overlay">
    <div class="overlay-content">
        <h2 class="overlay-title">Vote</h2>
        <p class="overlay-subtitle">Who do you think is the Spy?</p>
        <div class="vote-options" id="vote-options"></div>
        <div class="overlay-actions">
            <button class="overlay-btn secondary" onclick="closeVote()">Cancel</button>
            <button class="overlay-btn primary" id="submit-vote-btn" onclick="submitVote()" disabled>Submit Vote</button>
        </div>
    </div>
</div>

<!-- Spy Guess Overlay -->
<div class="overlay" id="spy-guess-overlay">
    <div class="overlay-content">
        <h2 class="overlay-title" style="color: var(--spy-red);">Guess The Location</h2>
        <p class="overlay-subtitle">Choose wisely - you only get one guess!</p>
        <div class="vote-options" id="spy-guess-options"></div>
        <div class="overlay-actions">
            <button class="overlay-btn secondary" onclick="closeSpyGuess()">Cancel</button>
            <button class="overlay-btn primary" style="background: var(--spy-red);" id="submit-guess-btn" onclick="submitSpyGuess()" disabled>Guess</button>
        </div>
    </div>
</div>

<!-- Game Over Overlay -->
<div class="overlay" id="game-over-overlay">
    <div class="overlay-content game-over-content">
        <h2 class="game-over-title" id="game-over-title">Game Over</h2>
        <p class="game-over-subtitle" id="game-over-subtitle">Results</p>
        
        <div class="reveal-card">
            <div class="reveal-row">
                <span class="reveal-label">The Spy was</span>
                <span class="reveal-value spy" id="reveal-spy">Unknown</span>
            </div>
            <div class="reveal-row">
                <span class="reveal-label">The Location was</span>
                <span class="reveal-value" id="reveal-location">Unknown</span>
            </div>
        </div>

        <div class="overlay-actions">
            <button class="overlay-btn secondary" onclick="leaveGame()">Leave</button>
            <button class="overlay-btn primary" onclick="playAgain()">Play Again</button>
        </div>
    </div>
</div>

<script>
    // ========== CONFIG ==========
    const BACKEND_URL = 'https://web-production-519c7.up.railway.app';
    const socket = io(BACKEND_URL, { transports: ['websocket', 'polling'] });

    // ========== STATE ==========
    const urlParams = new URLSearchParams(window.location.search);
    const roomCode = urlParams.get('room') || localStorage.getItem('tempRoomCode');
    const playerName = localStorage.getItem('tempPlayerName');

    let gameState = {
        players: [],
        isSpy: false,
        location: null,
        role: null,
        allLocations: [],
        timeRemaining: 480,
        selectedVote: null,
        selectedGuess: null,
        crossedLocations: new Set(),
        roleHidden: false
    };

    // ========== INIT ==========
    document.getElementById('room-badge').textContent = `ROOM: ${roomCode || '------'}`;

    // ========== SOCKET EVENTS ==========
    socket.on('connect', () => {
        console.log('Connected to game server');
        if (roomCode && playerName) {
            socket.emit('rejoin-room', { roomCode, playerName });
        }
    });

    socket.on('room-joined', (data) => {
        console.log('Joined room:', data);
        if (data.room) {
            gameState.players = data.room.players;
            renderPlayers();
        }
    });

    socket.on('room-state', (data) => {
        if (data.room) {
            gameState.players = data.room.players;
            renderPlayers();
        }
    });

    socket.on('player-joined', (data) => {
        if (data.room) {
            gameState.players = data.room.players;
            renderPlayers();
        }
    });

    socket.on('player-disconnected', (data) => {
        if (data.room) {
            gameState.players = data.room.players;
            renderPlayers();
        }
    });

    // Role assignment from server
    socket.on('role-assigned', (data) => {
        console.log('Role assigned:', data);
        handleRoleAssignment(data);
    });

    // Timer updates
    socket.on('timer-update', (data) => {
        gameState.timeRemaining = data.timeRemaining;
        updateTimer();
    });

    // Question phase started
    socket.on('question-phase-start', (data) => {
        console.log('Question phase started');
        if (data.timeLimit) {
            gameState.timeRemaining = data.timeLimit;
            updateTimer();
        }
    });

    // Vote called
    socket.on('vote-called', (data) => {
        console.log('Vote called by:', data.caller);
        openVoteOverlay(data.caller);
    });

    // Vote count update
    socket.on('vote-counted', (data) => {
        console.log('Vote counted:', data);
    });

    // Spy caught (in two spies mode)
    socket.on('spy-caught', (data) => {
        alert(data.message);
        closeVote();
    });

    // Game over
    socket.on('game-over', (data) => {
        console.log('Game over:', data);
        showGameOver(data);
    });

    // Force return to lobby
    socket.on('force-return-lobby', (data) => {
        alert(data.message);
        window.location.href = `waiting-room.html?room=${roomCode}`;
    });

    // Host left
    socket.on('host-left', (data) => {
        alert(data.message);
        window.location.href = '/squad-games.html';
    });

    // Error handling
    socket.on('error', (data) => {
        console.error('Socket error:', data.message);
        alert(data.message);
    });

    // ========== ROLE HANDLING ==========
    function handleRoleAssignment(data) {
        // Backend sends: { isSpy, location, role, allLocations }
        gameState.isSpy = data.isSpy;
        gameState.location = data.location;
        gameState.role = data.role;
        gameState.allLocations = data.allLocations || [];

        // Update UI based on role
        if (gameState.isSpy) {
            document.getElementById('role-card').classList.add('spy-card');
            document.getElementById('role-name').textContent = 'SPY';
            document.getElementById('location-name').textContent = '???';
            document.getElementById('role-divider-label').textContent = 'Find the Location';
            document.getElementById('spy-hint').style.display = 'block';
            document.getElementById('spy-guess-panel').style.display = 'block';
            document.getElementById('bg-gradient').classList.add('spy-mode');
        } else {
            document.getElementById('role-card').classList.remove('spy-card');
            document.getElementById('role-name').textContent = data.role || 'Agent';
            document.getElementById('location-name').textContent = data.location || 'Unknown';
            document.getElementById('role-divider-label').textContent = 'Location';
            document.getElementById('spy-hint').style.display = 'none';
            document.getElementById('spy-guess-panel').style.display = 'none';
            document.getElementById('bg-gradient').classList.remove('spy-mode');
        }

        renderLocations();
    }

    // ========== RENDER FUNCTIONS ==========
    function renderLocations() {
        const grid = document.getElementById('locations-grid');
        const locations = gameState.allLocations;
        
        if (!locations || locations.length === 0) {
            grid.innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--text-muted);">No locations available</div>';
            return;
        }
        
        grid.innerHTML = locations.map(loc => {
            const isCurrent = !gameState.isSpy && loc === gameState.location;
            const isCrossed = gameState.crossedLocations.has(loc);
            
            return `
                <div class="location-item ${isCurrent ? 'current' : ''} ${isCrossed ? 'crossed' : ''}" 
                     onclick="toggleLocation('${escapeHtml(loc)}')"
                     data-location="${escapeHtml(loc)}">
                    ${escapeHtml(loc)}
                </div>
            `;
        }).join('');
    }

    function toggleLocation(loc) {
        // Can't cross off actual location if not spy
        if (!gameState.isSpy && loc === gameState.location) return;
        
        if (gameState.crossedLocations.has(loc)) {
            gameState.crossedLocations.delete(loc);
        } else {
            gameState.crossedLocations.add(loc);
        }
        
        const el = document.querySelector(`[data-location="${loc}"]`);
        if (el) el.classList.toggle('crossed');
    }

    function renderPlayers() {
        const list = document.getElementById('players-list');
        document.getElementById('players-count').textContent = gameState.players.length;
        
        if (!gameState.players || gameState.players.length === 0) {
            list.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--text-muted);">No players</div>';
            return;
        }
        
        list.innerHTML = gameState.players.map(player => {
            const isMe = player.name === playerName;
            const initial = player.name.replace(/[^a-zA-Z]/g, '')[0]?.toUpperCase() || '?';
            
            return `
                <div class="player-row ${isMe ? 'is-me' : ''} ${player.eliminated ? 'eliminated' : ''}">
                    <div class="player-row-info">
                        <div class="player-avatar-small">${initial}</div>
                        <span class="player-row-name">${escapeHtml(player.name)}</span>
                    </div>
                </div>
            `;
        }).join('');
    }

    function updateTimer() {
        const minutes = Math.floor(gameState.timeRemaining / 60);
        const seconds = gameState.timeRemaining % 60;
        const display = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        document.getElementById('timer-value').textContent = display;
        
        const timerEl = document.getElementById('timer-display');
        timerEl.classList.remove('warning', 'danger');
        
        if (gameState.timeRemaining <= 60) {
            timerEl.classList.add('danger');
        } else if (gameState.timeRemaining <= 120) {
            timerEl.classList.add('warning');
        }
    }

    // ========== ROLE VISIBILITY ==========
    function toggleRoleVisibility() {
        gameState.roleHidden = !gameState.roleHidden;
        const content = document.getElementById('role-content');
        const btn = document.getElementById('toggle-role-btn');
        
        if (gameState.roleHidden) {
            content.classList.add('role-hidden');
            btn.textContent = 'Show Role';
        } else {
            content.classList.remove('role-hidden');
            btn.textContent = 'Hide Role';
        }
    }

    // ========== VOTING ==========
    function callVote() {
        socket.emit('call-vote', { roomCode });
    }

    function openVoteOverlay(caller) {
        gameState.selectedVote = null;
        
        const options = document.getElementById('vote-options');
        options.innerHTML = gameState.players
            .filter(p => p.name !== playerName && !p.eliminated)
            .map(player => `
                <div class="vote-option" onclick="selectVote('${player.id}')" data-player-id="${player.id}">
                    <span class="vote-option-name">${escapeHtml(player.name)}</span>
                </div>
            `).join('');
        
        document.getElementById('vote-overlay').classList.add('visible');
        document.getElementById('submit-vote-btn').disabled = true;
        document.getElementById('submit-vote-btn').textContent = 'Submit Vote';
    }

    function selectVote(playerId) {
        gameState.selectedVote = playerId;
        
        document.querySelectorAll('#vote-options .vote-option').forEach(el => {
            el.classList.remove('selected');
            if (el.dataset.playerId === playerId) {
                el.classList.add('selected');
            }
        });
        
        document.getElementById('submit-vote-btn').disabled = false;
    }

    function submitVote() {
        if (!gameState.selectedVote) return;
        socket.emit('submit-vote', { roomCode, votedPlayerId: gameState.selectedVote });
        document.getElementById('submit-vote-btn').disabled = true;
        document.getElementById('submit-vote-btn').textContent = 'Voted!';
    }

    function closeVote() {
        document.getElementById('vote-overlay').classList.remove('visible');
    }

    // ========== SPY GUESS ==========
    function openSpyGuess() {
        if (!gameState.isSpy) return;
        
        gameState.selectedGuess = null;
        
        const options = document.getElementById('spy-guess-options');
        options.innerHTML = gameState.allLocations.map(loc => `
            <div class="vote-option" onclick="selectGuess('${escapeHtml(loc)}')" data-location="${escapeHtml(loc)}">
                <span class="vote-option-name">${escapeHtml(loc)}</span>
            </div>
        `).join('');
        
        document.getElementById('spy-guess-overlay').classList.add('visible');
        document.getElementById('submit-guess-btn').disabled = true;
    }

    function selectGuess(location) {
        gameState.selectedGuess = location;
        
        document.querySelectorAll('#spy-guess-options .vote-option').forEach(el => {
            el.classList.remove('selected');
            if (el.dataset.location === location) {
                el.classList.add('selected');
            }
        });
        
        document.getElementById('submit-guess-btn').disabled = false;
    }

    function submitSpyGuess() {
        if (!gameState.selectedGuess) return;
        socket.emit('spy-guess', { roomCode, location: gameState.selectedGuess });
        closeSpyGuess();
    }

    function closeSpyGuess() {
        document.getElementById('spy-guess-overlay').classList.remove('visible');
    }

    // ========== GAME OVER ==========
    function showGameOver(data) {
        const title = document.getElementById('game-over-title');
        const subtitle = document.getElementById('game-over-subtitle');
        
        if (data.spyWins) {
            title.textContent = 'Spy Wins!';
            title.classList.add('spy-wins');
            title.classList.remove('winners');
        } else {
            title.textContent = 'Players Win!';
            title.classList.add('winners');
            title.classList.remove('spy-wins');
        }
        
        subtitle.textContent = data.reason || 'Game Over';
        document.getElementById('reveal-spy').textContent = data.spyName || data.spyNames?.join(', ') || 'Unknown';
        document.getElementById('reveal-location').textContent = data.location || 'Unknown';
        
        document.getElementById('game-over-overlay').classList.add('visible');
    }

    function playAgain() {
        window.location.href = `waiting-room.html?room=${roomCode}`;
    }

    function leaveGame() {
        window.location.href = '/squad-games.html';
    }

    // ========== HELPERS ==========
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Cleanup on leave
    window.addEventListener('beforeunload', () => {
        socket.disconnect();
    });

    // Initial timer display
    updateTimer();
</script>

</body>
</html>
