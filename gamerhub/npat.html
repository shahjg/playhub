<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Name Place Animal Thing - TheGaming.co</title>
    
    <meta name="description" content="Classic word game - fill categories with words starting with the random letter!">
    <meta name="robots" content="noindex, nofollow">
    <meta name="theme-color" content="#0a0a0f">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --accent: #f59e0b;
            --accent-glow: rgba(245, 158, 11, 0.4);
            --accent-soft: rgba(245, 158, 11, 0.12);
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.08);
            --border-accent: rgba(245, 158, 11, 0.3);
            --text: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.5);
            --gold: #fbbf24;
            --green: #22c55e;
            --red: #ef4444;
            --blue: #3b82f6;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Background */
        .bg-container {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            z-index: 0;
        }

        .bg-gradient {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: 
                radial-gradient(ellipse 80% 50% at 20% 0%, var(--accent-soft) 0%, transparent 50%),
                radial-gradient(ellipse 60% 40% at 90% 100%, var(--accent-soft) 0%, transparent 50%),
                var(--bg-primary);
        }

        .glow-orb {
            position: absolute;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, var(--accent-glow) 0%, transparent 70%);
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.3;
            animation: orbFloat 25s ease-in-out infinite;
        }

        @keyframes orbFloat {
            0%, 100% { transform: translate(0, 0); }
            33% { transform: translate(60vw, 20vh); }
            66% { transform: translate(30vw, 60vh); }
        }

        /* Header */
        header {
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 100;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            background: rgba(10, 10, 15, 0.9);
            backdrop-filter: blur(18px);
            border-bottom: 1px solid var(--border);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            border-radius: 8px;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-muted);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .back-btn:hover {
            background: rgba(239, 68, 68, 0.1);
            color: var(--red);
            border-color: var(--red);
        }

        .room-badge {
            background: var(--accent-soft);
            border: 1px solid var(--border-accent);
            padding: 6px 12px;
            border-radius: 8px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1rem;
            letter-spacing: 2px;
            color: var(--accent);
        }

        .header-logo {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.4rem;
            letter-spacing: 3px;
            color: white;
            text-decoration: none;
        }

        /* Main Container */
        main {
            padding: 80px 20px 40px;
            max-width: 900px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        /* Game Phases */
        .game-phase {
            display: none;
        }

        .game-phase.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ========== LETTER REVEAL PHASE ========== */
        .letter-reveal {
            text-align: center;
            padding: 60px 20px;
        }

        .round-info {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .round-info span {
            color: var(--accent);
            font-weight: 700;
        }

        .letter-shuffle {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 12rem;
            color: var(--accent);
            text-shadow: 0 0 100px var(--accent-glow);
            line-height: 1;
            animation: letterPulse 0.5s ease-in-out infinite;
        }

        .letter-shuffle.revealed {
            animation: letterReveal 0.5s ease forwards;
        }

        @keyframes letterPulse {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.05); opacity: 1; }
        }

        @keyframes letterReveal {
            0% { transform: scale(1.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .countdown-text {
            font-size: 1.2rem;
            color: var(--text-muted);
            margin-top: 2rem;
        }

        .countdown-text span {
            color: var(--accent);
            font-weight: 700;
            font-size: 1.5rem;
        }

        /* ========== INPUT PHASE ========== */
        .input-phase {
            padding: 20px 0;
        }

        .timer-bar-container {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            border: 1px solid var(--border);
        }

        .current-letter {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 3rem;
            color: var(--accent);
            text-shadow: 0 0 30px var(--accent-glow);
            line-height: 1;
            min-width: 60px;
            text-align: center;
        }

        .timer-section {
            flex: 1;
        }

        .timer-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.3rem;
        }

        .timer-bar {
            height: 8px;
            background: var(--bg-primary);
            border-radius: 4px;
            overflow: hidden;
        }

        .timer-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--gold));
            border-radius: 4px;
            transition: width 0.1s linear;
        }

        .timer-fill.warning {
            background: linear-gradient(90deg, var(--red), #f97316);
        }

        .timer-text {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2rem;
            color: var(--text);
            min-width: 60px;
            text-align: right;
        }

        .timer-text.warning {
            color: var(--red);
            animation: timerPulse 0.5s ease-in-out infinite;
        }

        @keyframes timerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Category Inputs */
        .categories-grid {
            display: grid;
            gap: 12px;
        }

        .category-input-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.2s ease;
        }

        .category-input-card:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 20px var(--accent-glow);
        }

        .category-input-card.filled {
            border-color: var(--green);
            background: rgba(34, 197, 94, 0.05);
        }

        .category-icon {
            width: 40px;
            height: 40px;
            background: var(--accent-soft);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .category-content {
            flex: 1;
        }

        .category-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.25rem;
        }

        .category-input {
            width: 100%;
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 1.1rem;
            font-family: inherit;
            outline: none;
        }

        .category-input::placeholder {
            color: rgba(255, 255, 255, 0.25);
        }

        .submit-btn {
            width: 100%;
            padding: 1rem;
            margin-top: 1rem;
            background: var(--accent);
            border: none;
            border-radius: 12px;
            color: white;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.3rem;
            letter-spacing: 3px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 20px var(--accent-glow);
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            filter: brightness(1.1);
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .submit-btn.submitted {
            background: var(--green);
            box-shadow: 0 4px 20px rgba(34, 197, 94, 0.4);
        }

        /* Waiting indicator */
        .waiting-others {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        .waiting-others .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ========== RESULTS PHASE ========== */
        .results-phase {
            padding: 20px 0;
        }

        .results-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .results-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.5rem;
            letter-spacing: 4px;
            color: var(--text);
            margin-bottom: 0.5rem;
        }

        .results-letter {
            display: inline-block;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 4rem;
            color: var(--accent);
            text-shadow: 0 0 40px var(--accent-glow);
            margin-bottom: 0.5rem;
        }

        .round-score {
            font-size: 1.2rem;
            color: var(--text-muted);
        }

        .round-score span {
            color: var(--accent);
            font-weight: 700;
            font-size: 1.5rem;
        }

        /* Category Results */
        .category-results {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .category-result-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        .category-result-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
        }

        .category-result-name {
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.85rem;
        }

        .category-result-points {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.2rem;
            color: var(--accent);
        }

        .category-result-points.zero {
            color: var(--text-muted);
        }

        .category-result-points.unique {
            color: var(--gold);
        }

        .category-answers {
            padding: 0.75rem 1rem;
        }

        .answer-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.4rem 0;
            border-bottom: 1px solid var(--border);
        }

        .answer-row:last-child {
            border-bottom: none;
        }

        .answer-player {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .answer-player.is-me {
            color: var(--accent);
            font-weight: 600;
        }

        .answer-text {
            font-weight: 500;
        }

        .answer-text.empty {
            color: var(--text-muted);
            font-style: italic;
        }

        .answer-text.unique {
            color: var(--gold);
        }

        .answer-text.shared {
            color: var(--green);
        }

        .answer-badge {
            font-size: 0.65rem;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .answer-badge.unique {
            background: var(--gold);
            color: var(--bg-primary);
        }

        .answer-badge.shared {
            background: var(--green);
            color: white;
        }

        /* Leaderboard */
        .leaderboard-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .leaderboard-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.2rem;
            letter-spacing: 2px;
            margin-bottom: 1rem;
            text-align: center;
        }

        .leaderboard-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            background: var(--bg-card);
            border-radius: 10px;
            border: 1px solid transparent;
        }

        .leaderboard-item.is-me {
            border-color: var(--accent);
            background: var(--accent-soft);
        }

        .leaderboard-item.first {
            background: rgba(251, 191, 36, 0.1);
            border-color: var(--gold);
        }

        .leaderboard-rank {
            width: 30px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.2rem;
            color: var(--text-muted);
        }

        .leaderboard-item.first .leaderboard-rank {
            color: var(--gold);
        }

        .leaderboard-name {
            flex: 1;
            font-weight: 600;
        }

        .leaderboard-round-pts {
            font-size: 0.8rem;
            color: var(--green);
            margin-right: 1rem;
        }

        .leaderboard-total {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.3rem;
            color: var(--accent);
        }

        /* Action Buttons */
        .results-actions {
            display: flex;
            gap: 1rem;
        }

        .results-actions .btn {
            flex: 1;
            padding: 1rem;
            border-radius: 10px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.1rem;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            box-shadow: 0 4px 20px var(--accent-glow);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            filter: brightness(1.1);
        }

        .btn-secondary {
            background: var(--bg-primary);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .host-only {
            display: none;
        }

        .is-host .host-only {
            display: flex;
        }

        .non-host-message {
            text-align: center;
            padding: 1rem;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .is-host .non-host-message {
            display: none;
        }

        /* Letters Progress */
        .letters-progress {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
            margin-bottom: 1.5rem;
        }

        .letter-dot {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .letter-dot.used {
            background: var(--accent-soft);
            border-color: var(--accent);
            color: var(--accent);
        }

        .letter-dot.current {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
            box-shadow: 0 0 15px var(--accent-glow);
        }

        /* ========== GAME OVER ========== */
        .game-over-phase {
            text-align: center;
            padding: 40px 20px;
        }

        .winner-crown {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .winner-name {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 3rem;
            letter-spacing: 4px;
            color: var(--gold);
            text-shadow: 0 0 40px rgba(251, 191, 36, 0.5);
            margin-bottom: 0.5rem;
        }

        .winner-score {
            font-size: 1.5rem;
            color: var(--text-muted);
            margin-bottom: 2rem;
        }

        .winner-score span {
            color: var(--accent);
            font-weight: 700;
        }

        .final-leaderboard {
            max-width: 400px;
            margin: 0 auto 2rem;
        }

        /* Responsive */
        @media (max-width: 600px) {
            header { padding: 0 12px; height: 56px; }
            .header-logo { font-size: 1.2rem; }
            .room-badge { padding: 4px 8px; font-size: 0.85rem; }
            
            main { padding: 70px 16px 30px; }
            
            .letter-shuffle { font-size: 8rem; }
            .current-letter { font-size: 2.5rem; min-width: 50px; }
            .timer-text { font-size: 1.5rem; }
            
            .category-input-card { padding: 0.75rem; }
            .category-icon { width: 36px; height: 36px; font-size: 1rem; }
            .category-input { font-size: 1rem; }
            
            .results-letter { font-size: 3rem; }
            .results-title { font-size: 2rem; }
            
            .letters-progress { gap: 4px; }
            .letter-dot { width: 24px; height: 24px; font-size: 0.75rem; }
            
            .results-actions { flex-direction: column; }
        }
    </style>
</head>
<body>

<div class="bg-container">
    <div class="bg-gradient"></div>
    <div class="glow-orb"></div>
</div>

<header>
    <div class="header-left">
        <button class="back-btn" onclick="leaveGame()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
            Leave
        </button>
        <div class="room-badge" id="room-code-display">------</div>
    </div>
    <a href="/" class="header-logo">THEGAMING.CO</a>
</header>

<main>
    <!-- PHASE: Letter Reveal -->
    <div class="game-phase active" id="phase-letter-reveal">
        <div class="letter-reveal">
            <div class="round-info">Round <span id="round-number">1</span> of <span id="total-rounds">26</span></div>
            <div class="letters-progress" id="letters-progress"></div>
            <div class="letter-shuffle" id="shuffle-letter">?</div>
            <div class="countdown-text">Starting in <span id="reveal-countdown">3</span></div>
        </div>
    </div>

    <!-- PHASE: Input -->
    <div class="game-phase" id="phase-input">
        <div class="input-phase">
            <div class="timer-bar-container">
                <div class="current-letter" id="current-letter">A</div>
                <div class="timer-section">
                    <div class="timer-label">Time Remaining</div>
                    <div class="timer-bar">
                        <div class="timer-fill" id="timer-fill"></div>
                    </div>
                </div>
                <div class="timer-text" id="timer-text">60</div>
            </div>

            <div class="categories-grid" id="categories-grid"></div>

            <button class="submit-btn" id="submit-btn" onclick="submitAnswers()">
                SUBMIT ANSWERS
            </button>

            <div class="waiting-others" id="waiting-others" style="display: none;">
                <div class="spinner"></div>
                <div>Waiting for other players...</div>
                <div id="submitted-count">0/0 submitted</div>
            </div>
        </div>
    </div>

    <!-- PHASE: Results -->
    <div class="game-phase" id="phase-results">
        <div class="results-phase">
            <div class="results-header">
                <div class="results-title">ROUND RESULTS</div>
                <div class="results-letter" id="results-letter">A</div>
                <div class="round-score">Your score: <span id="your-round-score">0</span> pts</div>
            </div>

            <div class="category-results" id="category-results"></div>

            <div class="leaderboard-section">
                <div class="leaderboard-title">LEADERBOARD</div>
                <div class="leaderboard-list" id="leaderboard-list"></div>
            </div>

            <div class="results-actions host-only">
                <button class="btn btn-secondary" onclick="endGame()">End Game</button>
                <button class="btn btn-primary" onclick="nextRound()">Next Round</button>
            </div>
            <div class="non-host-message">Waiting for host...</div>
        </div>
    </div>

    <!-- PHASE: Game Over -->
    <div class="game-phase" id="phase-gameover">
        <div class="game-over-phase">
            <div class="winner-crown">üëë</div>
            <div class="winner-name" id="winner-name">WINNER</div>
            <div class="winner-score"><span id="winner-score">0</span> points</div>

            <div class="final-leaderboard">
                <div class="leaderboard-section">
                    <div class="leaderboard-title">FINAL STANDINGS</div>
                    <div class="leaderboard-list" id="final-leaderboard"></div>
                </div>
            </div>

            <button class="btn btn-primary" onclick="returnToLobby()" style="max-width: 300px; margin: 0 auto;">
                RETURN TO LOBBY
            </button>
        </div>
    </div>
</main>

<script>
const BACKEND_URL = 'https://web-production-519c7.up.railway.app';
const socket = io(BACKEND_URL, { transports: ['websocket', 'polling'] });

const CATEGORY_ICONS = {
    name: 'üë§',
    place: 'üìç',
    animal: 'üêæ',
    thing: 'üì¶',
    food: 'üçï',
    movie: 'üé¨',
    show: 'üì∫',
    song: 'üéµ',
    artist: 'üé®',
    actor: 'üé≠'
};

const CATEGORY_LABELS = {
    name: 'Name',
    place: 'Place',
    animal: 'Animal',
    thing: 'Thing',
    food: 'Food',
    movie: 'Movie',
    show: 'TV Show',
    song: 'Song',
    artist: 'Artist',
    actor: 'Actor'
};

const ALPHABET = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');

// Game State
const urlParams = new URLSearchParams(window.location.search);
const roomCode = urlParams.get('room');
const playerName = localStorage.getItem('tempPlayerName');

let isHost = false;
let myPlayerId = null;
let gameState = {
    currentLetter: null,
    usedLetters: [],
    categories: ['name', 'place', 'animal', 'thing'],
    timePerRound: 60,
    round: 1,
    players: {},
    myAnswers: {},
    submitted: false
};

let timerInterval = null;
let timeLeft = 60;

// Initialize
document.getElementById('room-code-display').textContent = roomCode || '------';

if (!roomCode || !playerName) {
    window.location.href = '/lobby.html?game=npat';
}

// Socket Events
socket.on('connect', () => {
    console.log('Connected to server');
    socket.emit('rejoin-room', { roomCode, playerName });
});

socket.on('room-joined', (data) => {
    console.log('Joined room:', data);
    const me = data.room.players.find(p => p.name === playerName);
    if (me) {
        myPlayerId = me.id;
        isHost = me.isHost;
        if (isHost) document.body.classList.add('is-host');
    }
});

socket.on('npat-init', (data) => {
    console.log('NPAT Init:', data);
    gameState.categories = data.categories || ['name', 'place', 'animal', 'thing'];
    gameState.timePerRound = parseInt(data.timePerRound) || 60;
    gameState.usedLetters = data.usedLetters || [];
    gameState.round = (data.usedLetters?.length || 0) + 1;
    
    // Initialize players
    data.players.forEach(p => {
        gameState.players[p.id] = { name: p.name, score: 0 };
    });
    
    renderLettersProgress();
    renderCategoryInputs();
});

socket.on('npat-new-round', (data) => {
    console.log('New round:', data);
    gameState.currentLetter = data.letter;
    gameState.round = data.round;
    gameState.submitted = false;
    gameState.myAnswers = {};
    
    // Reset inputs
    document.querySelectorAll('.category-input').forEach(input => {
        input.value = '';
        input.disabled = false;
        input.closest('.category-input-card').classList.remove('filled');
    });
    
    document.getElementById('submit-btn').disabled = false;
    document.getElementById('submit-btn').classList.remove('submitted');
    document.getElementById('submit-btn').textContent = 'SUBMIT ANSWERS';
    document.getElementById('waiting-others').style.display = 'none';
    
    showLetterReveal(data.letter);
});

socket.on('npat-start-input', () => {
    showPhase('phase-input');
    startTimer();
});

socket.on('npat-player-submitted', (data) => {
    document.getElementById('submitted-count').textContent = `${data.submitted}/${data.total} submitted`;
});

socket.on('npat-round-results', (data) => {
    console.log('Round results:', data);
    showResults(data);
});

socket.on('npat-game-over', (data) => {
    console.log('Game over:', data);
    showGameOver(data);
});

socket.on('npat-host-update', (data) => {
    isHost = data.isHost;
    if (isHost) document.body.classList.add('is-host');
    else document.body.classList.remove('is-host');
});

socket.on('error', (data) => {
    console.error('Error:', data.message);
    alert(data.message);
});

// Functions
function showPhase(phaseId) {
    document.querySelectorAll('.game-phase').forEach(p => p.classList.remove('active'));
    document.getElementById(phaseId).classList.add('active');
}

function renderLettersProgress() {
    const container = document.getElementById('letters-progress');
    container.innerHTML = ALPHABET.map(letter => {
        let cls = 'letter-dot';
        if (gameState.usedLetters.includes(letter)) cls += ' used';
        if (letter === gameState.currentLetter) cls += ' current';
        return `<div class="${cls}">${letter}</div>`;
    }).join('');
    
    document.getElementById('total-rounds').textContent = 26 - gameState.usedLetters.length;
}

function renderCategoryInputs() {
    const container = document.getElementById('categories-grid');
    container.innerHTML = gameState.categories.map(cat => `
        <div class="category-input-card" data-category="${cat}">
            <div class="category-icon">${CATEGORY_ICONS[cat] || 'üìù'}</div>
            <div class="category-content">
                <div class="category-label">${CATEGORY_LABELS[cat] || cat}</div>
                <input type="text" 
                       class="category-input" 
                       data-category="${cat}"
                       placeholder="Type a ${CATEGORY_LABELS[cat]?.toLowerCase() || cat}..."
                       autocomplete="off"
                       oninput="handleInput(this)">
            </div>
        </div>
    `).join('');
}

function handleInput(input) {
    const card = input.closest('.category-input-card');
    if (input.value.trim()) {
        card.classList.add('filled');
    } else {
        card.classList.remove('filled');
    }
}

function showLetterReveal(letter) {
    showPhase('phase-letter-reveal');
    
    document.getElementById('round-number').textContent = gameState.round;
    document.getElementById('current-letter').textContent = letter;
    
    const shuffleEl = document.getElementById('shuffle-letter');
    const countdownEl = document.getElementById('reveal-countdown');
    
    shuffleEl.classList.remove('revealed');
    
    // Shuffle animation
    let shuffleCount = 0;
    const shuffleInterval = setInterval(() => {
        shuffleEl.textContent = ALPHABET[Math.floor(Math.random() * 26)];
        shuffleCount++;
    }, 80);
    
    // Countdown
    let countdown = 3;
    countdownEl.textContent = countdown;
    
    const countdownInterval = setInterval(() => {
        countdown--;
        if (countdown > 0) {
            countdownEl.textContent = countdown;
        } else {
            clearInterval(countdownInterval);
            clearInterval(shuffleInterval);
            shuffleEl.textContent = letter;
            shuffleEl.classList.add('revealed');
            countdownEl.textContent = 'GO!';
            
            // Update progress
            if (!gameState.usedLetters.includes(letter)) {
                gameState.usedLetters.push(letter);
            }
            renderLettersProgress();
        }
    }, 1000);
}

function startTimer() {
    timeLeft = gameState.timePerRound;
    const timerFill = document.getElementById('timer-fill');
    const timerText = document.getElementById('timer-text');
    
    timerFill.style.width = '100%';
    timerFill.classList.remove('warning');
    timerText.classList.remove('warning');
    timerText.textContent = timeLeft;
    
    if (timerInterval) clearInterval(timerInterval);
    
    timerInterval = setInterval(() => {
        timeLeft--;
        const percent = (timeLeft / gameState.timePerRound) * 100;
        timerFill.style.width = percent + '%';
        timerText.textContent = timeLeft;
        
        if (timeLeft <= 10) {
            timerFill.classList.add('warning');
            timerText.classList.add('warning');
        }
        
        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            if (!gameState.submitted) {
                submitAnswers();
            }
        }
    }, 1000);
}

function submitAnswers() {
    if (gameState.submitted) return;
    
    gameState.submitted = true;
    clearInterval(timerInterval);
    
    // Collect answers
    const answers = {};
    document.querySelectorAll('.category-input').forEach(input => {
        const cat = input.dataset.category;
        const val = input.value.trim().toLowerCase();
        answers[cat] = val;
        input.disabled = true;
    });
    
    gameState.myAnswers = answers;
    
    // Update UI
    document.getElementById('submit-btn').disabled = true;
    document.getElementById('submit-btn').classList.add('submitted');
    document.getElementById('submit-btn').textContent = 'SUBMITTED ‚úì';
    document.getElementById('waiting-others').style.display = 'block';
    
    // Send to server
    socket.emit('npat-submit', {
        roomCode,
        answers
    });
}

function showResults(data) {
    showPhase('phase-results');
    
    document.getElementById('results-letter').textContent = gameState.currentLetter;
    
    // Calculate my round score
    let myRoundScore = 0;
    const myResults = data.results[myPlayerId] || {};
    
    gameState.categories.forEach(cat => {
        const catResult = myResults[cat];
        if (catResult) {
            myRoundScore += catResult.points;
        }
    });
    
    document.getElementById('your-round-score').textContent = myRoundScore;
    
    // Render category results
    const resultsContainer = document.getElementById('category-results');
    resultsContainer.innerHTML = gameState.categories.map(cat => {
        const myResult = myResults[cat] || { answer: '', points: 0, unique: false };
        
        // Collect all answers for this category
        const allAnswers = [];
        Object.entries(data.results).forEach(([playerId, playerResults]) => {
            const playerName = gameState.players[playerId]?.name || 'Unknown';
            const result = playerResults[cat] || { answer: '', points: 0, unique: false };
            allAnswers.push({
                playerId,
                name: playerName,
                answer: result.answer,
                points: result.points,
                unique: result.unique,
                isMe: playerId === myPlayerId
            });
        });
        
        return `
            <div class="category-result-card">
                <div class="category-result-header">
                    <span class="category-result-name">${CATEGORY_ICONS[cat]} ${CATEGORY_LABELS[cat]}</span>
                    <span class="category-result-points ${myResult.points === 0 ? 'zero' : ''} ${myResult.unique ? 'unique' : ''}">${myResult.points > 0 ? '+' : ''}${myResult.points}</span>
                </div>
                <div class="category-answers">
                    ${allAnswers.map(a => `
                        <div class="answer-row">
                            <span class="answer-player ${a.isMe ? 'is-me' : ''}">${a.name}</span>
                            <span class="answer-text ${!a.answer ? 'empty' : ''} ${a.unique ? 'unique' : ''} ${a.points === 5 ? 'shared' : ''}">${a.answer || '(empty)'}</span>
                            ${a.unique ? '<span class="answer-badge unique">+10</span>' : ''}
                            ${a.points === 5 ? '<span class="answer-badge shared">+5</span>' : ''}
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }).join('');
    
    // Update scores
    Object.entries(data.scores).forEach(([playerId, score]) => {
        if (gameState.players[playerId]) {
            gameState.players[playerId].score = score;
        }
    });
    
    // Render leaderboard
    renderLeaderboard();
}

function renderLeaderboard() {
    const sorted = Object.entries(gameState.players)
        .sort((a, b) => b[1].score - a[1].score);
    
    const container = document.getElementById('leaderboard-list');
    container.innerHTML = sorted.map(([playerId, player], idx) => `
        <div class="leaderboard-item ${playerId === myPlayerId ? 'is-me' : ''} ${idx === 0 ? 'first' : ''}">
            <span class="leaderboard-rank">${idx + 1}</span>
            <span class="leaderboard-name">${player.name}</span>
            <span class="leaderboard-total">${player.score}</span>
        </div>
    `).join('');
}

function nextRound() {
    if (!isHost) return;
    socket.emit('npat-next-round', { roomCode });
}

function endGame() {
    if (!isHost) return;
    socket.emit('npat-end-game', { roomCode });
}

function showGameOver(data) {
    showPhase('phase-gameover');
    
    // Update final scores
    Object.entries(data.scores).forEach(([playerId, score]) => {
        if (gameState.players[playerId]) {
            gameState.players[playerId].score = score;
        }
    });
    
    const sorted = Object.entries(gameState.players)
        .sort((a, b) => b[1].score - a[1].score);
    
    if (sorted.length > 0) {
        document.getElementById('winner-name').textContent = sorted[0][1].name.toUpperCase();
        document.getElementById('winner-score').textContent = sorted[0][1].score;
    }
    
    // Final leaderboard
    const container = document.getElementById('final-leaderboard');
    container.innerHTML = sorted.map(([playerId, player], idx) => `
        <div class="leaderboard-item ${playerId === myPlayerId ? 'is-me' : ''} ${idx === 0 ? 'first' : ''}">
            <span class="leaderboard-rank">${idx + 1}</span>
            <span class="leaderboard-name">${player.name}</span>
            <span class="leaderboard-total">${player.score}</span>
        </div>
    `).join('');
}

function leaveGame() {
    if (confirm('Leave the game?')) {
        socket.disconnect();
        window.location.href = '/squad-games.html';
    }
}

function returnToLobby() {
    window.location.href = '/squad-games.html';
}

// Handle page unload
window.addEventListener('beforeunload', () => {
    socket.disconnect();
});
</script>

</body>
</html>
